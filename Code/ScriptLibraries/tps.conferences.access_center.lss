'++LotusScript Development Environment:2:5:(Options):0:74
Option Public
Option Declare

Use "fbyte"
Use "tps.common"


'++LotusScript Development Environment:2:5:(Forward):0:1
Declare Public Class TPS_ConfAccessCenterService As FBase_Abstract_Service
Declare Public Class TPS_ConfAccessCenter_Taskfirst As FBase_Abstract_Object_Doc

'++LotusScript Development Environment:2:5:(Declarations):0:10
Private Const DATABASE_KEY = "tps.workflow.conferences.access_center"

Const DOMAIN_CONF_ACCESSCENTER_TASK_FIRST = "tps.conferences.access_center.task_first"
Const DOMAIN_CONF_ACCESSCENTER_TASK_SECOND = "tps.conferences.access_center.task_second"
'======================================================================================================================================
'	CLASS TPS_ConfLinksAccessService
'======================================================================================================================================
Public Class TPS_ConfAccessCenterService As FBase_Abstract_Service
	Private m_db As NotesDatabase
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Private Function getId( in_key As Variant ) As String
		On Error GoTo error_point
		Call Me.log.enter( TypeName( Me ) & "." & GetThreadInfo(1))
		
		Dim key As String
		If ( LCase( TypeName( in_key )) = "objectlink" ) Then
			key = in_key.id 
		ElseIf IsScalar( in_key ) Then 
			key = in_key
		Else
			Error 1001, "The type of data of parameter 'in_key' is '" & TypeName( in_key ) & "'. It is not supported"
		End If
		
		getId = key
		
		Call Me.log.trace( "result: " & getId )
		Call Me.log.exit( TypeName( Me ) & "." & GetThreadInfo(1))
		Exit Function
		
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Function
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	'	PUBLIC:
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Sub New( in_ps As Variant )
	End Sub
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get db As NotesDatabase
		On Error GoTo error_point
		Call Me.log.enter( TypeName( Me ) & "." & GetThreadInfo(1))
		
		If ( m_db Is Nothing )Then
			Set m_db = Me.sm.base.databases.get( DATABASE_KEY )
		End If
		Set db = m_db
		
		Call Me.log.traceObject( "result", db )		
		Call Me.log.exit( TypeName( Me ) & "." & GetThreadInfo(1))
		Exit Property
		
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Function getObject( in_link As Variant ) As Variant
		On Error GoTo error_point
		Call Me.log.enter( TypeName( Me ) & "." & GetThreadInfo(1))
		Call Me.log.parameter( "in_link", in_link )
		
		Select Case in_link.domain
			Case DOMAIN_CONF_ACCESSCENTER_TASK_FIRST:
				Set getObject = Me.getTaskFirst( in_link )
			Case Else
				Error 1001, "The data of type '" & in_link.domain & "' of parameter 'in_link.domain' is not supported"
		End Select
		
		Call Me.log.traceObject( "result", getObject )
		Call Me.log.exit( TypeName( Me ) & "." & GetThreadInfo(1))
		Exit Function
		
error_point:
		On Error GoTo 0
	Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Function
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Function getDocObject( in_doc As NotesDocument ) As Variant
		On Error GoTo error_point
		Call Me.log.enter( TypeName( Me ) & "." & GetThreadInfo(1))
		Call Me.log.parameter( "in_doc", in_doc )
		
		Select Case LCase( in_doc.form(0))
			Case LCase("tps.conferences.link_access.task_first"):
				Set getDocObject = New TPS_ConfAccessCenter_Taskfirst( in_doc, Me.Me_variant )
			Case Else:
				Error 1001, "Форма '" & in_doc.form(0) & "' не поддерживается"
		End Select
		
		Call Me.log.traceObject( "result", getDocObject )
		Call Me.log.exit( TypeName( Me ) & "." & GetThreadInfo(1))
		Exit Function
		
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Function
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
	Function createNewTaskfirst() As Variant
		On Error GoTo error_point
		Call Me.log.enter( "<" & TypeName( Me ) & "." & GetThreadInfo(1) & ">" )
				
		Dim s As New NotesSession, cdb As NotesDatabase
		Set cdb = s.Currentdatabase
		Dim docNew As NotesDocument 
		
		Set docNew = Me.db.Createdocument()
		Dim task As New TPS_ConfAccessCenter_Taskfirst( docNew, Me.Me_variant )
		
		Call task.nd.Replaceitemvalue( "Form", "tps.conferences.access_center.task_first" )
		Call task.nd.Replaceitemvalue( "domain", DOMAIN_CONF_ACCESSCENTER_TASK_FIRST )
		Call task.nd.Replaceitemvalue( "id", task.nd.Universalid )
		Call task.nd.Replaceitemvalue( "CustomID", task.nd.Universalid )
		
		Dim ItemName As String
		ItemName = "DWF$Readers"
		ReDim v(2) As String
		v(0) = "[Admin]"
		v(1) = "[SuperVisor]"
		v(2) = s.Username
		docNew.ReplaceItemValue( ItemName, v ).IsReaders = True
		
		docNew.Replaceitemvalue( "DWF$Authors", cdb.Server ).Isauthors = True
		docNew.Replaceitemvalue( "DWF$Server", cdb.Server ).Isreaders = True
		'-------------------------------------------				
		Set createNewTaskfirst = task
		'-------------------------------------------
		
		Call Me.log.exit( "</" & TypeName( Me ) & "." & GetThreadInfo(1) & ">" )
		Exit Function
		
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Function
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Function getTaskFirst( in_key As Variant ) As Variant
		On Error GoTo error_point
		Call Me.log.enter( TypeName( Me ) & "." & GetThreadInfo(1))
		
		Dim key As String, doc As NotesDocument
		key = Me.getId( in_key )
		On Error 4091 Resume Next 'bad unid
		Set doc = Me.db.getdocumentbyunid( key )
		If ( doc Is Nothing ) Then
			Error 1001, "In database '" & Me.db.Title & "' ( path: " & Me.db.FilePath & " ) not found document  by key '" & in_key & "'"
		Else
			Set Me.getTaskFirst = Me.getDocObject( doc )
		End If
		
		Call Me.log.traceObject( "result", getTaskFirst )
		Call Me.log.exit( TypeName( Me ) & "." & GetThreadInfo(1))
		Exit Function
		
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$ 
	End Function
	
	
	
	
	
End Class
'======================================================================================================================================
'	CLASS TPS_ConfAccessCenter_Taskfirst
'======================================================================================================================================
Public Class TPS_ConfAccessCenter_Taskfirst As FBase_Abstract_Object_Doc
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	'	PUBLIC:
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Sub New( in_doc As NotesDocument, in_ps As Variant )
	End Sub
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get title As String
		On Error GoTo error_point
		title = m_doc.question(0)		
		Exit Property
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get id As String
		On Error GoTo error_point
		id = m_doc.UniversalID
		Exit Property 
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get domain As String
		On Error GoTo error_point
		domain = DOMAIN_CONF_ACCESSCENTER_TASK_FIRST
		Exit Property 
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
End Class