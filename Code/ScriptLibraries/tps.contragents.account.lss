'++LotusScript Development Environment:2:5:(Options):0:74
Option Public
Option Declare

Use "fbyte"
Use "DWFAppLib"


'++LotusScript Development Environment:2:5:(Forward):0:1
Declare Public Class TPS_Contragents_AccountService As FBase_Abstract_Service
Declare Public Class TPS_Contragents_Account As FBase_Abstract_Object_Doc
Declare Class TPS_Contragents_Account_1CInfo As FBase_Abstract_Object_Doc

'++LotusScript Development Environment:2:5:(Declarations):0:10
'Private Const DATABASE_KEY = "tps.contragents"
Private Const DATABASE_KEY = "tps.catalogs.correspondents"

Const DOMAIN_TPS_CONTRAGENTS_ACCOUNT = "tps.contragents.contragent.account"

'======================================================================================================================================
'	CLASS TPS_ContragentsService
'======================================================================================================================================
Public Class TPS_Contragents_AccountService As FBase_Abstract_Service
	Private m_db As NotesDatabase
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Private Function getId( in_key As Variant ) As String
		On Error Goto error_point
		Call Me.log.enter( Typename( Me ) & "." & Getthreadinfo(1))
		
		Dim key As String
		If ( Lcase( Typename( in_key )) = "objectlink" ) Then
			key = in_key.id 
		Elseif Isscalar( in_key ) Then 
			key = in_key
		Else
			Error 1001, "The type of data of parameter 'in_key' is '" & Typename( in_key ) & "'. It is not supported"
		End If
		
		getId = key
		
		Call Me.log.trace( "result: " & getId )
		Call Me.log.exit( Typename( Me ) & "." & Getthreadinfo(1))
		Exit Function
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Function
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	'	PUBLIC:
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Sub New( in_ps As Variant )
	End Sub
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get db As NotesDatabase
		On Error Goto error_point
		Call Me.log.enter( Typename( Me ) & "." & Getthreadinfo(1))
		
		If ( m_db Is Nothing )Then
			Set m_db = Me.sm.base.databases.get( DATABASE_KEY )
		End If
		Set db = m_db
		
		Call Me.log.traceObject( "result", db )		
		Call Me.log.exit( Typename( Me ) & "." & Getthreadinfo(1))
		Exit Property
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Function getObject( in_link As Variant ) As Variant
		On Error Goto error_point
		Call Me.log.enter( Typename( Me ) & "." & Getthreadinfo(1))
		Call Me.log.parameter( "in_link", in_link )
		
		Select Case in_link.domain
		Case DOMAIN_TPS_CONTRAGENTS_ACCOUNT:
			Set getObject = getAccount( in_link )
		Case Else
			Error 1001, "The data of type '" & in_link.domain & "' of parameter 'in_link.domain' is not supported"
		End Select
		
		Call Me.log.traceObject( "result", getObject )
		Call Me.log.exit( Typename( Me ) & "." & Getthreadinfo(1))
		Exit Function
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Function
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Function getDocObject( in_doc As NotesDocument ) As Variant
		On Error Goto error_point
		Call Me.log.enter( Typename( Me ) & "." & Getthreadinfo(1))
		Call Me.log.parameter( "in_doc", in_doc )
		
		Select Case Lcase( in_doc.form(0))
		Case "tps.contragent.account":
			Set getDocObject = New TPS_Contragents_Account( in_doc, Me.Me_variant )
		Case Else:
			Error 1001, "Форма '" & in_doc.form(0) & "' не поддерживается"
		End Select
		
		'Call Me.log.traceObject( "result", getDocObject )
		Call Me.log.exit( Typename( Me ) & "." & Getthreadinfo(1))
		Exit Function
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Function
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Function getAccount( in_key As Variant ) As Variant
		On Error Goto error_point
		Call Me.log.enter( Typename( Me ) & "." & Getthreadinfo(1))
		Call Me.log.parameter( "in_key", in_key )
		
		Dim id As String, doc As NotesDocument
		id = Me.getId( in_key )
		Set doc = Me.db.Getdocumentbyunid( id )
		Set getAccount = Me.getDocObject( doc )
		
		Call Me.log.traceObject( "result", getAccount )
		Call Me.log.exit( Typename( Me ) & "." & Getthreadinfo(1))
		Exit Function
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$ 
	End Function
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
	Function dialogSelectAccounts( in_contragent_id As String, in_isMult As Boolean ) As MixCollection
		On Error Goto error_point
		Call Me.log.enter( "<" & Typename( Me ) & "." & Getthreadinfo(1) & ">" )
		Call Me.log.parameter( "in_isMult", in_isMult )
		
		Dim mxResult As New MixCollection
		Set dialogSelectAccounts = mxResult
		
		Dim vw As NotesView
		Set vw = Me.db.getView( "tps.contragent.account.byContragent_id" )
		If ( vw Is Nothing ) Then
			Error 1001, "View 'tps.contragent.account.byContragent_id' is not exist"
		End If		
		
		Dim ws As New NotesUIWorkspace, dc As NotesDocumentCollection
		Set dc = ws.PickListCollection( 3, in_isMult, Me.db.Server, Me.db.FilePath, vw.Name, "Список расчетных счетов", "Выберите документ(ы) и нажмите  OK", in_contragent_id )
		If ( dc.Count > 0 ) Then
			Dim doc As NotesDocument
			Set doc = dc.GetFirstDocument
			Do While Not ( doc Is Nothing )
				Dim c As Variant
				Set c = Me.getDocObject(doc)
				Call mxResult.Append( c )
				Set doc = dc.GetNextDocument( doc )
			Loop
		End If
		
		Call Me.log.exit( "</" & Typename( Me ) & "." & Getthreadinfo(1) & ">" )
		Exit Function
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Function
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Function dialogSelectAccountsByTypeValuta( in_contragent_id As String, in_owner_type As String, in_valuta As String, in_isMult As Boolean ) As Mixcollection
		On Error GoTo error_point
		Call Me.log.enter( "<" & TypeName( Me ) & "." & GetThreadInfo(1) & ">" )

		Dim mxResult As New MixCollection
		Set dialogSelectAccountsByTypeValuta = mxResult
		
		Dim vw As NotesView
		Set vw = Me.db.getView( "ui.tps.contragent.account.byContragent_id~type~valuta" )
		If ( vw Is Nothing ) Then
			Error 1001, "View 'ui.tps.contragent.account.byContragent_id~type~valuta' is not exist"
		End If		
		
		Dim ws As New NotesUIWorkspace, dc As NotesDocumentCollection, key As String
		key  = in_contragent_id & "~" & in_owner_type & "~" & in_valuta
		Set dc = ws.PickListCollection( 3, in_isMult, Me.db.Server, Me.db.FilePath, vw.Name, "Список расчетных счетов", "Выберите документ(ы) и нажмите  OK", key )
		If ( dc.Count > 0 ) Then
			Dim doc As NotesDocument
			Set doc = dc.GetFirstDocument
			Do While Not ( doc Is Nothing )
				Dim c As Variant
				Set c = Me.getDocObject(doc)
				Call mxResult.Append( c )
				Set doc = dc.GetNextDocument( doc )
			Loop
		End If
	
		Call Me.log.exit( "</" & TypeName( Me ) & "." & GetThreadInfo(1) & ">" )
		Exit Function
		
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Function
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
	Function createNew( in_initObj As Variant ) As TPS_Contragents_Account
		On Error Goto error_point
		Call Me.log.enter( "<" & Typename( Me ) & "." & Getthreadinfo(1) & ">" )
		
		Dim dbPC As NotesDatabase
		Set dbPC = Me.sm.base.databases.get( "tps.core.process_center" )
		If ( dbPC Is Nothing ) Then
			Set dbPC = Me.sm.base.databases.get( "tps.systems.process_center" )
			If ( dbPC Is Nothing ) Then
				Error 1001, "Не удалось получить БД 'tps.core.process_center'"
			End If	
		End If
		
		Dim session As New NotesSession
		Dim docMail As NotesDocument
		
		Set docMail = dbPC.CreateDocument
		docMail.Form 		= "Task"
		docMail.Action 		= "InitProcess"
		docMail.InitServer 	= Me.db.Server
		docMail.AppPath 	= Me.db.FilePath
		docMail.UserName 	= session.UserName
		docMail.ProcessID 	= in_initObj.processID
		docMail.InitPosID 	= in_initObj.initPositionID 
		docMail.InitObjID 	= in_initObj.initObjID
		
		Call docMail.Save(True, True)
		If ( DWFAAskForAction( docMail ) <> 1 ) Then
			
		Elseif ( docMail.Error(0) <> "" ) Then
			Error 1001, docMail.Error(0)
		Else
			Dim docMain As NotesDocument
			Set docMain = Me.db.GetDocumentByUNID( docMail.docMainUNID(0))
			If ( docMain Is Nothing ) Then
				Error 1001, {Ошибка при инициации процесса: docMain Is Nothing}
			Else
				Call docMain.ReplaceItemvalue("Form", "tps.contragent.account" )
				Call docMain.ReplaceItemvalue("domain", DOMAIN_TPS_CONTRAGENTS_ACCOUNT )
				Call docMain.ReplaceItemvalue("id", 	docMain.UniversalID )
				
				Set createNew = Me.getDocObject( docMain )
			End If
		End If
		
		Call Me.log.exit( "</" & Typename( Me ) & "." & Getthreadinfo(1) & ">" )
		Exit Function
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Function
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
	
	
End Class


'======================================================================================================================================
'	CLASS TPS_Contragents_Contragent
'======================================================================================================================================
Public Class TPS_Contragents_Account As FBase_Abstract_Object_Doc
	
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	'	PUBLIC:
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Sub New( in_doc As NotesDocument, in_ps As Variant )
	End Sub
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get id As String
		On Error Goto error_point
		If ( m_doc.HasItem( "id" )) Then
			id = m_doc.id(0)
		Else
			id = m_doc.UniversalID
		End If
		Exit Property
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get domain As String
		On Error GoTo error_point
		domain = DOMAIN_TPS_CONTRAGENTS_ACCOUNT
		Exit Property
		
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get title As String
		On Error Goto error_point
		If ( m_doc.HasItem( "title" )) Then
			title = m_doc.title(0)
		End If
		Exit Property
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Set title As String
		On Error Goto error_point
		Call m_doc.Replaceitemvalue( "title", title )
		Exit Property
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get number As String
		On Error Goto error_point
		number = Cstr( m_doc.account_number(0))
		Exit Property 
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Set number As String
		On Error Goto error_point
		Call m_doc.Replaceitemvalue( "account_number", number )
		Exit Property
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get valuta As String
		On Error Goto error_point
		If m_doc.HasItem( "valuta" ) Then
			valuta = Cstr( m_doc.valuta(0))
		End If
		Exit Property 
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Set valuta As String
		On Error Goto error_point
		Call m_doc.Replaceitemvalue("valuta", valuta ) 		
		Exit Property 
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get BIK As String
		On Error Goto error_point
		If m_doc.HasItem( "BIK" ) Then
			BIK = m_doc.BIK(0)
		End If
		
		Exit Property 
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Set BIK As String
		On Error Goto error_point
		Call m_doc.Replaceitemvalue("BIK", BIK) 		
		Exit Property 
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get owner_type As String
		On Error GoTo error_point
		If m_doc.HasItem( "owner_type" ) Then
			owner_type = m_doc.owner_type(0)
		End If
		Exit Property 
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Set owner_type As String
		On Error GoTo error_point
		Call m_doc.Replaceitemvalue("owner_type", owner_type) 		
		Exit Property 
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get account_type As String
		On Error GoTo error_point
		If m_doc.HasItem( "type" ) Then
			account_type = m_doc.type(0)
		End If
		Exit Property 
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Set account_type As String
		On Error GoTo error_point
		Call m_doc.Replaceitemvalue("type", account_type ) 		
		Exit Property 
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get bank_title As String
		On Error GoTo error_point
		If m_doc.HasItem( "bank_title" ) Then
			bank_title = m_doc.bank_title(0)
		End If
		Exit Property
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Set bank_title As String
		On Error GoTo error_point
		Call m_doc.Replaceitemvalue("bank_title", bank_title ) 		
		Exit Property 
error_point:
		On Error GoTo 0
		Error Err, TypeName( Me ) & "." & GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
	Property Get info1C As Variant
		Set info1C = New TPS_Contragents_Account_1CInfo( Me.nd, Me.ps )
	End Property
	
End Class



'======================================================================================================================================
'	CLASS TPS_Contragents_Account_1CInfo
'======================================================================================================================================
Class TPS_Contragents_Account_1CInfo As FBase_Abstract_Object_Doc
	
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	'	PUBLIC:
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Sub New( in_doc As NotesDocument, in_ps As Variant )
	End Sub
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get isExported As Boolean
		On Error Goto error_point
		isExported = ( Me.nd.Export_1C(0) = "1" )
		Exit Property 
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
		'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Set isExported As Boolean
		On Error Goto error_point
		If ( isExported ) Then
			Call Me.nd.ReplaceItemValue( "Export_1C", "1" )
		Else
			Call Me.nd.ReplaceItemValue( "Export_1C", "0" )
		End If
		Exit Property
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get code As String
		On Error Goto error_point
		code = Me.nd.code_1C(0)
		Exit Property 
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Set code As String
		On Error Goto error_point
		Call Me.nd.ReplaceItemValue( "code_1C", code )
		Exit Property
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Get id As String
		On Error Goto error_point
		id = Me.nd.ID1C(0)
		Exit Property 
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	Property Set id As String
		On Error Goto error_point
		Call Me.nd.ReplaceItemValue( "ID1C", id )
		Exit Property
		
error_point:
		On Error Goto 0
		Error Err, Typename( Me ) & "." & Getthreadinfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$
	End Property
	'-----------------------------------------------------------------------------------------------------------------------------------------------------------------
End Class