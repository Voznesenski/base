'++LotusScript Development Environment:2:5:(Options):0:74
Option Public
Option Declare


Use "DWFODLib.UI"
Use "DWFAdditionalDocument"
Use "CustomView_Interface_UI"

'++LotusScript Development Environment:2:5:(Forward):0:1
Declare Class DirectoryStore
Declare Class Directory
Declare Class UITaskStore
Declare Class UITask
Declare Class PopUpStore
Declare Class PopUp
Declare Class PopUpAction
Declare Class AdditionAction
Declare Class AdditionActionStore
Declare Sub Terminate
Declare Function DWFACheckCompleteStage(docMain As NotesDocument, Continue As Integer) As Integer
Declare Function DWFAGetSubProcessDoc(docParentProcess As NotesDocument, docProcess As NotesDocument) As Integer
Declare Function DWFACheckUITaskAddDoc(doc As NotesDocument, docMain As NotesDocument, UITaskValue List As UITaskValue) As Integer
Declare Public Function DWFAAddActionsPost(docMain As NotesDocument, errString As String)As Integer
Declare Function DWFACheckCompleteStageAddDoc(docMain As NotesDocument, Continue As Integer) As Integer
Declare Function DWFAAdminRemoveVisaWithOwner(docMain As NotesDocument, ObjID As Variant, VisaID As Variant) As Integer
Declare Function DWFAInitSubProcess(docProcess As NotesDocument, docMain As NotesDocument, docMainSub As NotesDocument) As Integer
Declare Function DWFAAddStageOwner(docMain As NotesDocument, ObjID As Variant) As Integer
Declare Function DWFAAddDocRemove(docMain As NotesDocument) As Integer
Declare Function DWFARespDocRemove(docMain As NotesDocument) As Integer
Declare Function DWFAGetProcessDocByNotesDatabase(in_db As NotesDatabase, out_docProcess As NotesDocument) As Integer
Declare Function DWFARespDocReturn(docMain As NotesDocument) As Integer
Declare Function DWFAInitProcessIsInitObjBlocked( docProcess As NotesDocument, ODStoreUI As ODStoreUI, AccessID As String ) As Integer
Declare Function DWFAAdminGetStagePostLink(docMain As NotesDocument, docLink As NotesDocument) As Integer
Declare Function DWFARemoveStageOwner(docMain As NotesDocument, ObjID As Variant) As Integer
Declare Function DWFAGetProcessDoc(docProcess As NotesDocument) As Integer
Declare Function DWFACompleteVisa(docMain As NotesDocument, docVisa As NotesDocument) As Integer
Declare Function DWFACheckUITask(doc As NotesDocument, docMain As NotesDocument, UITaskValue List As UITaskValue) As Integer
Declare Function DWFAGetObjIDByProcessItem(_
doc As NotesDocument, ItemPrefix As String, ODStoreUI As ODStoreUI, TaskTitle As String, AccessID As String) As Integer
Declare Function DWFAMakeVisa(docMain As NotesDocument, docVisa As NotesDocument) As Integer
Declare Function DWFAGetTaskInitObj(_
	docMain As NotesDocument, ItemPrefix As String, TaskTitle As String, AccessID As String) As Integer
Declare Function DWFAAskForAction(docMail As NotesDocument) As Integer
Declare Function DWFAAdminCancelVisa(docMain As NotesDocument, VisaID As Variant) As Integer
Declare Function DWFAAddDocAdd(docMain As NotesDocument, docAddDoc As NotesDocument) As Integer
Declare Function DWFAAdminCompleteStage(docMain As NotesDocument, docLink As NotesDocument) As Integer
Declare Function DWFAInitProcess(docProcess As NotesDocument, docMain As NotesDocument) As Integer
Declare Function DWFACompleteStage(docMain As NotesDocument) As Integer
Declare Function DWFAAdminCompleteStage_(docMain As NotesDocument, docLink As NotesDocument, Reason As String, ActionName As string) As Integer
Declare Function DWFAEditVisa(docMain As NotesDocument) As Integer
Declare Function DWFAAddDocReturn(docMain As NotesDocument) As Integer
Declare Function DWFAClaimCancel(docMain As NotesDocument) As Integer
Declare Function DWFAMakeVisaBySetVisaParent(docMain As NotesDocument, docVisa As NotesDocument) As Integer
Declare Function DWFAAdminGetProcessStagePostLink(docMain As NotesDocument, docLink As NotesDocument) As Integer
Declare Function DWFARespDocAdd(docMain As NotesDocument, docAddDoc As NotesDocument) As Integer
Declare Public Function DWFAAddActionsPre(docMain As NotesDocument, errString As String)As Integer
Declare Function DWFAClaim(docMain As NotesDocument) As Integer

'++LotusScript Development Environment:2:5:(Declarations):0:10



Public Type UITaskValue
	isrun As Integer
	valuetype As String
	value As Variant
End Type


Public Type PopUpActionValue
	actiontype As String
	value As Variant
End Type


Public ReturnResult As Variant

Dim completeStageCheckResult As Boolean
Dim completeStageCheckDocMain As NotesDocument

Class DirectoryStore
	Public db As NotesDatabase
	Public ViewUniqueName As NotesView
	Public ViewSub As NotesView
	
	Sub new(dbInfo As String, ErrorStr As String)
		
		If (dbInfo = "") Then
			ErrorStr = {Directory.New() - Нет информации о Справочнике}
			Exit Sub
		End If
		If (DWFSGetDatebase(Cstr(dbInfo), db) <> 1)Then
			ErrorStr = {Не найдена база Справочника}
			Exit Sub	
		End If
		Set ViewUniqueName = db.GetView("(DirectoryByUniqueName)")
		If (ViewUniqueName Is Nothing) Then
			ErrorStr = {В базе Справочника не найдено представление "(DirectoryByUniqueName)"}
			Exit Sub
		End If
		Call ViewUniqueName.Refresh
		ViewUniqueName.AutoUpdate = False
		
		
		Set ViewSub = db.GetView("(SubDocsByParentID)")
		If (ViewSub Is Nothing) Then
			ErrorStr = {В базе Справочника не найдено представление "(SubDocsByParentID)"}
			Exit Sub
		End If
		Call ViewSub.Refresh
		ViewSub.AutoUpdate = False
		
	End Sub
	
	Function GetDirectoryByUniqueName(DirUniqueName As String, ErrorStr As String) As Directory
		On Error Goto errh
		
		Dim colD As NotesDocumentCollection
		Dim docD As NotesDocument
		Dim Directory As New Directory
		
		Set colD = ViewUniqueName.GetAllDocumentsByKey(DirUniqueName, True)
		If (colD.Count = 0) Then
			ErrorStr = {Не найден справочник "} & DirUniqueName & {".} & Chr(13) & { Обратитесь к администратору}
			Exit Function
		End If
		If (colD.Count > 1) Then
			ErrorStr = {Количество справочников "} & DirUniqueName & {": } & Cstr(colD.Count) & Chr(13) &{ Обратитесь к администратору}
			Exit Function
		End If
		
		Set docD = colD.GetFirstDocument
		Set Directory.ViewSub = Me.ViewSub
		If (Directory.Init(docD, ErrorStr) <> 1) Then
			Exit Function
		End If
		
		
		Set GetDirectoryByUniqueName = Directory
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (GetDirectoryByUniqueName) "DirectoryStore" class}
		Resume endh
endh:
	End Function
	
	
	Sub delete()
	End Sub
End Class

Class Directory
	Public db As NotesDatabase
	Public doc As NotesDocument
	Public colChild As NotesDocumentCollection
	Public ViewSub As NotesView
	
	Title_ As String
	ValueType_ As String
	PreViewFormat_ As String
	IsMultiChoice_ As String
	ListWriteInType_ As String
	DataFormat_ As String
	
	Sub new()
	End Sub
	
	Function Init(doc As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Set Me.doc 		= doc
		Set Me.db 		= doc.ParentDatabase
		Me.Title 			= doc.GetItemValue("Name")(0)
		Me.ValueType 		= doc.GetItemValue("ValueType")(0)
		Me.PreViewFormat 	= doc.GetItemValue("ChoicePreViewFormat")(0)
		Me.IsMultiChoice 	= doc.GetItemValue("IsMultiChoice")(0)
		Me.ListWriteInType 	= doc.GetItemValue("ListWriteInType")(0)
		Me.DataFormat 		= doc.GetItemValue("DataFormat")(0)
		
		If Lcase(Me.ValueType) = Lcase("complex") Then
			If (Me.ViewSub Is Nothing) Then
				ErrorStr = {Directory.Init() - Необходимо присвоить значение "ViewSub"} & Chr(13) & {Обратитесь к администратору}
				Exit Function				
			End If
			Set colChild = Me.GetChild(Me.ViewSub, doc.UniversalID, ErrorStr)
			If (colChild Is Nothing) Then
				ErrorStr = {Справочник "} & Me.Title & {" пустой}
				Exit Function
			End If
			If (colChild.Count = 0) Then
				ErrorStr = {Справочник "} & Me.Title & {" пустой}
				Exit Function
			End If
		End If
		
		Init = 1
		
		Exit Function
errh:
		ErrorStr =  Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (Init) "Directory" class}
		Resume endh
endh:
	End Function
	
	
	Function GetChild(View As NotesView, Key As String, ErrorStr As String) As NotesDocumentCollection
		On Error Goto errh
		
		Dim col As NotesDocumentCollection
		Dim doc As NotesDocument
		Dim SortList List As NotesDocument
		Dim SortNum As String
		Dim docTest As NotesDocument
		Dim v As Variant
		Dim MaxEmpty As Integer
		
		
			
		
		Set col = View.GetAllDocumentsByKey(Key)
		If (col.Count = 0) Then
			Exit Function
		End If
		%REM
		Redim v(0) As Variant
		MaxEmpty = 1001
		Set doc = col.GetFirstDocument
		While (Not (doc Is Nothing))
			SortNum = Cstr(doc.Number(0))
			If (SortNum = "") Then
				SortNum = Cstr(MaxEmpty)
				MaxEmpty = MaxEmpty+1
			End If
			If (Cstr(v(0)) <> "") Then
				Redim Preserve v(Ubound(v)+1) As Variant
			End If
			On Error Goto break
			v(Ubound(v)) = Cint(SortNum)
			On Error Goto errh
			Set SortList(SortNum) = doc
getnext:
			Set doc = col.GetNextDocument(doc)
		Wend
		v = Arrays_Sort(v, 1)
		Set col = View.GetAllDocumentsByKey("xxx")
		Forall ID In v
			Set doc = SortList(ID)
			If (Not (doc Is Nothing)) Then
				Set docTest = col.GetDocument(doc)
				If (docTest Is Nothing) Then
					Call col.AddDocument(doc)	
				End If
			End If
		End Forall
		If (col.Count = 0) Then
			Exit Function
		End If
		%END REM
		
		
		
		
		
		Set GetChild = col
		Exit Function
break:		
		'Print "++++++++++++++++++++++++++++"
		'Print {Не верный формат сортировочных данных (в документе "Содержание справочника"): UNID=} & doc.UniversalID &	{; Name=} & doc.Name(0)
		'Print "++++++++++++++++++++++++++++"
		'Resume getnext
		
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (GetChild) "Directory" class}
		Resume endh
endh:
	End Function
	
	
	Function GenerateValue(DlgTitle As String, GetValue As Variant, GetDirSubName As Variant, ErrorStr As String) As Integer
		On Error Goto errh
		
		
		Dim ws As New NotesUIWorkspace
		Dim session As New NotesSession
		Dim v As Variant
		Dim vTemp As Variant, vUNID As Variant
		Dim i As Integer
		Dim ODStore As ODStore
		Dim ODObj As ODObj
		Dim docSub As NotesDocument
		Dim DialogForm As String
		Dim docTemp As NotesDocument
		Dim DirSubName As Variant
		Dim MergedList List As Variant
		Dim sTemp As String
		
		
		
		
		
		Select Case Lcase(Me.ValueType)
		Case Lcase("simple")
			Select Case Lcase(Me.DataFormat)
			Case Lcase("text")
				v = doc.GetFirstItem("Text").Values
			Case Lcase("number")
				v = doc.GetFirstItem("Number").Values
			Case Lcase("date")
				v = doc.GetFirstItem("Date").Values
			End Select
		Case Lcase("complex")
						
			%REM
			Select Case Lcase(Me.PreViewFormat)
			Case Lcase("separate") 'раздельно
				Select Case Lcase(Me.IsMultiChoice) 'Разрешать multi выбор содержания
				Case Lcase("no") 
					DialogForm = "DWF104" 
				Case Lcase("yes") 
					DialogForm = "DWF105"
				Case Else 
					ErrorStr = {Directory.SetUp - Me.IsMultiChoice: Неизвестный формат данных}
					Exit Function
				End Select
				
				Redim v(0) As Variant
				Set docSub = colChild.GetFirstDocument
				While (Not (docSub Is Nothing))
					If (v(0) <> "") Then
						Redim Preserve v(Ubound(v)+1) As Variant
					End If
					v(Ubound(v)) = docSub.Name(0)
					If (v(Ubound(v)) = "") Then
						v(Ubound(v)) = {<наименование справочника не определено>}
					End If
					v(Ubound(v)) = v(Ubound(v)) & {|} & docSub.UniversalID
					
					Set docSub = colChild.GetNextDocument(docSub)
				Wend
				
				Call Arrays_Sort (v, 1)
				
				Set docTemp = session.CurrentDatabase.CreateDocument
				docTemp.Members = v
				docTemp.Promt = "КЛИКНИТЕ МЫШКОЙ НА НУЖНОМ ЗНАЧЕНИИ"
				
				If Not (ws.DialogBox(DialogForm, True, True, False, False, False, False, Trim("Данные справочника. " & DlgTitle), docTemp, True, False, True)) Then
					Exit Function
				End If
				If (docTemp.List(0) = "") Then
					Exit Function
				End If
				
				vUNID = docTemp.GetFirstItem("List").Values
				Forall docSubID In vUNID
					If (docSubID <> "") Then
						On Error 4091 Resume Next 'bad unid
						Set docSub = Me.db.GetDocumentByUNID(docSubID)
						On Error Goto errh
						If (Not (docSub Is Nothing)) Then
							Select Case Lcase(Me.DataFormat)
							Case Lcase("text")
								vTemp = docSub.GetFirstItem("Text").Values
							Case Lcase("number")
								vTemp = docSub.GetFirstItem("Number").Values
							Case Lcase("date")
								vTemp = docSub.GetFirstItem("Date").Values
							Case Lcase("odobj")
								vTemp = Evaluate({ODObjName + "|" + ODObjID}, docSub)
							End Select
							
							sTemp = docSub.Name(0)
							If (sTemp = "") Then
								sTemp = {<наименование справочника не определено>}
							End If
							
							If Iselement(MergedList(sTemp)) Then
								Redim v(0) As Variant
								Forall Value In MergedList(sTemp)
									If (v(0) <> "") Then
										Redim Preserve v(Ubound(v)+1) As Variant
									End If
									v(Ubound(v)) = Value
								End Forall
								For i=Lbound(vTemp) To Ubound(vTemp)
									If (vTemp(i) <> "") Then
										If (v(0) <> "") Then
											Redim Preserve v(Ubound(v)+1) As Variant
										End If
										v(Ubound(v)) = vTemp(i)
									End If
								Next
							Else
								v = vTemp
							End If
							MergedList(sTemp) = v
							
						End If
					End If
				End Forall
				
			Case Lcase("merge") 'объединять в один список
				
				Set docSub = colChild.GetFirstDocument
				While (Not (docSub Is Nothing))
					Select Case Lcase(Me.DataFormat)
					Case Lcase("text")
						vTemp = docSub.GetFirstItem("Text").Values
					Case Lcase("number")
						vTemp = docSub.GetFirstItem("Number").Values
					Case Lcase("date")
						vTemp = docSub.GetFirstItem("Date").Values
					Case Lcase("odobj")
						vTemp = Evaluate({ODObjName + "|" + ODObjID}, docSub)
					End Select
					
					sTemp = docSub.Name(0)
					If (sTemp = "") Then
						sTemp = {<наименование справочника не определено>}
					End If
					
					If Iselement(MergedList(sTemp)) Then
						Redim v(0) As Variant
						Forall Value In MergedList(sTemp)
							If (v(0) <> "") Then
								Redim Preserve v(Ubound(v)+1) As Variant
							End If
							v(Ubound(v)) = Value
						End Forall
						For i=Lbound(vTemp) To Ubound(vTemp)
							If (vTemp(i) <> "") Then
								If (v(0) <> "") Then
									Redim Preserve v(Ubound(v)+1) As Variant
								End If
								v(Ubound(v)) = vTemp(i)
							End If
						Next
					Else
						v = vTemp
					End If
					MergedList(sTemp) = v
					
					Set docSub = colChild.GetNextDocument(docSub)
				Wend
				
			End Select
			%END REM
			
			
			'<patch add by Tambiev 2017.07.04>
			Dim dbDir As NotesDatabase
			Set dbDir = Me.doc.Parentdatabase
			
			Dim isMulti As Boolean
			Select Case LCase(Me.IsMultiChoice) 'Разрешать multi выбор содержания
			Case LCase("no") 
				isMulti = False
			Case LCase("yes")
				isMulti = True 
			Case Else
				If ( LCase(Me.PreViewFormat) = "merge" ) Then
					isMulti = True 
				End If
			End Select
				
			Set Me.colChild = ws.Picklistcollection(_
			PICKLIST_CUSTOM, isMulti, dbDir.Server, dbDir.Filepath, Me.ViewSub.Name,_
			"Список проектов/значений", "Выберите проект(ы)", Me.doc.Universalid)
			If ( Me.colChild.Count = 0 ) Then
				Exit Function
			End If
			
				Set docSub = colChild.GetFirstDocument
				While (Not (docSub Is Nothing))
				Select Case LCase(Me.DataFormat)
				Case LCase("text")
					vTemp = docSub.GetFirstItem("Text").Values
				Case LCase("number")
					vTemp = docSub.GetFirstItem("Number").Values
				Case LCase("date")
					vTemp = docSub.GetFirstItem("Date").Values
				Case LCase("odobj")
					vTemp = Evaluate({ODObjName + "|" + ODObjID}, docSub)
				End Select
				
				sTemp = docSub.Name(0)
				If (sTemp = "") Then
					sTemp = {<наименование справочника не определено>}
				End If
				
				If IsElement(MergedList(sTemp)) Then
					ReDim v(0) As Variant
					ForAll Value In MergedList(sTemp)
						If (v(0) <> "") Then
							ReDim Preserve v(UBound(v)+1) As Variant
						End If
						v(UBound(v)) = Value
					End ForAll
					For i=LBound(vTemp) To UBound(vTemp)
						If (vTemp(i) <> "") Then
							If (v(0) <> "") Then
								ReDim Preserve v(UBound(v)+1) As Variant
							End If
							v(UBound(v)) = vTemp(i)
						End If
					Next
				Else
					v = vTemp
				End If
				MergedList(sTemp) = v
				
				Set docSub = colChild.GetNextDocument(docSub)
			Wend
			'</patch> 
			
			
			
			Redim v(0) As Variant
			Forall Tag In MergedList
				If (Cstr(Tag(0)) <> "") Then
					Forall Value In Tag
						If (v(0) <> "") Then
							Redim Preserve v(Ubound(v)+1) As Variant
						End If
						v(Ubound(v)) = Value
					End Forall
				End If
			End Forall
		End Select
		
		If (v(0) = "") Then
			ErrorStr = {Нет данных в справочнике "} & Me.Title & {"}
			Exit Function
		End If
		
		Select Case Lcase(Me.DataFormat)
		Case Lcase("odobj")
			If (Ubound(v) > 0) Then
				Select Case Lcase(Me.ListWriteInType)
				Case Lcase("full")
					For i=Lbound(v) To Ubound(v)
						v(i) = Strright(v(i), {|})
					Next
					Redim DirSubName(0) As Variant
					Forall Tag In MergedList
						If (Listtag(Tag) <> "") Then
							If (DirSubName(0) <> "") Then
								Redim Preserve DirSubName(Ubound(DirSubName)+1) As Variant
							End If
							DirSubName(Ubound(DirSubName)) = Listtag(Tag)
						End If
					End Forall
				Case Lcase("checkvalue")
					Set docTemp = session.CurrentDatabase.CreateDocument
					docTemp.Members = v
					docTemp.Promt = "КЛИКНИТЕ МЫШКОЙ НА НУЖНОМ(ЫХ) ЗНАЧЕНИИ(ЯХ)"
					
					If Not (ws.DialogBox("DWF105", True, True, False, False, False, False, Trim({Список значений из справочника. } & DlgTitle), docTemp, True, False, True)) Then
						Exit Function
					End If
					v = docTemp.GetFirstItem("List").Values
					If (v(0) = "") Then
						Exit Function
					End If
					
					Dim hasMatch As Integer
					Redim DirSubName(0) As Variant
					For i=Lbound(v) To Ubound(v)
						hasMatch = 0
						Forall Tag In MergedList
							If (Cstr(Tag(0)) <> "") Then
								Forall Value In Tag
									If (v(i) = Strright(Value, {|})) Then
										hasMatch = 1
										Exit Forall
									End If
								End Forall
							End If
							If (hasMatch = 1) Then
								hasMatch = 0
								If (Listtag(Tag) <> "") Then
									Forall dsn In DirSubName
										If (Lcase(dsn) = Lcase(Listtag(Tag))) Then
											hasMatch = 1
											Exit Forall
										End If
									End Forall
									If (hasMatch = 0) Then
										If (DirSubName(0) <> "") Then
											Redim Preserve DirSubName(Ubound(DirSubName)+1) As Variant
										End If
										DirSubName(Ubound(DirSubName)) = Listtag(Tag)	
									End If
								End If
								Exit Forall
							End If
						End Forall
					Next
					
				End Select
			Else
				For i=Lbound(v) To Ubound(v)
					v(i) = Strright(v(i), {|})
				Next
				Redim DirSubName(0) As Variant
				Forall Tag In MergedList
					If (Listtag(Tag) <> "") Then
						If (DirSubName(0) <> "") Then
							Redim Preserve DirSubName(Ubound(DirSubName)+1) As  Variant
						End If
						DirSubName(Ubound(DirSubName)) = Listtag(Tag)
					End If
				End Forall
			End If
			
			GetValue = v
			GetDirSubName = DirSubName
			
		Case Else
			If (Ubound(v) > 0) Then
				Select Case Lcase(Me.ListWriteInType)
				Case Lcase("full")
					'nothing
				Case Lcase("checkvalue")
					For i=Lbound(v) To Ubound(v)
						v(i) = v(i) & {|} & v(i)
					Next
					
					Set docTemp = session.CurrentDatabase.CreateDocument
					docTemp.Members = v
					docTemp.Promt = "КЛИКНИТЕ МЫШКОЙ НА НУЖНОМ(ЫХ) ЗНАЧЕНИИ(ЯХ)"
					
					If Not (ws.DialogBox("DWF105", True, True, False, False, False, False, Trim({Список значений из справочника. } & DlgTitle), docTemp, True, False, True)) Then
						Exit Function
					End If
					v = docTemp.GetFirstItem("List").Values
					If (v(0) = "") Then
						Exit Function
					End If
				End Select
			End If
			
			GetValue = v
			
		End Select
		
		GenerateValue = 1
		
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (GenerateValue) "Directory" class}
		Resume endh
endh:
	End Function
	
	
	
	
	Function SetUp(docMain As NotesDocument, ItemName As String, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim v As Variant
		Dim DirSubName As Variant
		Dim ODStore As ODStore
		Dim ODObj As ODObj
		
		
		If (Me.GenerateValue("", v, DirSubName, ErrorStr) <>1) Then
			Exit Function
		End If
		
		Select Case Lcase(Me.DataFormat)
		Case Lcase("odobj")
			Set ODStore = New ODStore(docMain.dbODPath(0), ErrorStr)
			If (ErrorStr <> "") Then
				Msgbox ErrorStr, 48, ERR_MSG_TITLE
				Exit Function
			End If
			If (ODStore.ClearItem(docMain, ItemName, ErrorStr) <> 1) Then
				Exit Function
			End If
			Forall ID In v
				Set ODObj = ODStore.GetObjByValue(Cstr(ID), ErrorStr)
				If (ErrorStr <> "") Then
					Msgbox ErrorStr, 48, ERR_MSG_TITLE
					Exit Function
				End If
				If (ODObj.WriteInAppend(docMain, ItemName, ErrorStr) <> 1) Then
					If (ErrorStr <> "") Then
						Msgbox ErrorStr, 48, ERR_MSG_TITLE
						Exit Function
					End If
				End If
			End Forall
			Call docMain.ReplaceItemValue(ItemName, DirSubName)
		Case Else
			Call docMain.ReplaceItemValue(ItemName, v)
		End Select
		
		
		
		
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (SetUp) "Directory" class}
		Resume endh
endh:
	End Function
	
	
	Function GetAllData(GetValue As Variant, GetDirSubName As Variant, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim session As New NotesSession
		Dim v As Variant
		Dim vTemp As Variant, vUNID As Variant
		Dim i As Integer
		Dim docSub As NotesDocument
		Dim DirSubName As Variant
		Dim MergedList List As Variant
		Dim sTemp As String
		
		Select Case Lcase(Me.ValueType)
		Case Lcase("simple")
			Select Case Lcase(Me.DataFormat)
			Case Lcase("text")
				v = doc.GetFirstItem("Text").Values
			Case Lcase("number")
				v = doc.GetFirstItem("Number").Values
			Case Lcase("date")
				v = doc.GetFirstItem("Date").Values
			End Select
		Case Lcase("complex")
			Set docSub = colChild.GetFirstDocument
			While (Not (docSub Is Nothing))
				Select Case Lcase(Me.DataFormat)
				Case Lcase("text")
					vTemp = docSub.GetFirstItem("Text").Values
				Case Lcase("number")
					vTemp = docSub.GetFirstItem("Number").Values
				Case Lcase("date")
					vTemp = docSub.GetFirstItem("Date").Values
				Case Lcase("odobj")
					vTemp = Evaluate({ODObjName + "|" + ODObjID}, docSub)
				End Select
				
				sTemp = docSub.Name(0)
				If (sTemp = "") Then
					sTemp = {<наименование справочника не определено>}
				End If
				
				If Iselement(MergedList(sTemp)) Then
					Redim v(0) As Variant
					Forall Value In MergedList(sTemp)
						If (v(0) <> "") Then
							Redim Preserve v(Ubound(v)+1) As Variant
						End If
						v(Ubound(v)) = Value
					End Forall
					For i=Lbound(vTemp) To Ubound(vTemp)
						If (vTemp(i) <> "") Then
							If (v(0) <> "") Then
								Redim Preserve v(Ubound(v)+1) As Variant
							End If
							v(Ubound(v)) = vTemp(i)
						End If
					Next
				Else
					v = vTemp
				End If
				MergedList(sTemp) = v
				
				Set docSub = colChild.GetNextDocument(docSub)
			Wend
			
			Redim v(0) As Variant
			Forall Tag In MergedList
				If (Cstr(Tag(0)) <> "") Then
					Forall Value In Tag
						If (v(0) <> "") Then
							Redim Preserve v(Ubound(v)+1) As Variant
						End If
						v(Ubound(v)) = Value
					End Forall
				End If
			End Forall
		End Select
		
		If (v(0) = "") Then
			ErrorStr = {Нет данных в справочнике "} & Me.Title & {"}
			Exit Function
		End If
		
		Select Case Lcase(Me.DataFormat)
		Case Lcase("odobj")
			If (Ubound(v) > 0) Then
				
				For i=Lbound(v) To Ubound(v)
					v(i) = Strright(v(i), {|})
				Next
				Redim DirSubName(0) As Variant
				Forall Tag In MergedList
					If (Listtag(Tag) <> "") Then
						If (DirSubName(0) <> "") Then
							Redim Preserve DirSubName(Ubound(DirSubName)+1) As Variant
						End If
						DirSubName(Ubound(DirSubName)) = Listtag(Tag)
					End If
				End Forall
			Else
				For i=Lbound(v) To Ubound(v)
					v(i) = Strright(v(i), {|})
				Next
				Redim DirSubName(0) As Variant
				Forall Tag In MergedList
					If (Listtag(Tag) <> "") Then
						If (DirSubName(0) <> "") Then
							Redim Preserve DirSubName(Ubound(DirSubName)+1) As  Variant
						End If
						DirSubName(Ubound(DirSubName)) = Listtag(Tag)
					End If
				End Forall
			End If
			
			GetValue = v
			GetDirSubName = DirSubName
			
		Case Else
			
			GetValue = v
			
		End Select
		
		GetAllData = 1
		
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (GetAllData) "Directory" class}
		Resume endh
endh:
	End Function
	
	
	Property Set Title
		Title_ = Title
	End Property
	Public Property Get Title
		Title = Title_
	End Property
	
	Property Set ValueType
		ValueType_ = ValueType
	End Property
	Public Property Get ValueType
		ValueType = ValueType_
	End Property
	
	Property Set PreViewFormat
		PreViewFormat_ = PreViewFormat
	End Property
	Public Property Get PreViewFormat
		PreViewFormat = PreViewFormat_
	End Property
	
	Property Set IsMultiChoice
		IsMultiChoice_ = IsMultiChoice
	End Property
	Public Property Get IsMultiChoice
		IsMultiChoice = IsMultiChoice_
	End Property
	
	Property Set ListWriteInType
		ListWriteInType_ = ListWriteInType
	End Property
	Public Property Get ListWriteInType
		ListWriteInType = ListWriteInType_
	End Property
	
	Property Set DataFormat
		DataFormat_ = DataFormat
	End Property
	Public Property Get DataFormat
		DataFormat = DataFormat_
	End Property
	
	
	Sub delete()
	End Sub
End Class


Class UITaskStore
	Public doc As NotesDocument
	Private View As NotesView
	
	Sub new()
	End Sub
	
	Function Init(doc As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim db As NotesDatabase
		Dim ViewName As String
		
		ViewName = {UITask}
		Set db = doc.ParentDatabase
		Set Me.doc = doc
		Set Me.View = db.GetView(ViewName)
		If (Me.View Is Nothing) Then
			ErrorStr = {Не найдено представление "} & ViewName & {"}
			Exit Function
		End If
		Call Me.View.Refresh
		Me.View.AutoUpdate = False
		
		Init = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (Init) "UITaskStore" class}
		Resume endh
endh:
	End Function
	
	Function SetUITask(docMain As NotesDocument, UITaskValue List As UITaskValue, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim colUIT As NotesDocumentCollection
		Dim docUIT As NotesDocument
		Dim UITask As UITask
		Dim Continue As Integer
		
		Set colUIT = Me.GetCollection(Me.doc.UniversalID, ErrorStr)
		If (colUIT Is Nothing) Then
			SetUITask = 1
			Exit Function
		End If
		If (colUIT.Count = 0) Then
			SetUITask = 1
			Exit Function
		End If
		
		Set docUIT = colUIT.GetFirstDocument
		While (Not (docUIT Is Nothing))
			Continue = 1
			
			Set UITask = New UITask
			If (UITask.Init(docUIT, ErrorStr) <>1) Then
				Exit Function
			End If
			If (UITask.SetUp(docMain, Continue, ErrorStr) <> 1) Then
				Exit Function
			End If
			If (Continue = 0) Then
				Exit Function
			End If
			
			
			Dim x As UITaskValue
			x.isrun = UITask.isrun
			x.valuetype = UITask.ValueType
			x.value = UITask.Value
			UITaskValue(Cstr(docUIT.UniversalID)) =  x
			
			Set docUIT = colUIT.GetNextDocument(docUIT)
		Wend
		
		SetUITask = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (SetUITask) "UITaskStore" class}
		Resume endh
endh:
	End Function
	
	Function SetUITaskAddDoc(docMain As NotesDocument, UITaskValue List As UITaskValue, ErrorStr As String) As Integer
		On Error GoTo errh
		
		Dim colUIT As NotesDocumentCollection
		Dim docUIT As NotesDocument
		Dim UITask As UITask
		Dim Continue As Integer
		
		Set colUIT = Me.GetCollection(Me.doc.UniversalID, ErrorStr)
		If (colUIT Is Nothing) Then
			SetUITaskAddDoc = 1
			Exit Function
		End If
		If (colUIT.Count = 0) Then
			SetUITaskAddDoc = 1
			Exit Function
		End If
		
		Set docUIT = colUIT.GetFirstDocument
		While (Not (docUIT Is Nothing))
			Continue = 1
			
			Set UITask = New UITask
			If (UITask.Init(docUIT, ErrorStr) <>1) Then
				Exit Function
			End If
			If (UITask.SetUpAddDoc(docMain, Continue, ErrorStr) <> 1) Then
				Exit Function
			End If
			If (Continue = 0) Then
				Exit Function
			End If
			
			Dim x As UITaskValue
			x.isrun = UITask.isrun
			x.valuetype = UITask.ValueType
			x.value = UITask.Value
			UITaskValue(CStr(docUIT.UniversalID)) =  x
			
			Set docUIT = colUIT.GetNextDocument(docUIT)
		Wend

		SetUITaskAddDoc = 1
		
		Exit Function
errh:
		MsgBox Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (SetUITaskAddDoc) "UITaskStore" class}
		Resume endh
endh:
	End Function
	
	Function GetCollection(Key As String, ErrorStr As String) As NotesDocumentCollection
		On Error Goto errh
		
		Dim col As NotesDocumentCollection
		Dim doc As NotesDocument
		Dim SortList List As NotesDocument
		Dim SortNum As String
		Dim docTest As NotesDocument
		Dim v As Variant
		Dim MaxEmpty As Integer
		
		
		Set col = Me.View.GetAllDocumentsByKey(Key)
		If (col.Count = 0) Then
			Exit Function
		End If
		
		Redim v(0) As Variant
		MaxEmpty = 1001
		Set doc = col.GetFirstDocument
		While (Not (doc Is Nothing))
			SortNum = Cstr(doc.Number(0))
			If (SortNum = "") Then
				SortNum = Cstr(MaxEmpty)
				MaxEmpty = MaxEmpty+1
			End If
			If (Cstr(v(0)) <> "") Then
				Redim Preserve v(Ubound(v)+1) As Variant
			End If
			On Error Goto break
			v(Ubound(v)) = Cint(SortNum)
			On Error Goto errh
			Set SortList(SortNum) = doc
getnext:
			Set doc = col.GetNextDocument(doc)
		Wend
		v = Arrays_Sort(v, 1)
		Set col = Me.View.GetAllDocumentsByKey("xxx")
		Forall ID In v
			Set doc = SortList(ID)
			If (Not (doc Is Nothing)) Then
				Set docTest = col.GetDocument(doc)
				If (docTest Is Nothing) Then
					Call col.AddDocument(doc)	
				End If
			End If
		End Forall
		If (col.Count = 0) Then
			Exit Function
		End If
		
		Set GetCollection = col
		Exit Function
break:		
		Print "++++++++++++++++++++++++++++"
		Print {Не верный формат сортировочных данных (в документе "UI-запроса"): UNID=} & doc.UniversalID &	{; Name=} & doc.Name(0)
		Print "++++++++++++++++++++++++++++"
		Resume getnext
		
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (GetCollection) "UITaskStore" class}
		Resume endh
endh:
	End Function
	
	
	
	Sub delete()
	End Sub
End Class

Class UITask
	Public doc As NotesDocument
	Private db As NotesDatabase
	Title_ 		As String
	ValueType_ 	As String
	ValueKind_ 	As String
	ItemName_ 	As String
	TitleDlg_		As String
	Condition_ 	As String
	IsMultiChoice_ As String
	Value_ 		As Variant
	IsRun_		As Integer
	Sub new()
	End Sub
	
	Function Init(doc As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Set Me.doc = doc
		Set Me.db = doc.ParentDatabase
		Me.Title = doc.Name(0)
		Me.ValueType = doc.ValueType(0)
		Me.ValueKind = doc.ValueKind(0)
		Me.ItemName = doc.ItemName(0)
		Me.TitleDlg = doc.TitleDlg(0)
		Me.Condition = doc.Condition(0)
		Me.IsMultiChoice = doc.IsMultiChoice(0)
		
		If (Lcase(Me.ValueType) <> Lcase("AddDoc")) Then
			If (Me.ItemName = "") Then
				ErrorStr = {Не задано Наименование поля в UI-запросе "} & Me.Title & {"}
				Exit Function
			End If
		End If
		
		
		Init = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (Init) "UITask" class}
		Resume endh
endh:
	End Function
	
	
	Function SetUp(docMain As NotesDocument, Continue As Integer, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim ws As NotesUIWorkspace 'изменено: убрал объявление с New, чтобы можно было звершить стадию на сервере; 2017.09.11 Tambiev
		Dim v As Variant
		Dim DialogForm As String
		Dim i As Integer
		Dim docTemp As NotesDocument
		Dim colAddDoc As NotesDocumentCollection
		Dim docAddDoc As NotesDocument
		
		On Error Goto errFormula
		If (docMain Is Nothing) Then
			v = Evaluate(Me.Condition)	
		Else
			v = Evaluate(Me.Condition, docMain)
		End If
		On Error Goto errh
		If (Cstr(v(0)) <> "1") Then
			SetUp = 1
			Me.IsRun = 0
			Exit Function
		End If
		
		Select Case Lcase(Me.ValueType)
		Case Lcase("ODObj")
			Select Case Lcase(Me.ValueKind)
			Case Lcase("Dir")
				If (Me.GetDirectoryValue(v, ErrorStr) <>1) Then
					Exit Function
				End If
				Me.value = v
			Case Lcase("Manual")
				If (GetODValue(docMain, v, ErrorStr) <> 1) Then
					Exit Function
				End If
				Me.value = v
			Case Else
				ErrorStr = {UITask.SetUp() - Неизвестный выбор значения UI-запроса "} & Me.Title & {"}
				Exit Function
			End Select
			
		Case Lcase("Other")
			Select Case Lcase(Me.ValueKind)
			Case Lcase("Dir")
				If (Me.GetDirectoryValue(v, ErrorStr) <>1) Then
					Exit Function
				End If
				Me.value = v
			Case Lcase("Manual")
				Select Case Lcase(doc.GetItemValue("ValueOtherSource")(0))
				Case "manual"
					v = doc.GetFirstItem("ValueOther").Values	
				Case "@"
					If (doc.GetItemValue("ValueOtherFormula")(0) = "") Then
						ErrorStr = {Не задана @-формула значений в UI-запросе "} & Me.Title & {"}
						Exit Function
					End If
					v = Evaluate(doc.GetItemValue("ValueOtherFormula")(0), docMain)
				End Select
				If (Cstr(v(0)) = "") Then
					ErrorStr = {Нет данных в UI-запросе "} & Me.Title & {"}
					Exit Function
				End If
				
				Select Case Lcase(Me.IsMultiChoice) 'Разрешать multi выбор содержания
				Case Lcase("no") 
					DialogForm = "DWF104" 
				Case Lcase("yes") 
					DialogForm = "DWF105"
				Case Else 
					ErrorStr = {UITask.SetUp - Me.IsMultiChoice: Неизвестный формат данных}
					Exit Function
				End Select
				
				
				For i=Lbound(v) To Ubound(v)
					v(i) = v(i) & {|} & v(i)
				Next
				
				Set docTemp = Me.db.CreateDocument
				docTemp.Members = v
				docTemp.Promt = "КЛИКНИТЕ МЫШКОЙ НА НУЖНОМ(ЫХ) ЗНАЧЕНИИ(ЯХ)"
				
				Set ws = New NotesUIWorkspace 'добавлено: задаем значение, там где необходимо;  2017.09.11 Tambiev
				If Not (ws.DialogBox(DialogForm, True, True, False, False, False, False, Me.TitleDlg, docTemp, True, False, True)) Then
					Exit Function
				End If
				v = docTemp.GetFirstItem("List").Values
				If (v(0) = "") Then
					Exit Function
				End If
				
				Me.value = v
			Case Else
				ErrorStr = {UITask.SetUp() - Неизвестный выбор значения UI-запроса "} & Me.Title & {"}
				Exit Function
			End Select
			
			
		Case Lcase("AddDoc")
			
			
		%REM
			Dim ViewName As String
			Dim multi As Boolean
			
			ViewName = doc.ValueAddDocViewName(0)
			If (ViewName = "") Then
				ErrorStr = {Не задано Представление для отображения в UI-запросе "} & Me.Title & {"}
				Exit Function
			End If
			Select Case Lcase(Me.IsMultiChoice) 'Разрешать multi выбор содержания
			Case Lcase("no") 
				multi = False
			Case Lcase("yes") 
				multi = True
			Case Else 
				ErrorStr = {UITask.SetUp - Me.IsMultiChoice: Неизвестный формат данных}
				Exit Function
			End Select
			
			Set ws = New NotesUIWorkspace 'добавлено: задаем значение, там где необходимо;  2017.09.11 Tambiev
			Set colAddDoc = ws.PickListCollection(_
			3,_ 'PICKLIST_CUSTOM
			multi,_
			Me.db.Server,_
			Me.db.FilePath,_
			ViewName,_
			Me.db.Title & ". Список доп. документов",_
			Me.TitleDlg,_
			docMain.UniversalID)
			If Isempty(colAddDoc) Then
				Exit Function
			End If
			If (colAddDoc.Count = 0) Then
				Exit Function
			End If
			Redim v(0) As String
			Set docAddDoc = colAddDoc.GetFirstDocument
			While (Not (docAddDoc Is Nothing))
				If (v(0) <> "") Then
					Redim Preserve v(Ubound(v)+1) As String
				End If
				v(Ubound(v)) = docAddDoc.UniversalID
				Set docAddDoc = colAddDoc.GetNextDocument(docAddDoc)
			Wend
			If (v(0) = "") Then
				Call docMain.Replaceitemvalue("StageAddDocsUnids", "")
				Exit Function
			End If
			Me.value = v
			
'			ForAll vv In v
'				vv = docMain.getItemValue("StageId")(0) & "~" & vv
'			End ForAll
'			Call docMain.Replaceitemvalue("StageAddDocsUnids", v)
		%END REM
		
		Case Else
			ErrorStr = {UITask.SetUp() - Неизвестный тип UI-запроса "} & Me.Title & {"}
			Exit Function
		End Select
		
		Me.IsRun = 1
		SetUp = 1
		Exit Function
errFormula:		
		ErrorStr = {Ошибка при вычислении условия выполнения для UI-запроса "} & Me.Title & {"}
		Resume endh		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (SetUp) "UITask" class}
		Resume endh
endh:
	End Function
	
	Function SetUpAddDoc(docMain As NotesDocument, Continue As Integer, ErrorStr As String) As Integer
		On Error GoTo errh
		
		Dim ws As NotesUIWorkspace
		Dim v As Variant
		Dim DialogForm As String
		Dim i As Integer
		Dim docTemp As NotesDocument
		Dim colAddDoc As NotesDocumentCollection
		Dim docAddDoc As NotesDocument
		
		On Error GoTo errFormula
		If (docMain Is Nothing) Then
			v = Evaluate(Me.Condition)	
		Else
			v = Evaluate(Me.Condition, docMain)
		End If
		On Error GoTo errh
		If (CStr(v(0)) <> "1") Then
			SetUpAddDoc = 1
			Me.IsRun = 0
			Exit Function
		End If
		
		Select Case LCase(Me.ValueType)
			Case LCase("AddDoc")
				
				Dim ViewName As String
				Dim multi As Boolean
				
				ViewName = doc.ValueAddDocViewName(0)
				If (ViewName = "") Then
					ErrorStr = {Не задано Представление для отображения в UI-запросе "} & Me.Title & {"}
					Exit Function
				End If
				Select Case LCase(Me.IsMultiChoice) 'Разрешать multi выбор содержания
				Case LCase("no") 
					multi = False
				Case LCase("yes") 
					multi = True
				Case Else 
					ErrorStr = {UITask.SetUpAddDoc - Me.IsMultiChoice: Неизвестный формат данных}
					Exit Function
				End Select
				
				Dim viewAddDoc As NotesView
				Set viewAddDoc = Me.db.Getview("(AddDocByMainRef)")  ' viewName
				If (viewAddDoc Is Nothing) Then
					ErrorStr = {Не найдено представление (AddDocByMainRef) для поиска доп. документов в UI-запросе "} & Me.Title & {"}
					Exit Function
				End If
				Set colAddDoc = viewAddDoc.Getalldocumentsbykey(docMain.Universalid, False)

				If colAddDoc.count <> 1 Then
					Set ws = New NotesUIWorkspace
					Set colAddDoc = ws.PickListCollection(_
					3,_ 
					multi,_
					Me.db.Server,_
					Me.db.FilePath,_
					ViewName,_
					Me.db.Title & ". Список доп. документов",_
					Me.TitleDlg,_
					docMain.UniversalID)
				End If
				
				If IsEmpty(colAddDoc) Then
					Exit Function
				End If
				If (colAddDoc.Count = 0) Then
					Exit Function
				End If
				
				Set docAddDoc = colAddDoc.GetFirstDocument
				ReDim v(0) As String
				While (Not (docAddDoc Is Nothing))
					If (v(0) <> "") Then
						ReDim Preserve v(UBound(v)+1) As String
					End If
					v(UBound(v)) = docAddDoc.UniversalID
					Set docAddDoc = colAddDoc.GetNextDocument(docAddDoc)
				Wend
				If (v(0) = "") Then
					Call docMain.Replaceitemvalue("StageAddDocsUnids", "")
					Exit Function
				End If
				Me.value = v

		End Select
		
		Me.IsRun = 1
		SetUpAddDoc = 1
		Exit Function
errFormula:		
		ErrorStr = {Ошибка при вычислении условия выполнения для UI-запроса "} & Me.Title & {"}
		Resume endh		
		Exit Function
errh:
		MsgBox Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (SetUpAddDoc) "UITask" class}
		Resume endh
endh:
	End Function
	
	Function GetDirectoryValue(Value As Variant, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim docParent As NotesDocument
		Dim docProcess As NotesDocument
		Dim v As Variant
		Dim dbDirectory As NotesDatabase
		Dim docDir As NotesDocument
		Dim ViewSub As NotesView
		Dim Directory As New Directory
		Dim DirSubName As Variant
		
		
		Set docParent = Me.db.GetDocumentByUNID(Me.doc.GetItemValue("ParentRef")(0))
		On Error Goto errh
		If (docParent Is Nothing) Then
			ErrorStr = {Не найден родительский документ для UI-запроса "} & Me.Title & {"}
			Exit Function
		End If
		
		If (docParent.Form(0) = "DWF01") Then
			Set docProcess = docParent
		Else
			On Error 4091 Resume Next
			Set docProcess = db.GetDocumentByUNID(docParent.GetItemValue("ProcessRef")(0))
			On Error Goto errh
		End If
		If (docProcess Is Nothing) Then
			ErrorStr = {Не найден документ Процесса. UI-запрос "} & Me.Title & {"}
			Exit Function
		End If
		
		Redim v(0) As String
		v(0) = docProcess.Directory(0)
		If (v(0) = "") Then
			ErrorStr = {В документе "Процесса" не задана Орг. директория}
			Exit Function
		End If
		
		If (DWFSGetDatebase(Cstr(v(0)), dbDirectory) <> 1)Then
			Msgbox {Не найдена база Справочника}, 48, ERR_MSG_TITLE
			Exit Function
		End If
		
		On Error 4091 Resume Next 'bad unid
		Set docDir = dbDirectory.GetDocumentByUNID(doc.DirectoryEntryID(0))
		On Error Goto errh
		If (docDir Is Nothing) Then
			ErrorStr = {UITask.GetDirectoryValue() - Не найден документ Справочника "} & doc.DirectoryEntryName(0) & {"}
			Exit Function
		End If
		
		
		Set ViewSub = dbDirectory.GetView("(SubDocsByParentID)")
		If (ViewSub Is Nothing) Then
			ErrorStr = {В базе Справочника не найдено представление "(SubDocsByParentID)"}
			Exit Function
		End If
		Call ViewSub.Refresh
		ViewSub.AutoUpdate = False
		
		Set Directory.ViewSub = ViewSub
		If (Directory.Init(docDir, ErrorStr) <> 1) Then
			Exit Function
		End If
		If (Directory.GenerateValue(Me.TitleDlg, Value, DirSubName, ErrorStr) <>1) Then
			Exit Function
		End If
		
		
		GetDirectoryValue = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (GetDirectoryValue) "UITask" class}
		Resume endh
endh:
	End Function
	
	Function GetODValue(docMain As NotesDocument, Value As Variant, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim session As New NotesSession
		Dim docParent As NotesDocument
		Dim docProcess As NotesDocument
		Dim v As Variant
		Dim ODStoreUI As ODStoreUI
		Dim multi As Boolean		
		Dim colOD As NotesDocumentCollection
		Dim docOD As NotesDocument
		
		Dim ODObj As ODObj
		Dim Person As New Person
		Dim Position As ODObj
		Dim ItemName As String
		
		Dim ObjPath As Variant
		Dim PathItemName As String
		Dim ViewOD As NotesView
		Dim ViewODName As String
		Dim colODtemp As NotesDocumentCollection
		Dim key As String
		Dim docTest As NotesDocument
		
		Dim coll_d As documentcollection
		
		
		PathItemName = {PathWithCode}
		ViewODName = {PositionByHirerarchy}
		
		
		Set docParent = Me.db.GetDocumentByUNID(Me.doc.GetItemValue("ParentRef")(0))
		On Error Goto errh
		If (docParent Is Nothing) Then
			ErrorStr = {Не найден родительский документ для UI-запроса "} & Me.Title & {"}
			Exit Function
		End If
		
		If (docParent.Form(0) = "DWF01") Then
			Set docProcess = docParent
		Else
			On Error 4091 Resume Next
			Set docProcess = db.GetDocumentByUNID(docParent.GetItemValue("ProcessRef")(0))
			On Error Goto errh
		End If
		If (docProcess Is Nothing) Then
			ErrorStr = {Не найден документ Процесса. UI-запрос "} & Me.Title & {"}
			Exit Function
		End If
		
		Redim v(0) As String
		v(0) = docProcess.OrgDir(0)
		If (v(0) = "") Then
			ErrorStr = {В документе "Процесса" не задана Орг. директория}
			Exit Function
		End If
		
		Set ODStoreUI = New ODStoreUI(Cstr(v(0)), ErrorStr)
		If (ErrorStr <> "") Then
			Exit Function
		End If
		
		If (Me.IsMultiChoice = "yes") Then
			multi = True
		Else
			multi = False
		End If
		
		Select Case Lcase(doc.ValueODTask(0))
		Case Lcase("AllPos")
			If (ODStoreUI.PickObject("Pos", multi, Me.TitleDlg, colOD, ErrorStr) <>1) Then
				Exit Function
			End If
			
			Redim v(0) As String
			Set docOD = colOD.GetFirstDocument
			While (Not (docOD Is Nothing))
				If (v(0) <> "") Then
					Redim Preserve v(Ubound(v)+1) As String
				End If
				v(Ubound(v)) = docOD.UniversalID
				Set docOD = colOD.GetNextDocument(docOD)
			Wend
			If (v(0) = "") Then
				Exit Function
			End If
		Case Lcase("AllUser")
			If (ODStoreUI.PickObject("User", multi, Me.TitleDlg, colOD, ErrorStr) <>1) Then
				Exit Function
			End If
			
			Redim v(0) As String
			Set docOD = colOD.GetFirstDocument
			While (Not (docOD Is Nothing))
				If (v(0) <> "") Then
					Redim Preserve v(Ubound(v)+1) As String
				End If
				v(Ubound(v)) = docOD.UniversalID
				Set docOD = colOD.GetNextDocument(docOD)
			Wend
			If (v(0) = "") Then
				Exit Function
			End If
			
		Case Lcase("Chief")		
%REM
Надо дописать 2010.10.02
%END REM		
			Select Case Lcase(doc.ValueODTargetBy(0))
			Case Lcase("Current")
				Set ODObj = ODStoreUI.GetObjByValue(session.UserName, ErrorStr)	
			Case Lcase("FormItem")
				ItemName = doc.ValueODTargetByFormItem(0)
				If (ItemName = "") Then
					ErrorStr = {UITask.GetODValue() - Не задано поле для вычисления объекта Орг. директории. UI-запрос "} & Me.Title & {"}
					Exit Function
				End If
				If (Not (docMain.HasItem(ItemName))) Then
					ErrorStr = {UITask.GetODValue() - Не найдено поле "} & ItemName & {" для вычисления объекта Орг. директории. UI-запрос "} & Me.Title & {"}
					Exit Function
				End If
				v = docMain.GetFirstItem(ItemName).Values
				If (Ubound(v) <> 0) Then
					ErrorStr = {UITask.GetODValue() - Значение поля "} & ItemName & {" неоднозначное. UI-запрос "} & Me.Title & {"}
					Exit Function
				End If
				If (Cstr(v(0)) = "") Then
					ErrorStr = {UITask.GetODValue() - Пустое значение поля "} & ItemName & {". UI-запрос "} & Me.Title & {"}
					Exit Function
				End If
				Set ODObj = ODStoreUI.GetObjByValue(Cstr(v(0)), ErrorStr)	
			End Select
			If (ErrorStr <> "") Then
				Exit Function
			End If
			If (ODObj Is Nothing) Then
				Exit Function
			End If
			If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
				Exit Function	
			End If
			
			Set Position = Person.GetUserPosition(ErrorStr)
			If (ErrorStr <> "") Then
				Exit Function	
			End If
			If (Position Is Nothing) Then
				Exit Function
			End If
			
			If (Not(Position.doc.HasItem(PathItemName))) Then
				ErrorStr = {Сбой: UITask.GetODValue() - В документе объекта Орг. директории "} & Position.ObjName & {" нет поля "} & PathItemName & {". UI-запрос "} & Me.Title & {"}
				Exit Function
			End If
			ObjPath = Position.doc.GetFirstItem(PathItemName).Values
			If (ObjPath(0) = "") Then
				ErrorStr = {Сбой: UITask.GetODValue() - Пустое значение в поле "} & PathItemName & {" документа объекта Орг. директории "} & Position.ObjName & {". UI-запрос "} & Me.Title & {"}
				Exit Function
			End If
			
			Set ViewOD = ODStoreUI.db.GetView(ViewODName)
			If (ViewOD Is Nothing) Then
				ErrorStr = {Сбой: UITask.GetODValue() - В Орг. директории не найдено представление "} & ViewODName & {"}
				Exit Function
			End If
			Call ViewOD.Refresh()
			ViewOD.AutoUpdate = False
			
			Set colOD = ViewOD.GetAllDocumentsByKey("xxx", True)
			Call colOD.AddDocument(Position.doc)
			
			v = Join(ObjPath, {\})
			If (Instr(v, {\}) =0) Then
				key = v & {\}
			Else
				key = v
			End If
			
			Do While (Instr(key, {\}) <> 0)
				key = Strleftback(key, {\})
				Set colODtemp = ViewOD.GetAllDocumentsByKey(key, True)
				If (colODtemp.Count <> 0) Then
					Set docOD = colODtemp.GetFirstDocument
					While (Not (docOD Is Nothing))
						Set docTest = colOD.GetDocument(docOD)
						If (docTest Is Nothing) Then
							Call colOD.AddDocument(docOD)
						End If
						Set docOD = colODtemp.GetNextDocument(docOD)
					Wend
				End If
			Loop
			If (Me.TitleDlg = "") Then
				Me.TitleDlg = {Выберите руководителя}
			End If
			
			Set coll_d = CustomView_PickCollection(colOD, 0, multi, ODStoreUI.db.Server, ODStoreUI.db.FilePath, ViewODName, "Список руководителей", Me.TitleDlg, "")	
			If (coll_d Is Nothing) Then
				Exit Function
			End If
			
			Redim v(0) As String
			Set docOD = coll_d.GetFirstDocument
			While (Not (docOD Is Nothing))
				If (v(0) <> "") Then
					Redim Preserve v(Ubound(v)+1) As String
				End If
				v(Ubound(v)) = docOD.UniversalID
				Set docOD = coll_d.GetNextDocument
			Wend
			If (v(0) = "") Then
				Exit Function
			End If
			
		Case Lcase("SubStaff")
%REM
Надо дописать 2010.10.02
%END REM	
			Select Case Lcase(doc.ValueODTargetBy(0))
			Case Lcase("Current")
				Set ODObj = ODStoreUI.GetObjByValue(session.UserName, ErrorStr)	
			Case Lcase("FormItem")
				ItemName = doc.ValueODTargetByFormItem(0)
				If (ItemName = "") Then
					ErrorStr = {UITask.GetODValue() - Не задано поле для вычисления объекта Орг. директории. UI-запрос "} & Me.Title & {"}
					Exit Function
				End If
				If (Not (docMain.HasItem(ItemName))) Then
					ErrorStr = {UITask.GetODValue() - Не найдено поле "} & ItemName & {" для вычисления объекта Орг. директории. UI-запрос "} & Me.Title & {"}
					Exit Function
				End If
				v = docMain.GetFirstItem(ItemName).Values
				If (Ubound(v) <> 0) Then
					ErrorStr = {UITask.GetODValue() - Значение поля "} & ItemName & {" неоднозначное. UI-запрос "} & Me.Title & {"}
					Exit Function
				End If
				If (Cstr(v(0)) = "") Then
					ErrorStr = {UITask.GetODValue() - Пустое значение поля "} & ItemName & {". UI-запрос "} & Me.Title & {"}
					Exit Function
				End If
				Set ODObj = ODStoreUI.GetObjByValue(Cstr(v(0)), ErrorStr)	
			End Select
			If (ErrorStr <> "") Then
				Exit Function
			End If
			If (ODObj Is Nothing) Then
				Exit Function
			End If
			
			Select Case Lcase(ODObj.myType)
			Case Lcase("User")
				If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
					Exit Function	
				End If
				
				Set Position = Person.GetUserPosition(ErrorStr)
				If (ErrorStr <> "") Then
					Exit Function	
				End If
				If (Position Is Nothing) Then
					Exit Function
				End If
			Case Lcase("Pos")
				Set Position = ODObj
			Case Else
				ErrorStr = {UITask.GetODValue() - Не верный тип объекта Орг. директории. UI-запрос "} & Me.Title & {"}
				Exit Function
			End Select
			
			If (Not(Position.doc.HasItem(PathItemName))) Then
				ErrorStr = {Сбой: UITask.GetODValue() - В документе объекта Орг. директории "} & Position.ObjName & {" нет поля "} & PathItemName & {". UI-запрос "} & Me.Title & {"}
				Exit Function
			End If
			ObjPath = Position.doc.GetFirstItem(PathItemName).Values
			If (ObjPath(0) = "") Then
				ErrorStr = {Сбой: UITask.GetODValue() - Пустое значение в поле "} & PathItemName & {" документа объекта Орг. директории "} & Position.ObjName & {". UI-запрос "} & Me.Title & {"}
				Exit Function
			End If
			
			ViewODName = {(PositionByPath)}
			Set ViewOD = ODStoreUI.db.GetView(ViewODName)
			If (ViewOD Is Nothing) Then
				ErrorStr = {Сбой: UITask.GetODValue() - В Орг. директории не найдено представление "} & ViewODName & {"}
				Exit Function
			End If
			Call ViewOD.Refresh()
			ViewOD.AutoUpdate = False
			
			ViewODName = {PositionByHirerarchy}
			
			key = ObjPath(Ubound(ObjPath))
			
			Set colOD = ViewOD.GetAllDocumentsByKey(key)
			If (Me.TitleDlg = "") Then
				Me.TitleDlg = {Выберите сотрудника}
			End If
			
			Set coll_d = CustomView_PickCollection(colOD, 0, multi, ODStoreUI.db.Server, ODStoreUI.db.FilePath, ViewODName, "Список должностей", Me.TitleDlg, "")	
			If (coll_d Is Nothing) Then
				Exit Function
			End If
			
			Redim v(0) As String
			Set docOD = coll_d.GetFirstDocument
			While (Not (docOD Is Nothing))
				If (v(0) <> "") Then
					Redim Preserve v(Ubound(v)+1) As String
				End If
				v(Ubound(v)) = docOD.UniversalID
				Set docOD = coll_d.GetNextDocument
			Wend
			If (v(0) = "") Then
				Exit Function
			End If
			
			
		End Select
		
		Value = v
		
		GetODValue = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (GetODValue) "UITask" class}
		Resume endh
endh:
	End Function
	
	
	
	
	Property Set Title
		Title_ = Title
	End Property
	Public Property Get Title
		Title = Title_
	End Property
	
	Property Set ValueType
		ValueType_ = ValueType
	End Property
	Public Property Get ValueType
		ValueType = ValueType_
	End Property
	
	Property Set ValueKind
		ValueKind_ = ValueKind
	End Property
	Public Property Get ValueKind
		ValueKind = ValueKind_
	End Property
	
	Property Set ItemName
		ItemName_ = ItemName
	End Property
	Public Property Get ItemName
		ItemName = ItemName_
	End Property
	
	Property Set TitleDlg
		TitleDlg_ = TitleDlg
	End Property
	Public Property Get TitleDlg
		TitleDlg = TitleDlg_
	End Property
	
	Property Set Condition
		Condition_ = Condition
	End Property
	Public Property Get Condition
		Condition = Condition_
	End Property
	
	Property Set IsMultiChoice
		IsMultiChoice_ = IsMultiChoice
	End Property
	Public Property Get IsMultiChoice
		IsMultiChoice = IsMultiChoice_
	End Property
	
	Property Set Value
		Value_ = Value
	End Property
	Public Property Get Value
		Value = Value_
	End Property
	
	Property Set IsRun
		IsRun_ = IsRun
	End Property
	Public Property Get IsRun
		IsRun = IsRun_
	End Property
	
	Sub delete()
	End Sub
	
End Class



Class PopUpStore
	Private docUI As NotesUIDocument
	Sub new(docUI As NotesUIDocument)
		Set Me.docUI = docUI
	End Sub
	
	Function SetUp(docMain As NotesDocument, ValueItemName As String, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim menu As PopupMenu
		Dim subMenu As PopupMenu
		
		Dim v As Variant
		Dim PopUpList List As PopUp
		Dim PopUp As PopUp
		Dim PopUpSub As PopUp
		Dim ProcessList List As PopUp
		
		Dim Title As String
		Dim ID As String
		
		Dim vVal As Variant
		Dim vTemp As Variant
		Dim i As Integer
		Dim ub As Integer, lb As Integer
		Dim IsSingle As Integer
		Dim key As String
		
		Dim sSelPopup As String
		
		If Not docMain.HasItem(ValueItemName) Then
			ErrorStr = {Не найдено поле "} & ValueItemName & {"}
			Exit Function
		End If
		
		v = docmain.GetFirstItem(ValueItemName).Values
		If (Cstr(v(0))="") Then
			ErrorStr = {Нет значений в поле "} & ValueItemName & {"}
			Exit Function
		End If
		
		Forall x In v
			ID = Strrightback(x, {$$$})
			Title = Strleftback(x, {$$$})
			
			If (Instr(Title, {/}) <> 0) Then
				vVal = Split(Title, {/})
				IsSingle = 0
			Else
				Redim vTemp(0)
				vTemp(0) = Title
				vVal = vTemp
				IsSingle = 1
			End If
			ub = Ubound(vVal)
			lb = Lbound(vVal)
			
			For i=ub To lb Step -1
				Select Case IsSingle
				Case 0 : key = vVal(i)
				Case 1 : key = vVal(i) & {$} & ID
				End Select
				
				If Not Iselement(ProcessList(key)) Then
					Set PopUp = New PopUp
					PopUp.Title = vVal(i)
					
					If (Not (PopUpSub Is Nothing)) Then
						Select Case PopUpSub.IsParent
						Case 1 : Set PopUp.ChildCol(PopUpSub.Title) = PopUpSub
						Case 0 : Set PopUp.ChildCol(PopUpSub.Title & {$} & PopUpSub.Value) = PopUpSub
						End Select
					End If
					
					If (i = ub) Then
						PopUp.IsParent = 0
						PopUp.Value = ID
						key = PopUp.Title & {$} & PopUp.Value
						If (ub <> 0) Then
							Set PopUpSub = New PopUp
							Set PopUpSub = PopUp
						End If
					Else
						PopUp.IsParent = 1
						key = PopUp.Title
						If (i <> lb) Then
							Set PopUpSub = New PopUp
							Set PopUpSub = PopUp
						End If
					End If	
					
					Set ProcessList(key) = New PopUp
					Set ProcessList(key) = PopUp					
				Else
					Set PopUp = ProcessList(key)
					
					If (Not (PopUpSub Is Nothing)) Then
						Select Case PopUpSub.IsParent
						Case 1 : Set PopUp.ChildCol(PopUpSub.Title) = PopUpSub
						Case 0 : Set PopUp.ChildCol(PopUpSub.Title & {$} & PopUpSub.Value) = PopUpSub
						End Select
					End If
					If (i <> lb) Then
						Set PopUpSub = New PopUp
						Set PopUpSub = PopUp
					End If
				End If
			Next
			Set PopUpSub = Nothing
			Set PopUpList(key) = New PopUp
			Set PopUpList(key) = PopUp
		End Forall
		Erase ProcessList
		Set PopUp = Nothing
		
		Set menu = New PopupMenu
		Forall P In PopUpList
			Select Case P.Value
			Case "" :
				Set subMenu = New PopupMenu
				Forall PSub In P.ChildCol
					If (GetPopUpTree(subMenu, PSub, ErrorStr) <> 1) Then
						Exit Function
					End If
				End Forall
				Call menu.AppendSubMenu(subMenu, P.Title)
			Case Else :
				Select Case P.Title
				Case "separator" : Call menu.AppendSeparator
				Case Else : Call menu.AppendItem(P.Title)
				End Select
			End Select
		End Forall
		If (menu.ItemCount=0) Then
			Exit Function
		End If
		
		sSelPopup = menu.ShowAsAction
		If (sSelPopup = "") Then
			SetUp =1
			Exit Function
		End If
		vVal = menu.GetSelectedPosition
		
		ub = Ubound(vVal)
		lb = Lbound(vVal)
		
		For i=lb To ub
			If (i = 0) Then
				If (GetSelectedPopUp(vVal(i), PopUpList, PopUp, ErrorStr) <> 1) Then
					If (ErrorStr = "") Then
						ErrorStr = {Ошибка: Не определен ID Pop-Up кнопки}
					End If
					Exit Function
				End If
				If (PopUp Is Nothing) Then
					ErrorStr = {Ошибка: Не определен ID Pop-Up кнопки}
					Exit Function
				End If
			Else
				If (GetSelectedPopUp(vVal(i), PopUp.ChildCol, PopUp, ErrorStr) <> 1) Then
					If (ErrorStr = "") Then
						ErrorStr = {Ошибка: Не определен ID Pop-Up кнопки}
					End If
					Exit Function
				End If
				If (PopUp Is Nothing) Then
					ErrorStr = {Ошибка: Не определен ID Pop-Up кнопки}
					Exit Function
				End If
			End If
		Next
		
		Set PopUp.docUI = Me.docUI
		If (PopUp.CheckAccess(docMain, ErrorStr) <> 1) Then
			Exit Function
		End If
		
		If (PopUp.SetUp(docMain, ErrorStr) <> 1) Then
			Exit Function
		End If
		
		Print "Кнопка успешно отработала"
		
		SetUp =1
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (SetUp) "PopUpStore" class}
		Resume endh
endh:
	End Function
	
	
	Function GetPopUpTree(menu As PopupMenu, PopUp As PopUp, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim subMenu As PopupMenu
		
		Select Case PopUp.Value
		Case "" :
			Set subMenu = New PopupMenu
			Forall PSub In PopUp.ChildCol
				If (GetPopUpTree(subMenu, PSub, ErrorStr) <> 1) Then
					Exit Function
				End If
			End Forall
			Call menu.AppendSubMenu(subMenu, PopUp.Title)
		Case Else :
			Select Case PopUp.Title
			Case "separator" : Call menu.AppendSeparator
			Case Else : Call menu.AppendItem(PopUp.Title)
			End Select
		End Select
		
		GetPopUpTree = 1
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (GetPopUpTree) "PopUpStore" class}
		Resume endh
endh:
	End Function
	
	Function GetSelectedPopUp(iValue As Integer, PopUpList As Variant, PopUp As PopUp, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim i As Integer
		i=1
		Forall P In PopUpList
			If (iValue = i) Then
				Set PopUp = P
				GetSelectedPopUp = 1
				Exit Forall
			End If
			i=i+1
		End Forall
		
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (GetPopUpID) "PopUpStore" class}
		Resume endh
endh:
	End Function
	
	
	Sub delete()
	End Sub
End Class


Class PopUp
	Title_ As String
	Value_ As String
	IsParent_ As Integer
	key_ As String
	Public docUI As NotesUIDocument
	Public db As NotesDatabase
	Public doc As NotesDocument
	Public ChildCol List As PopUp
	'Public View As NotesView
	
	Public dbPC As NotesDatabase
	Public ODStoreUI As ODStoreUI
	
	Sub new()
	End Sub
	
	Function Init(doc As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Set Me.doc = doc
		Set Me.db = doc.ParentDatabase
		Me.Title = doc.Name(0)
		Me.Value = doc.UniversalID
		
		Init = 1
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (Init) "PopUp" class}
		Resume endh
endh:	
	End Function
	
	Function CheckAccess(docMain As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim col As NotesDocumentCollection
		Dim docCondition As NotesDocument
		Dim View As NotesView
		Dim v As Variant
		Dim checkType As String
		Dim EditMode As String
		Dim sFormula As String
		Dim sMessage As String
		
		If (docMain Is Nothing) Then
			ErrorStr = {Ошибка: PopUp.CheckAccess() - docMain Is Nothing. Pop-Up кнопка "} & Me.Title & {"}
			Exit Function
		End If
		If (Me.doc Is Nothing) Then
			If (Me.Value = "") Then
				ErrorStr = {Не определен ID Pop-Up кнопки "} & Me.Title & {"}
				Exit Function
			End If
			On Error 4091 Resume Next 'bad unid
			Set Me.doc = docMain.ParentDatabase.GetDocumentByUNID(Me.Value)
			On Error Goto errh
			If (Me.doc Is Nothing) Then
				ErrorStr = {Нет найден документ Pop-Up кнопки "} & Me.Title & {"}
				Exit Function
			End If
			Set Me.db = docMain.ParentDatabase
		End If
		
		Set View = Me.db.GetView("Pop-upСondition")
		If (View Is Nothing) Then
			ErrorStr = {Не найдено представление "Pop-upСondition". Pop-Up кнопка "} & Me.Title & {"}
			Exit Function
		End If
		Call View.Refresh()
		View.AutoUpdate = False
		
		Set col = Me.GetCollection(Me.doc.UniversalID, View, ErrorStr)
		If (ErrorStr <> "") Then
			Exit Function
		End If
		If (col Is Nothing) Then
			CheckAccess = 1
			Exit Function
		End If
		If (col.Count = 0) Then
			CheckAccess = 1
			Exit Function
		End If
		
		Set docCondition = col.GetFirstDocument
		While (Not (docCondition Is Nothing))
			
			sMessage = docCondition.Message(0)
			If (sMessage = "") Then
				ErrorStr = {Не указано сообщение при не выполнении условия Pop-Up кнопки "} & Me.Title & {"}
				Exit Function
			End If
			
			checkType = docCondition.Type(0)
			Select Case checkType
			Case "EditMode"
				EditMode = docCondition.EditMode(0)
				If (EditMode = "") Then
					ErrorStr = {Не указана Режим документа условия выполнения Pop-Up кнопки "} & Me.Title & {"}
					Exit Function
				End If
				
				Select Case EditMode
				Case "Edit"
					If (Not docUI.EditMode) Then
						ErrorStr = sMessage
						Exit Function	
					End If
				Case "Read"
					If docUI.EditMode Then
						ErrorStr = sMessage
						Exit Function	
					End If
				End Select
				
			Case "@"
				sFormula = docCondition.Formula(0)	
				If (sFormula = "") Then
					ErrorStr = {Не указана @-формула условия выполнения Pop-Up кнопки "} & Me.Title & {"}
					Exit Function
				End If
				
				v = Evaluate(sFormula, docMain)
				If (Cstr(v(0)) = "1") Then
					ErrorStr = sMessage
					Exit Function	
				End If	
				
			End Select
			
			Set docCondition = col.GetNextDocument(docCondition)
		Wend
		
		CheckAccess = 1
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (CheckAccess) "PopUp" class}
		Resume endh
endh:
	End Function
	
	Function SetUp(docMain As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim ws As New NotesUIWorkspace
		Dim session As New NotesSession
		Dim db As NotesDatabase
		Dim dbPC As NotesDatabase
		Dim ODObj As ODObj
		Dim Person As New Person
		Dim Position As ODObj
		Dim TaskInitObj As ODObj
		Dim docNewMain As NotesDocument
		Dim ViewID As NotesView
		Dim ID As String
		Dim docClaim As NotesDocument
		
		Dim v As Variant
		Dim InitObjID As String
		'Dim docMail As NotesDocument
		Dim docMailList List As NotesDocument
		
		Dim PopUpActionValue List As PopUpActionValue
		
		Set Me.db = session.CurrentDatabase
		v = docMain.dbPCPath(0)
		If (v = "") Then
			ErrorStr = {В документе не задан Центр Обработки}
			Exit Function
		End If
		If (DWFSGetDatebase(Cstr(v), Me.dbPC) <> 1)Then
			ErrorStr = {Не найдена база Центра Обработки}
			Exit Function	
		End If
		
		v = docMain.dbODPath(0)
		If (v = "") Then
			ErrorStr = {В документе не задана Орг. директория}
			Exit Function
		End If
		
		Set Me.ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
		If (ErrorStr <> "") Then
			Exit Function	
		End If
		
		Set ViewID = Me.db.GetView("(UNID)")
		If (ViewID Is Nothing) Then
			ErrorStr = {Не найдено представление "(UNID)"}
			Exit Function	
		End If
		
		Dim mainUnid As String, doClose As Boolean, oldEditMode As Variant
		mainUnid = docMain.Universalid

		If (Me.ProcessPopUpActions(docMain, docMailList, PopUpActionValue, ErrorStr) <> 1) Then
			Exit Function
		End If
		
		doClose = False
		If Not(ws.Currentdocument Is Nothing)Then
			If(ws.currentdocument.Document.Universalid = mainUnid And ws.currentdocument.Editmode)Then
				If CStr(ws.currentdocument.Document.isAdditionExpertise(0)) <> "2" Then ' для доп. экспертизы версии 2 - не переоткрывать документ
					doClose = True
					oldEditMode = ws.Currentdocument.Editmode

					Call session.SetEnvironmentVar("DWFSaveUNID", ws.currentdocument.Document.UniversalID)
					
					Call ws.currentDocument.Save()
					Call ws.Currentdocument.Close(True)					
				End If
			End If
		End If
		
		Forall docMail In docMailList
			docMail.Form 		= "Task"
			docMail.Action 	= "PopUpAction"
			docMail.InitServer 	= Me.db.Server
			docMail.AppPath 	= Me.db.FilePath
			docMail.docMainID 	= mainUnid
			docMail.PopUpID	= Me.doc.UniversalID
			docMail.PopUpName	= Me.doc.Name(0)
			
			docMail.UserName 	= session.UserName
			
			Call docMail.Save(True, True)
			If (DWFAAskForAction(docMail) <> 1) Then
				Exit Function	
			End If
			
			If (docMail.Error(0) <> "") Then
				Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'				Call docMail.Remove(True)
				Exit Function	
			End If
			
			If (docMail.IsOpenDocument(0) = "yes") Then
				
				On Error 4091 Resume Next 'bad unid
				Set docNewMain = Me.db.GetDocumentByUNID(docMail.docMainUNID(0))
				If (docNewMain Is Nothing) Then
					Msgbox {Ошибка при инициации процесса: docMain Is Nothing}, 48, ERR_MSG_TITLE
					Exit Function	
				End If
				
				If (DWFAClaim(docNewMain) <> 1) Then
					Exit Function
				End If
				
				Call ViewID.Refresh()
				ViewID.AutoUpdate = False
				
				ID = docNewMain.UniversalID
				Set docClaim = ViewID.GetDocumentByKey(ID)
				
				Call ws.EditDocument(True, docClaim)
			End If
			
		End ForAll
		
		If(doClose)Then
			If Not(docMain Is Nothing)Then Delete docMain
			Set docMain = me.db.Getdocumentbyunid(mainUnid)
			Call ws.Editdocument(oldEditMode, docMain)
		End If
		
		
		SetUp = 1
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (SetUp) "PopUp" class}
		Resume endh
endh:
	End Function
	
	
	Function ProcessPopUpActions(docMain As NotesDocument, docMailList List As NotesDocument, PopUpActionValue List As PopUpActionValue, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim colAction As NotesDocumentCollection
		Dim docAction As NotesDocument
		Dim PopUpAction As PopUpAction
		Dim docMail As NotesDocument
		Dim View As NotesView
		
		
		Set View = Me.db.GetView("Pop-upAction")
		If (View Is Nothing) Then
			ErrorStr = {Не найдено представление "Pop-upAction". Pop-Up кнопка "} & Me.Title & {"}
			Exit Function
		End If
		Call View.Refresh()
		View.AutoUpdate = False
		
		Set colAction = Me.GetCollection(Me.doc.UniversalID, View, ErrorStr)
		If (ErrorStr <> "") Then
			Exit Function
		End If
		If (colAction Is Nothing) Then
			ErrorStr = {Для кнопки "} & Me.Title & {" не указан список действий}
			Exit Function
		End If
		If (colAction.Count = 0) Then
			ErrorStr = {Для кнопки "} & Me.Title & {" не указан список действий}
			Exit Function
		End If
		
		Set docAction = colAction.GetFirstDocument
		While (Not (docAction Is Nothing))
			
			Set PopUpAction = New PopUpAction
			If (PopUpAction.Init(docAction, ErrorStr) <>1) Then
				Exit Function
			End If
			
			'для каждого действия Pop-Up кнопки свой запрос в ЦО
			Set docMail = Me.dbPC.CreateDocument
			docMail.PopUpActionID = docAction.UniversalID
			docMail.PopUpActionNumber = docAction.Number(0)
			
			If (PopUpAction.SetUp(docMain, Me.ODStoreUI, docMail, ErrorStr) <> 1) Then
				Exit Function
			End If
			If (Lcase(PopUpAction.Actiontype) <> Lcase("RunLotusScript")) Then
				Call docMail.ReplaceItemValue(docAction.UniversalID & {$Type}, PopUpAction.Actiontype)
				Call docMail.ReplaceItemValue(docAction.UniversalID & {$Value}, PopUpAction.Value)
				
				Set docMailList(docMail.UniversalID) = docMail
			End If
			
			Set docAction = colAction.GetNextDocument(docAction)
		Wend
		
		
		ProcessPopUpActions = 1
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (ProcessActions) "PopUp" class}
		Resume endh
endh:
	End Function
	
	
	Function GetCollection(Key As String, View As NotesView, ErrorStr As String) As NotesDocumentCollection
		On Error Goto errh
		
		Dim col As NotesDocumentCollection
		Dim doc As NotesDocument
		Dim SortList List As NotesDocument
		Dim SortNum As String
		Dim docTest As NotesDocument
		Dim v As Variant
		Dim MaxEmpty As Integer
		
		
		Set col = View.GetAllDocumentsByKey(Key)
		If (col.Count = 0) Then
			Exit Function
		End If
		
		Redim v(0) As Variant
		MaxEmpty = 1001
		Set doc = col.GetFirstDocument
		While (Not (doc Is Nothing))
			SortNum = Cstr(doc.Number(0))
			If (SortNum = "") Then
				SortNum = Cstr(MaxEmpty)
				MaxEmpty = MaxEmpty+1
			End If
			If (Cstr(v(0)) <> "") Then
				Redim Preserve v(Ubound(v)+1) As Variant
			End If
			On Error Goto break
			v(Ubound(v)) = Cint(SortNum)
			On Error Goto errh
			Set SortList(SortNum) = doc
getnext:
			Set doc = col.GetNextDocument(doc)
		Wend
		v = Arrays_Sort(v, 1)
		Set col = View.GetAllDocumentsByKey("xxx")
		Forall ID In v
			Set doc = SortList(ID)
			If (Not (doc Is Nothing)) Then
				Set docTest = col.GetDocument(doc)
				If (docTest Is Nothing) Then
					Call col.AddDocument(doc)	
				End If
			End If
		End Forall
		If (col.Count = 0) Then
			Exit Function
		End If
		
		Set GetCollection = col
		Exit Function
break:		
		Print "++++++++++++++++++++++++++++"
		Print {Не верный формат сортировочных данных (в документе "Action Pop-Up кнопки"): UNID=} & doc.UniversalID &	{; Name=} & doc.Name(0)
		Print "++++++++++++++++++++++++++++"
		Resume getnext
		
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (GetCollection) "PopUp" class}
		Resume endh
endh:
	End Function
	
	
	Property Set Title
		Title_ = Title
	End Property
	Property Get Title
		Title = Title_
	End Property
	
	Property Set Value
		Value_ = Value
	End Property
	Property Get Value
		Value = Value_
	End Property
	
	Property Set IsParent
		IsParent_ = IsParent
	End Property
	Property Get IsParent
		IsParent = IsParent_
	End Property
	
	Property Set key
		key_ = key
	End Property
	Property Get key
		key = key_
	End Property
	
	Sub delete()
	End Sub
End Class
Class PopUpAction
	Title_ As String
	Actiontype_ As String
	Value_ As Variant
	Public doc As NotesDocument
	Public db As NotesDatabase
	
	Sub new()
	End Sub
	
	
	Function Init(doc As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Set Me.doc = doc
		Set Me.db = doc.ParentDatabase
		Me.Title = doc.Name(0)
		Me.Actiontype = doc.Type(0)
		
		Init = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (Init) "PopUpAction" class}
		Resume endh
endh:
	End Function
	
	Function SetUp(docMain As NotesDocument, ODStoreUI As ODStoreUI, docMail As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Select Case Lcase(Me.Actiontype)
			Case Lcase("InitProcess")
				If (Me.InitProcess(docMain, ODStoreUI, docMail, ErrorStr) <> 1) Then
					Exit Function	
				End If
			Case Lcase("ODObjAdd")
				If (Me.ODObjAdd(docMain, ODStoreUI, docMail, ErrorStr) <> 1) Then
					Exit Function	
				End If
			Case Lcase("ODObjRemove")
				If (Me.ODObjRemove(docMain, ODStoreUI, docMail, ErrorStr) <> 1) Then
					Exit Function	
				End If
			Case Lcase("SendMessage")
				
			Case Lcase("DirectoryAdd")
				
			Case Lcase("DirectoryRemove")
				
			Case Lcase("AddReaderAdd")
				If (Me.AddReaderAdd(docMain, ODStoreUI, docMail, ErrorStr) <> 1) Then
					Exit Function	
				End If
			Case Lcase("RunLotusScript")
				If (Me.RunLotusScript(docMain, ODStoreUI, docMail, ErrorStr) <> 1) Then
					Exit Function	
				End If
		End Select
		
		SetUp = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (SetUp) "PopUpAction" class}
		Resume endh
endh:	
	End Function
	
	Function InitProcess(docMain As NotesDocument, ODStoreUI As ODStoreUI, docMail As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim session As New NotesSession
		Dim View As NotesView
		Dim colProcInitSet As NotesDocumentCollection
		Dim docProcInitSet As NotesDocument
		Dim IsOpenDocument As String
		Dim v As Variant
		
		Dim dbProcess As NotesDatabase
		Dim docProcess As NotesDocument
		Dim docProcessList List As NotesDocument
		Dim sServer As String, sFilePath As String, sReplicaID As String, ID As String
		
		Dim ODObj As ODObj
		Dim Person As New Person
		Dim Position As ODObj
		Dim InitObjID As String
		
		Dim UITaskValueList List As UITaskValue
		
		
		Set View = db.GetView("InitOtherProcess")
		If (View Is Nothing) Then
			ErrorStr = {Не найдено представление "InitOtherProcess". Action Pop-Up кнопки "} & Me.Title & {"}
			Exit Function
		End If
		
		Set colProcInitSet = View.GetAllDocumentsByKey(Me.doc.UniversalID)
		If (colProcInitSet.Count = 0) Then
			ErrorStr = {Не найдено документов "Инициация др. процесса". Action Pop-Up кнопки "} & Me.Title & {"}
			Exit Function
		End If
		
		Set docProcInitSet = colProcInitSet.GetFirstDocument
		Redim v(0) As String
		While (Not (docProcInitSet Is Nothing))
			If (Cstr(v(0)) <> "") Then
				Redim v(Ubound(v)+1) As String	
			End If
			v(Ubound(v)) = docProcInitSet.UniversalID
			
			sServer = docProcInitSet.ProcessServer(0)
			sFilePath = docProcInitSet.ProcessFilePath(0)
			If docProcInitSet.Hasitem("ProcessReplicaID") Then
				sReplicaID = docProcInitSet.Getitemvalue("ProcessReplicaID")(0) 
			End If
			ID = docProcInitSet.ProcessID(0)
			IsOpenDocument = docProcInitSet.IsOpenDocument(0)
			
			If ( sReplicaID <> "" ) Then
				'<patch Get db by replica id; 2016.02.04; Tambiev>
				sServer = docProcInitSet.Parentdatabase.Server
				If (DWFSGetDatebaseOnServer( sServer, sReplicaID, dbProcess ) <> 1) Then
					GoTo getbypath
				End If
				'</patch>
			Else
getbypath:
				If (DWFSGetDatebaseOnServer( sServer, sFilePath, dbProcess ) <> 1) Then
					Exit Function
				End If	
			End If
			
			On Error 4091 Resume Next 'bad unid
			Set docProcess = dbProcess.GetDocumentByUNID(ID)
			If (docProcess Is Nothing) Then
				ErrorStr = {Не найден документ процесса "} & docProcInitSet.ProcessName(0) & {"}
				Exit Function
			End If
			Set docProcessList(docProcess.UniversalID) = docProcess
			
			Set docProcInitSet = colProcInitSet.GetNextDocument(docProcInitSet)
		Wend
		Me.Value = v
		
		'получение должности пользователя
		Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
		If (ErrorStr <> "") Then
			Exit Function	
		End If
		If (ODObj Is Nothing) Then
			Exit Function
		End If
		If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
			Exit Function	
		End If
		
		Set Position = Person.GetUserPosition(ErrorStr)
		If (ErrorStr <> "") Then
			Exit Function	
		End If
		If (Position Is Nothing) Then
			Exit Function
		End If
		
		Forall docPr In docProcessList
			'получение инфы от имени кого инициирует
			If (DWFAGetObjIDByProcessItem(docPr, "ProcessInitiator", ODStoreUI, {Инициировать процесс "} & docPr.Name(0) & {"}, InitObjID) <> 1) Then
				Exit Function	
			End If
			If (Not Isarray(InitObjID)) Then
				If (InitObjID = "<anybody>") Then
					InitObjID = Position.ObjAccess
				End If
			End If
			
			If (DWFACheckUITask(docPr, Nothing, UITaskValueList) <>1) Then
				Exit Function
			End If
			
			docMail.ProcessID 	= docPr.UniversalID
			docMail.InitObjID 	= InitObjID
			docMail.InitPosID 	= Position.ObjAccess 
			docMail.IsOpenDocument = IsOpenDocument
			
			Forall x In UITaskValueList
				Call docMail.ReplaceItemValue(Listtag(x) & {$IsRun}, x.isrun)
				Call docMail.ReplaceItemValue(Listtag(x) & {$Type}, x.valuetype)
				Call docMail.ReplaceItemValue(Listtag(x) & {$Value}, x.value)
			End Forall
		End Forall
		
		
		InitProcess = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (InitProcess) "PopUpAction" class}
		Resume endh
endh:	
	End Function
	
	
	Function ODObjAdd(docMain As NotesDocument, ODStoreUI As ODStoreUI, docMail As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim ws As New NotesUIWorkspace
		Dim db As NotesDatabase
		Dim colOD As NotesDocumentCollection
		Dim docOD As NotesDocument
		Dim docTemp As NotesDocument
		
		Dim multi As Boolean
		Dim IsSetObjType As String
		Dim ObjType As String
		Dim Title As String
		
		Dim v As Variant
		
		Select Case Me.doc.ODAddIsMultiChoice(0)
			Case "yes" : multi = True
			Case "no" : multi = False
		End Select
		IsSetObjType = Me.doc.ODAddIsSetODObjType(0)
		ObjType = Me.doc.ODAddObjType(0)
		Title = Me.doc.ODAddTitle(0)
		
		Select Case IsSetObjType
			Case "yes"
				If (ODStoreUI.PickObject(ObjType, multi, "", colOD, ErrorStr) <>1) Then
					Exit Function
				End If
			Case "no"
				Set db = Me.doc.ParentDatabase
				Set docTemp = db.CreateDocument
				If Not (ws.DialogBox("DWF103", True, True, False, False, False, False, db.Title, docTemp, True, False, True)) Then
					Exit Function
				End If
				
				If (ODStoreUI.PickObject(Cstr(docTemp.List(0)), multi, "", colOD, ErrorStr) <>1) Then
					Exit Function
				End If
		End Select
		
		Redim v(0) As String
		Set docOD = colOD.GetFirstDocument
		While (Not (docOD Is Nothing))
			If (Cstr(v(0)) <> "") Then
				Redim Preserve v(Ubound(v)+1) As String
			End If
			v(Ubound(v)) = docOD.UniversalID
			Set docOD = colOD.GetNextDocument(docOD)
		Wend
		If (Cstr(v(0)) = "") Then
			ErrorStr = "Ошибка при формировании списка значений"
			Exit Function
		End If
		
		Me.Value = v
		
		ODObjAdd = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (ODObjAdd) "PopUpAction" class}
		Resume endh
endh:	
	End Function
	
	
	Function ODObjRemove(docMain As NotesDocument, ODStoreUI As ODStoreUI, docMail As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim ws As New NotesUIWorkspace
		Dim db As NotesDatabase
		Dim v As Variant
		Dim docTemp As NotesDocument
		Dim ObjAccess As Variant, ObjID As Variant, ObjName As Variant, ObjPath As Variant
		Dim i As Integer
		Dim Form As String
		
		Dim ItemPrefix As String
		Dim multi As Boolean
		
		
		ItemPrefix = doc.ODRemoveItemName(0)
		If (ItemPrefix = "") Then
			ErrorStr = {Не указано "Наименование поля" в Pop-Up Action'е "} & Me.Title & {"}
			Exit Function
		End If
		Select Case Me.doc.ODAddIsMultiChoice(0)
			Case "yes" : multi = True
			Case "no" : multi = False
		End Select
		
		Set db = doc.ParentDatabase
		v = ODStoreUI.GetObjectValueByItem(docMain, ItemPrefix, ObjAccess, ObjID, ObjName, ObjPath, ErrorStr)
		If (ErrorStr <> "") Then
			Exit Function
		End If
		If (v = 0) Then
			Exit Function
		End If
		
		If (Ubound(ObjID) = 0) Then
			Me.Value = ObjID(0)
			ODObjRemove = 1
			Exit Function
		End If
		
		Set docTemp = db.CreateDocument
		Redim v(0) As String
		For i=0 To Ubound(ObjID)
			If (v(0) <> "") Then
				Redim Preserve v(Ubound(v)+1) As String
			End If
			v(Ubound(v)) = ObjName(i) & {|} & ObjID(i)
		Next
		docTemp.Members = v
		docTemp.promt = "Выберите значение для удаления"
		
		If (multi = True) Then
			Form = "DWF105"
		Else
			Form = "DWF104"
		End If
		
		If Not (ws.DialogBox(Form, True, True, False, False, False, False, db.Title, docTemp, True, False, True)) Then
			Exit Function
		End If
		If (docTemp.List(0) = "") Then
			Exit Function
		End If
		
		Me.Value = docTemp.List
		
		ODObjRemove = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (ODObjRemove) "PopUpAction" class}
		Resume endh
endh:	
	End Function
	
	
	
	Function AddReaderAdd(docMain As NotesDocument, ODStoreUI As ODStoreUI, docMail As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim ws As New NotesUIWorkspace
		Dim db As NotesDatabase
		Dim colOD As NotesDocumentCollection
		Dim docOD As NotesDocument
		Dim docTemp As NotesDocument
		
		Dim DataSource As String
		Dim FormItemPrefix As String
		Dim multi As Boolean
		Dim IsSetObjType As String
		Dim ObjType As String
		Dim Title As String
		
		Dim v As Variant
		
		Select Case Lcase(Me.doc.AddReaderAddDataSource(0))
			Case Lcase("dialog")
				
				Select Case Me.doc.AddReaderAddIsMultiChoice(0)
				Case "yes" : multi = True
				Case "no" : multi = False
			End Select
				IsSetObjType = Me.doc.AddReaderAddIsSetODObjType(0)
				ObjType = Me.doc.AddReaderAddObjType(0)
				Title = Me.doc.AddReaderAddTitle(0)
				
				Select Case IsSetObjType
				Case "yes"
					If (ODStoreUI.PickObject(ObjType, multi, "", colOD, ErrorStr) <>1) Then
						Exit Function
					End If
				Case "no"
					Set db = Me.doc.ParentDatabase
					Set docTemp = db.CreateDocument
					If Not (ws.DialogBox("DWF103", True, True, False, False, False, False, db.Title, docTemp, True, False, True)) Then
						Exit Function
					End If
					
					If (ODStoreUI.PickObject(Cstr(docTemp.List(0)), multi, "", colOD, ErrorStr) <>1) Then
						Exit Function
					End If
			End Select
				
				Redim v(0) As String
				Set docOD = colOD.GetFirstDocument
				While (Not (docOD Is Nothing))
					If (Cstr(v(0)) <> "") Then
						Redim Preserve v(Ubound(v)+1) As String
					End If
					v(Ubound(v)) = docOD.UniversalID
					Set docOD = colOD.GetNextDocument(docOD)
				Wend
				If (Cstr(v(0)) = "") Then
					ErrorStr = "Ошибка при формировании списка значений"
					Exit Function
				End If
				
			Case Lcase("ItemOnForm")
				FormItemPrefix = Me.doc.AddReaderAddItemName(0)
				
				If (FormItemPrefix = "") Then
					ErrorStr = {Не задан префикс поля на форме. PopUp Action "} & Me.title & {"}
					Exit Function	
				End If
				
				If (Not docMain.HasItem(FormItemPrefix & "ObjAccess")) Then
					ErrorStr = {На форме не найдено поле с префиксом "} & FormItemPrefix & {". PopUp Action "} & Me.title & {"}
					Exit Function
				End If
				
				v = docMain.GetFirstItem(FormItemPrefix & "ObjAccess").Values
				
			Case Else
				ErrorStr = {Источник даных ОД: не известный формат. Action Pop-Up кнопки "} & Me.Title & {"}
				Exit Function
		End Select
		
		
		Me.Value = v
		
		
		AddReaderAdd = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (AddReaderAdd) "PopUpAction" class}
		Resume endh
endh:	
	End Function
	
	
	Function RunLotusScript(docMain As NotesDocument, ODStoreUI As ODStoreUI, docMail As NotesDocument, ErrorStr As String) As Integer
		On Error Goto errh
		
		Dim script As String
		
		script = Me.doc.script(0)
		If (script = "") Then
			Msgbox {Нет скрипта в Action Pop-Up кнопки "} & Me.Title & {"}, 48, {Операция остановлена}
			Exit Function
		End If
		
		Execute Script
		
		If (ReturnResult = -1) Then
			Exit Function
		End If
		
		RunLotusScript = 1
		
		Exit Function
errh:
		Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (RunLotusScript) "PopUpAction" class}
		Resume endh
endh:	
	End Function
	
	
	Property Set Title
		Title_ = Title
	End Property
	Property Get Title
		Title = Title_
	End Property
	
	Property Set Actiontype
		Actiontype_ = Actiontype
	End Property
	Property Get Actiontype
		Actiontype = Actiontype_
	End Property
	
	Property Set Value
		Value_ = Value
	End Property
	Property Get Value
		Value = Value_
	End Property
	
	
	Sub delete()
	End Sub
End Class

'%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
'%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Class AdditionAction
	Public doc As NotesDocument
	Public docParent As NotesDocument
	
	Title_ As String
	ValueType_ As String
	Condition_ As String
	
	Sub New()
	End Sub
	
	Function Init(doc As NotesDocument, ErrorStr As String) As Integer
		On Error GoTo errh
		Dim db As NotesDatabase
		Dim ParentRef As String
		
		ParentRef = doc.GetItemValue("ParentRef")(0)
		
		Set Me.doc 		= doc
		Me.Title 			= doc.GetItemValue("Name")(0)
		Me.ValueType 		= doc.GetItemValue("ValueType")(0)
		Me.Condition 		= doc.GetItemValue("Condition")(0)
		
		Set db  = doc.ParentDatabase
		On Error 4091 Resume Next 'bad unid
		Set docParent = db.GetDocumentByUNID(ParentRef)
		On Error GoTo errh
		If (docParent Is Nothing) Then
			ErrorStr = {Сбой: Ошибка в процессе (Для доп. действия с описанием "} & Me.Title & {" не найден родительский документ)}
			Exit Function
		End If
		
		
		Init =1
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (Init) "AdditionAction" class}
		Resume endh
endh:
	End Function
	
	
	Function SetUp(docMain As NotesDocument, ErrorStr As String) As Integer
		On Error GoTo errh
		
		Dim db As NotesDatabase
		Dim v As Variant

		
		Set db = Me.doc.ParentDatabase
		
		On Error GoTo errFormula
		v = Evaluate(Me.Condition, docMain)
		On Error GoTo errh
		If (CStr(v(0)) <> "1") Then
			Exit Function
		End If
		
		Select Case LCase(Me.ValueType) 
			Case LCase("RunAgent")
				Dim runType As String
				runType = me.doc.getItemValue("AgentRunType")(0)
				If(runType <> "client")Then ' запускаемся, только если указано клиент
					setUp = 1
					Exit Function
				End If
				
				Dim agent As NotesAgent, agentname As String 
				agentname = Me.doc.AgentName(0)
				If ( agentname = "" ) Then
					ErrorStr = {Сбой: Не задано наименование агента для запуска. Доп. действие "} & Me.Title & {"}
					Exit Function
				End If
				Set agent = db.Getagent( agentname )
				If ( agent Is Nothing ) Then
					ErrorStr = {Сбой: Не найден агент "} & agentname & {"} & Me.Title & {"}
					Exit Function
				End If

				'WARNING
				'возможно костыль. возможно нет. ещё не уверен. сначала добавил, но потом скрыл. (c)agalko
				'If(docMain.Isnewnote)Then Call docMain.save(False, False) 'тут, конечно, он не должен так делать. но надо, иначе смысла нет в этом действии.
				
				Call agent.run(docMain.Noteid) 
				
		End Select

		
		SetUp =1
		Exit Function
errFormula:		
		ErrorStr = {Ошибка при вычислении условия выполнения для доп. действия "} & Me.Title & {"; Стадия: "} & Me.docParent.Name(0) & {"}
		Resume endh
		
		Exit Function	
errh:
		ErrorStr = Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (SetUp) "AdditionAction" class}
		Resume endh
endh:
	End Function
	
	
	
	Property Set Title
		Title_ = Title
	End Property
	Property Get Title
		Title = Title_
	End Property
	
	Property Set Condition
		Condition_ = Condition
	End Property
	Property Get Condition
		Condition = Condition_
	End Property
	
	Property Set ValueType
		ValueType_ = ValueType
	End Property
	Property Get ValueType
		ValueType = ValueType_
	End Property
	
	
	Sub Delete()
	End Sub
End Class

'%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
'%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Class AdditionActionStore
	Public StageDoc As NotesDocument
	Private ViewPre As NotesView
	Private ViewPost As NotesView
	
	Sub New()
	End Sub
	
	Function Init(StageDoc As NotesDocument, ErrorStr As String) As Integer
		On Error GoTo errh
		
		Dim db As NotesDatabase
		
		Set Me.StageDoc = StageDoc
		Set db = StageDoc.ParentDatabase
		
		Set ViewPre = db.GetView("DWFAddActionPre")
		If (ViewPre Is Nothing) Then
			ErrorStr = {Сбой: Не найдено представление "DWFAddActionPre"}
			Exit Function
		End If
		Call ViewPre.Refresh
		ViewPre.AutoUpdate = False
		
		Set ViewPost = db.GetView("DWFAddActionPost")
		If (ViewPost Is Nothing) Then
			ErrorStr = {Сбой: Не найдено представление "DWFAddActionPost"}
			Exit Function
		End If
		Call ViewPost.Refresh
		ViewPost.AutoUpdate = False
		
		
		Init =1
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (Init) "AdditionActionStore" class}
		Resume endh
endh:
	End Function
	
	Function SetAddAction(docMain As NotesDocument, ActionType As String, ErrorStr As String) As Integer
		On Error GoTo errh
		
		Dim colA As NotesDocumentCollection
		Dim docA As NotesDocument
		Dim AdditionAction As AdditionAction
		
		Set colA = Me.GetActions(ActionType, Me.StageDoc.UniversalID, ErrorStr)
		If (ErrorStr <> "") Then Exit Function
		If (colA Is Nothing) Then Exit Function
		If (colA.Count = 0) Then Exit Function

		Set docA = colA.GetFirstDocument
		While (Not (docA Is Nothing))
			Set AdditionAction = New AdditionAction
			If (AdditionAction.Init(docA, ErrorStr) <> 1) Then Exit Function
			Call AdditionAction.SetUp(docMain, ErrorStr)
			If (ErrorStr <> "") Then Exit Function
			Set docA = colA.GetNextDocument(docA)
		Wend
		
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (SetAddAction) "AdditionActionStore" class}
		Resume endh
endh:
	End Function
	
	
	Function GetActions(ActionType As String, Key As String, ErrorStr As String) As NotesDocumentCollection
		On Error GoTo errh
		
		Dim col As NotesDocumentCollection
		Dim doc As NotesDocument
		Dim SortList List As NotesDocument
		Dim SortNum As String
		Dim docTest As NotesDocument
		Dim v As Variant
		Dim MaxEmpty As Integer
		
		If (LCase(ActionType) = "pre") Then
			Set col = ViewPre.GetAllDocumentsByKey(Key)
		ElseIf (LCase(ActionType) = "post") Then
			Set col = ViewPost.GetAllDocumentsByKey(Key)
		Else
			ErrorStr = {Сбой: AdditionActionStore.GetActions() - Не верный тип данных.}
			Exit Function
		End If
		
		If (col.Count = 0) Then
			Exit Function
		End If
		
		ReDim v(0) As Variant
		MaxEmpty = 1001
		Set doc = col.GetFirstDocument
		While (Not (doc Is Nothing))
			SortNum = CStr(doc.Number(0))
			If (SortNum = "") Then
				SortNum = CStr(MaxEmpty)
				MaxEmpty = MaxEmpty+1
			End If
			If (CStr(v(0)) <> "") Then
				ReDim Preserve v(UBound(v)+1) As Variant
			End If
			On Error GoTo break
			v(UBound(v)) = CInt(SortNum)
			On Error GoTo errh
			Set SortList(SortNum) = doc
getnext:
			Set doc = col.GetNextDocument(doc)
		Wend
		v = Arrays_Sort(v, 1)
		Set col = ViewPre.GetAllDocumentsByKey("xxx")
		ForAll ID In v
			Set doc = SortList(ID)
			If (Not (doc Is Nothing)) Then
				Set docTest = col.GetDocument(doc)
				If (docTest Is Nothing) Then
					Call col.AddDocument(doc)	
				End If
			End If
		End ForAll
		If (col.Count = 0) Then
			Exit Function
		End If
		
		Set GetActions = col
		Exit Function
break:		
		Print "++++++++++++++++++++++++++++"
		Print {Не верный формат сортировочных данных (в документе "Доп. действия"): UNID=} & doc.UniversalID &	{; Name=} & doc.Name(0)
		Print "++++++++++++++++++++++++++++"
		Resume getnext
		
		Exit Function
errh:
		ErrorStr = Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (GetActions) "AdditionActionStore" class}
		Resume endh
endh:
	End Function
	
	Sub Delete()
	End Sub
End Class
'++LotusScript Development Environment:2:2:Terminate:1:10
Sub Terminate
	
End Sub


'++LotusScript Development Environment:2:1:DWFACheckCompleteStage:1:8
Function DWFACheckCompleteStage(docMain As NotesDocument, Continue As Integer) As Integer
	On Error Goto errh
	
	Dim db As NotesDatabase
	Dim StageID As String
	Dim docStage As NotesDocument
	Dim View As NotesView
	Dim colStCndt As NotesDocumentCollection
	Dim docStCndt As NotesDocument
	Dim v As Variant
	Dim sFormula As String
	Dim message As Variant
	
	Dim SortNum As String
	Dim SortList List As NotesDocument
	Dim docTest As NotesDocument
	Dim MaxEmpty As Integer
	
	Continue = 0
	Set db  = docMain.ParentDatabase
	StageID = docMain.StageID(0)
	On Error 4091 Resume Next 'bad unid
	Set docStage = db.GetDocumentByUNID(StageID)
	On Error Goto errh
	If (docStage Is Nothing) Then
		Msgbox {Не найден документ стадии (docStage Is Nothing)}, 48, ERR_MSG_TITLE
		DWFACheckCompleteStage = 0
		Exit Function	
	End If
	
	Set View = db.GetView("DWFCompleteConditition") '("(DWF 07. Проверка на окончание)")
	If (View Is Nothing) Then
		Msgbox {Не найдено представление "(DWF 07. Проверка на окончание)"}, 48, ERR_MSG_TITLE
		DWFACheckCompleteStage = 0
		Exit Function		
	End If
	Call View.Refresh()
	View.AutoUpdate = False
	
	Set colStCndt = View.GetAllDocumentsByKey(docStage.UniversalID)
	If (colStCndt.Count = 0) Then
		Continue = 1
		DWFACheckCompleteStage = 1
		Exit Function
	End If
	
	Redim v(0) As Variant
	MaxEmpty = 1001
	Set docStCndt = colStCndt.GetFirstDocument
	While (Not (docStCndt Is Nothing))
		SortNum = Cstr(docStCndt.SortNumber(0))
		If (SortNum = "") Then
			SortNum = Cstr(MaxEmpty)
			MaxEmpty = MaxEmpty+1
		End If
		If (Cstr(v(0)) <> "") Then
			Redim Preserve v(Ubound(v)+1) As Variant
		End If
		On Error Goto break
		v(Ubound(v)) = Cint(SortNum)
		On Error Goto errh
		Set SortList(SortNum) = docStCndt
getnext:
		Set docStCndt = colStCndt.GetNextDocument(docStCndt)
	Wend
	v = Arrays_Sort(v, 1)
	
	Set colStCndt = View.GetAllDocumentsByKey("xxx")
	Forall ID In v
		Set docStCndt = SortList(ID)
		If (Not (docStCndt Is Nothing)) Then
			Set docTest = colStCndt.GetDocument(docStCndt)
			If (docTest Is Nothing) Then
				Call colStCndt.AddDocument(docStCndt)	
			End If
		End If
	End Forall
	If (colStCndt.Count = 0) Then
		Exit Function
	End If
	
	
	%REM
	Dim ViewAddDoc As NotesView
	Dim colAddDoc As NotesDocumentCollection
	Dim docAddDoc As NotesDocument
	Dim ViewAddDoc2 As NotesView
	Dim colAddDoc2 As NotesDocumentCollection
	Dim docAddDoc2 As NotesDocument
	Dim hasMatch As Integer
	Dim hasFile As Integer
	Dim hasComment As Integer
	Dim checkFile As String
	Dim checkAddDoc As Integer
	
	Set ViewAddDoc = db.GetView("($DWFAddDocByStageCheckDocID)")
	If (ViewAddDoc Is Nothing) Then
		Msgbox {Не найдено представление "($DWFAddDocByStageCheckDocID)"}, 48, ERR_MSG_TITLE
		DWFACheckCompleteStage = 0
		Exit Function		
	End If
	Set ViewAddDoc2 = db.GetView("(AddDocByFullID)")
	If (ViewAddDoc2 Is Nothing) Then
		Msgbox {Не найдено представление "(AddDocByFullID)"}, 48, ERR_MSG_TITLE
		DWFACheckCompleteStage = 0
		Exit Function		
	End If
	Set colAddDoc2 = ViewAddDoc2.GetAllDocumentsByKey(docMain.UniversalID & {-} & docMain.StageExclusionID(0))
	%END REM
	
	Redim message(0) As String
	Set docStCndt = colStCndt.GetFirstDocument
	While (Not (docStCndt Is Nothing))
		If(docStCndt.Getitemvalue("status")(0) <> "passive")Then
			Select Case Lcase(docStCndt.CheckType(0))
			Case "@"
				sFormula = docStCndt.conditition(0)
				If (sFormula <> "") Then
					On Error Goto break2
					v = Evaluate(sFormula, docMain)	
					On Error Goto errh
					If (Cstr(v(0)) = "1") Then
						If (docStCndt.message(0) <> "") Then
							If (Cstr(message(0)) <> "") Then
								Redim Preserve message(Ubound(message)+1) As String
							End If
							message(Ubound(message)) = Cstr(Ubound(message)+1) & {. } & docStCndt.message(0)
						End If
					End If
				End If
				
			Case "ls_ui"
				
				Dim script As String
				script = docStCndt.getItemValue("script")(0)
				If (script <> "") Then
					Set completeStageCheckDocMain = docMain
					
					completeStageCheckResult = False 

					Execute script
					
					If ( completeStageCheckResult ) Then 'is global parameter true
						If (docStCndt.message(0) <> "") Then
							If (CStr(message(0)) <> "") Then
								ReDim Preserve message(UBound(message)+1) As String
							End If
							message(UBound(message)) = CStr(UBound(message)+1) & {. } & docStCndt.message(0)
						End If
					End If
				End If
				
			%REM	
			Case Lcase("ADDDOC")
				checkAddDoc = 1
				sFormula = docStCndt.conditition(0)
				If (sFormula <> "") Then
					On Error Goto break2
					v = Evaluate(sFormula, docMain)	
					On Error Goto errh
					If (Cstr(v(0)) = "0") Then
						checkAddDoc = 0
					End If
				End If
				
				If (checkAddDoc = 1) Then
					checkFile = docStCndt.CheckAttachment(0)
					Set colAddDoc = ViewAddDoc.GetAllDocumentsByKey(docStCndt.UniversalID)
					If (colAddDoc.Count > 0) Then
						Set docAddDoc = colAddDoc.GetFirstDocument
						Do While (Not (docAddDoc Is Nothing))
							hasMatch = 0
							hasFile = 0
							If (colAddDoc2.Count = 0) Then
								If (docStCndt.message(0) <> "") Then
									If (Cstr(message(0)) <> "") Then
										Redim Preserve message(Ubound(message)+1) As String
									End If
									message(Ubound(message)) = Cstr(Ubound(message)+1) & {. } & docStCndt.message(0)	
								End If
							Else
								Set docAddDoc2 = colAddDoc2.GetFirstDocument
								Do While (Not (docAddDoc2 Is Nothing))
									If Lcase(docAddDoc2.ADDDOCID(0)) = Lcase(docAddDoc.CustomID(0)) Then
										Select Case Lcase(checkFile)
										Case Lcase("yes")
											If (docAddDoc2.HasEmbedded) Then
												hasFile = 1
											End If	
										Case ("no")
											If (docAddDoc2.HasEmbedded) Then
												hasComment = 1
											End If
											If (docAddDoc2.Comment(0) <> "") Then
												hasComment = 1
											End If
									End Select
										hasMatch = 1
										Exit Do
									End If	
									Set docAddDoc2 = colAddDoc2.GetNextDocument(docAddDoc2)
								Loop
								If (hasMatch = 0) Then
									If (docStCndt.message(0) <> "") Then
										If (Cstr(message(0)) <> "") Then
											Redim Preserve message(Ubound(message)+1) As String
										End If
										message(Ubound(message)) = Cstr(Ubound(message)+1) & {. } & docStCndt.message(0)
									End If
								Else
									Select Case Lcase(checkFile)
									Case Lcase("yes")
										If (hasFile = 0) Then
											If (Cstr(message(0)) <> "") Then
												Redim Preserve message(Ubound(message)+1) As String
											End If
											message(Ubound(message)) = Cstr(Ubound(message)+1) & {. В доп. документе "} & docAddDoc.Name(0) & {" нет файла(ов)}
										End If	
									Case ("no")
										If (hasComment = 0) Then
											If (Cstr(message(0)) <> "") Then
												Redim Preserve message(Ubound(message)+1) As String
											End If
											message(Ubound(message)) = Cstr(Ubound(message)+1) & {. В доп. документ "} & docAddDoc.Name(0) & {" необходимо вложить файл(ы) или ввести комментарий}
										End If	
								End Select
								End If
							End If
							Set docAddDoc = colAddDoc.GetNextDocument(docAddDoc)
						Loop
					End If
				End If
			%END REM	
				
			End Select
			
		End If 'status <> passive
		
getnext2:	
		Set docStCndt = colStCndt.GetNextDocument(docStCndt)
	Wend
	
	If (Cstr(message(0)) = "") Then
		Continue = 1
	Else
		Msgbox {Условие(я) завершения стадии:} & Chr(13) & Chr(13) &_
		Join(message, Chr(13)), 48, ERR_MSG_TITLE
	End If

	DWFACheckCompleteStage = 1
	
	Exit Function
break2:		
	Resume getnext2	
	
	Exit Function
break:		
	Resume getnext	
	
	Exit Function
errh:
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFACheckCompleteStage) "DWFAppLib"},, {Error}
	Resume endh
endh:
End Function




'++LotusScript Development Environment:2:1:DWFAGetSubProcessDoc:1:8
Function DWFAGetSubProcessDoc(docParentProcess As NotesDocument, docProcess As NotesDocument) As Integer
	On Error Goto errh
	
	Dim ws As New NotesUIWorkspace
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim View As NotesView
	Dim docTemp As NotesDocument
	Dim MemberList As Variant
	Dim checkParentProcess As Integer
	Dim hasMatch As Integer
	Dim v As Variant
	
	Set db = session.CurrentDatabase
	Set View = db.GetView("DWFProcess")
	If (View Is Nothing) Then
		Msgbox {Не найдено представление "DWFProcess"}, 16, ERR_MSG_TITLE
		DWFAGetSubProcessDoc = 0
		Exit Function
	End If
	Call View.Refresh
	View.AutoUpdate = False
	
	hasMatch = 1
	If (Not (docParentProcess Is Nothing)) Then
		checkParentProcess = 1
	End If
	
	Redim MemberList(0) As String
	Set docProcess = View.GetFirstDocument
	While (Not (docProcess Is Nothing))
		If (Lcase(docProcess.Type(0)) = Lcase("sub")) Then
			If (checkParentProcess = 1) Then
				hasMatch = 0
				If docProcess.HasItem("ParentProcessID") Then
					v = docProcess.GetFirstItem("ParentProcessID").Values
					If (v(0) <> "") Then
						Forall ParentID In v
							If (Lcase(ParentID) = Lcase(docParentProcess.UniversalID)) Then
								hasMatch = 1
								Exit Forall
							End If
						End Forall
					End If
				End If
			End If
			If (hasMatch = 1) Then
				If (MemberList(0)<>"") Then
					Redim Preserve MemberList(Ubound(MemberList)+1) As String
				End If
				MemberList(Ubound(MemberList)) = docProcess.Name(0) & {|} & docProcess.UniversalID
			End If
		End If
		Set docProcess = View.GetNextDocument(docProcess)
	Wend
	If (MemberList(0) = "") Then
		Msgbox {Не найден(ы) активный(ые) процесс(ы)}, 48, ERR_MSG_TITLE
		DWFAGetSubProcessDoc = 0
		Exit Function
	End If
	
	If (Ubound(MemberList) <> 0) Then
		Set docTemp = db.CreateDocument
		docTemp.Members = MemberList
		docTemp.Promt = "Выбеите процесс"
		
		If Not (ws.DialogBox("DWF101", True, True, False, False, False, False, db.Title, docTemp, True, False, True)) Then
			DWFAGetSubProcessDoc = 0
			Exit Function
		End If
		If (docTemp.List(0) = "") Then
			DWFAGetSubProcessDoc = 0
			Exit Function
		End If
		
		On Error 4091 Resume Next 'bad unid
		Set docProcess = db.GetDocumentByUNID(docTemp.List(0))		
	Else
		On Error 4091 Resume Next 'bad unid
		Set docProcess = db.GetDocumentByUNID(Strright(MemberList(0), {|}))
	End If
	
	If (docProcess Is Nothing) Then
		Msgbox {Не найден документ Процесса}, 16, ERR_MSG_TITLE
		DWFAGetSubProcessDoc = 0
		Exit Function
	End If
	
	
	DWFAGetSubProcessDoc = 1
	
	Exit Function
errh:
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAGetSubProcessDoc) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFACheckUITaskAddDoc:1:8
Function DWFACheckUITaskAddDoc(doc As NotesDocument, docMain As NotesDocument, UITaskValue List As UITaskValue) As Integer
	On Error GoTo errh
	
	Dim UITaskStore As New UITaskStore
	Dim ErrorStr As String
	
	If (UITaskStore.Init(doc, ErrorStr) <> 1) Then
		If (ErrorStr <> "") Then
			MsgBox ErrorStr, 48, ERR_MSG_TITLE
		End If
		DWFACheckUITaskAddDoc = 0
		Exit Function	
	End If
	
	If (UITaskStore.SetUITaskAddDoc(docMain, UITaskValue, ErrorStr) <> 1) Then
		If (ErrorStr <> "") Then
			MsgBox ErrorStr, 48, ERR_MSG_TITLE
		End If
		DWFACheckUITaskAddDoc = 0
		Exit Function	
	End If
	
	DWFACheckUITaskAddDoc = 1
	
	Exit Function
errh:
	MsgBox Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (DWFACheckUITaskAddDoc) "DWFAppLib"},, {Error}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAAddActionsPost:7:8
'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
%REM
	Function DWFAAddActionsPost
	Description: выполняет на клиенте доп.действия "после стадии"
	Returns: Variant
%END REM
Public Function DWFAAddActionsPost(docMain As NotesDocument, errString As String)As Integer
	On Error GoTo error_point
	
	If(UCase$(docMain.Getitemvalue("StatusState")(0)) = "COMPLETE")Then 
		DWFAAddActionsPost = 1
		Exit Function
	End If
	
	Dim stageId As String
	Dim stageDoc As NotesDocument
	
	Dim actionStore As AdditionActionStore
	
	stageId = docMain.Getitemvalue("StageId")(0)
	Set stageDoc = docMain.Parentdatabase.Getdocumentbyunid(stageId)
	
	Set actionStore = New AdditionActionStore()
	If(actionStore.Init(stageDoc, errString) <> 1)Then
		Exit Function
	End If
	If(errString <> "")Then
		Exit Function
	End If
	
	DWFAAddActionsPost = actionStore.SetAddAction(docMain, "post", errString)
	

	Exit Function
	
error_point:
	Error Err, GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$		

End Function



'++LotusScript Development Environment:2:1:DWFACheckCompleteStageAddDoc:1:8
Function DWFACheckCompleteStageAddDoc(docMain As NotesDocument, Continue As Integer) As Integer
	On Error GoTo errh
	
	Dim db As NotesDatabase
	Dim StageID As String
	Dim docStage As NotesDocument
	Dim View As NotesView
	Dim colStCndt As NotesDocumentCollection
	Dim docStCndt As NotesDocument
	Dim v As Variant
	Dim sFormula As String
	Dim message As Variant
	
	Dim SortNum As String
	Dim SortList List As NotesDocument
	Dim docTest As NotesDocument
	Dim MaxEmpty As Integer
	
	Continue = 0
	Set db  = docMain.ParentDatabase
	StageID = docMain.StageID(0)
	On Error 4091 Resume Next
	Set docStage = db.GetDocumentByUNID(StageID)
	On Error GoTo errh
	If (docStage Is Nothing) Then
		MsgBox {Не найден документ стадии (docStage Is Nothing)}, 48, ERR_MSG_TITLE
		DWFACheckCompleteStageAddDoc = 0
		Exit Function	
	End If
	
	Set View = db.GetView("DWFCompleteConditition")
	If (View Is Nothing) Then
		MsgBox {Не найдено представление "(DWF 07. Проверка на окончание)"}, 48, ERR_MSG_TITLE
		DWFACheckCompleteStageAddDoc = 0
		Exit Function		
	End If
	Call View.Refresh()
	View.AutoUpdate = False
	
	Set colStCndt = View.GetAllDocumentsByKey(docStage.UniversalID)
	If (colStCndt.Count = 0) Then
		Continue = 1
		DWFACheckCompleteStageAddDoc = 1
		Exit Function
	End If
	
	ReDim v(0) As Variant
	MaxEmpty = 1001
	Set docStCndt = colStCndt.GetFirstDocument
	While (Not (docStCndt Is Nothing))
		SortNum = CStr(docStCndt.SortNumber(0))
		If (SortNum = "") Then
			SortNum = CStr(MaxEmpty)
			MaxEmpty = MaxEmpty+1
		End If
		If (CStr(v(0)) <> "") Then
			ReDim Preserve v(UBound(v)+1) As Variant
		End If
		On Error GoTo break
		v(UBound(v)) = CInt(SortNum)
		On Error GoTo errh
		Set SortList(SortNum) = docStCndt
getnext:
		Set docStCndt = colStCndt.GetNextDocument(docStCndt)
	Wend
	v = Arrays_Sort(v, 1)
	
	Set colStCndt = View.GetAllDocumentsByKey("xxx")
	ForAll ID In v
		Set docStCndt = SortList(ID)
		If (Not (docStCndt Is Nothing)) Then
			Set docTest = colStCndt.GetDocument(docStCndt)
			If (docTest Is Nothing) Then
				Call colStCndt.AddDocument(docStCndt)	
			End If
		End If
	End ForAll
	If (colStCndt.Count = 0) Then
		Exit Function
	End If
	
	Dim ViewAddDoc As NotesView
	Dim colAddDoc As NotesDocumentCollection
	Dim docAddDoc As NotesDocument
	Dim ViewAddDoc2 As NotesView
	Dim colAddDoc2 As NotesDocumentCollection
	Dim docAddDoc2 As NotesDocument	
	Dim hasMatch As Integer
	Dim hasFile As Integer
	Dim hasComment As Integer
	Dim checkFile As String
	Dim checkAddDoc As Integer
	
	Set ViewAddDoc = db.GetView("($DWFAddDocByStageCheckDocID)")
	If (ViewAddDoc Is Nothing) Then
		MsgBox {Не найдено представление "($DWFAddDocByStageCheckDocID)"}, 48, ERR_MSG_TITLE
		DWFACheckCompleteStageAddDoc = 0
		Exit Function		
	End If
	Set ViewAddDoc2 = db.GetView("(AddDocByFullID)")
	If (ViewAddDoc2 Is Nothing) Then
		MsgBox {Не найдено представление "(AddDocByFullID)"}, 48, ERR_MSG_TITLE
		DWFACheckCompleteStageAddDoc = 0
		Exit Function		
	End If
	Set colAddDoc2 = ViewAddDoc2.GetAllDocumentsByKey(docMain.UniversalID & {-} & docMain.StageExclusionID(0))
	
	ReDim message(0) As String
	Set docStCndt = colStCndt.GetFirstDocument
	While (Not (docStCndt Is Nothing))
		If(docStCndt.Getitemvalue("status")(0) <> "passive")Then
			Select Case LCase(docStCndt.CheckType(0))
					
			Case LCase("ADDDOC")
				checkAddDoc = 1
				sFormula = docStCndt.conditition(0)
				If (sFormula <> "") Then
					On Error GoTo break2
					v = Evaluate(sFormula, docMain)	
					On Error GoTo errh
					If (CStr(v(0)) = "0") Then
						checkAddDoc = 0
					End If
				End If
				
				If (checkAddDoc = 1) Then
					checkFile = docStCndt.CheckAttachment(0)
					Set colAddDoc = ViewAddDoc.GetAllDocumentsByKey(docStCndt.UniversalID)
					If (colAddDoc.Count > 0) Then
						Set docAddDoc = colAddDoc.GetFirstDocument
						Do While (Not (docAddDoc Is Nothing))
							hasMatch = 0
							hasFile = 0
							If (colAddDoc2.Count = 0) Then
								If (docStCndt.message(0) <> "") Then
									If (CStr(message(0)) <> "") Then
										ReDim Preserve message(UBound(message)+1) As String
									End If
									message(UBound(message)) = CStr(UBound(message)+1) & {. } & docStCndt.message(0)	
								End If
							Else
								Set docAddDoc2 = colAddDoc2.GetFirstDocument
								Do While (Not (docAddDoc2 Is Nothing))
									If LCase(docAddDoc2.ADDDOCID(0)) = LCase(docAddDoc.CustomID(0)) Then
										Select Case LCase(checkFile)
										Case LCase("yes")
											If (docAddDoc2.HasEmbedded) Then
												hasFile = 1
											End If	
										Case ("no")
											If (docAddDoc2.HasEmbedded) Then
												hasComment = 1
											End If
											If (docAddDoc2.Comment(0) <> "") Then
												hasComment = 1
											End If
									End Select
										hasMatch = 1
										Exit Do
									End If	
									Set docAddDoc2 = colAddDoc2.GetNextDocument(docAddDoc2)
								Loop
								If (hasMatch = 0) Then
									If (docStCndt.message(0) <> "") Then
										If (CStr(message(0)) <> "") Then
											ReDim Preserve message(UBound(message)+1) As String
										End If
										message(UBound(message)) = CStr(UBound(message)+1) & {. } & docStCndt.message(0)
									End If
								Else
									Select Case LCase(checkFile)
									Case LCase("yes")
										If (hasFile = 0) Then
											If (CStr(message(0)) <> "") Then
												ReDim Preserve message(UBound(message)+1) As String
											End If
											message(UBound(message)) = CStr(UBound(message)+1) & {. В доп. документе "} & docAddDoc.Name(0) & {" нет файла(ов)}
										End If	
									Case ("no")
										If (hasComment = 0) Then
											If (CStr(message(0)) <> "") Then
												ReDim Preserve message(UBound(message)+1) As String
											End If
											message(UBound(message)) = CStr(UBound(message)+1) & {. В доп. документ "} & docAddDoc.Name(0) & {" необходимо вложить файл(ы) или ввести комментарий}
										End If	
								End Select
								End If
							End If
							Set docAddDoc = colAddDoc.GetNextDocument(docAddDoc)
						Loop
					End If
				End If
				
			End Select
			
		End If
		
getnext2:	
		Set docStCndt = colStCndt.GetNextDocument(docStCndt)
	Wend
	
	If (CStr(message(0)) = "") Then
		Continue = 1
	Else
		MsgBox {Условие(я) завершения стадии:} & Chr(13) & Chr(13) &_
		Join(message, Chr(13)), 48, ERR_MSG_TITLE
	End If
	

	DWFACheckCompleteStageAddDoc = 1
	
	Exit Function
break2:		
	Resume getnext2	
	
	Exit Function
break:		
	Resume getnext	
	
	Exit Function
errh:
	MsgBox Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (DWFACheckCompleteStageAddDoc) "DWFAppLib"},, {Error}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAAdminRemoveVisaWithOwner:1:8
Function DWFAAdminRemoveVisaWithOwner(docMain As NotesDocument, ObjID As Variant, VisaID As Variant) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim ErrorStr As String
	Dim AddObjID As Variant
	Dim docOD As NotesDocument
	Dim v As Variant	
	Dim docMail As NotesDocument
	
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAAdminRemoveVisaWithOwner = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAAdminRemoveVisaWithOwner = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAAdminRemoveVisaWithOwner = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAdminRemoveVisaWithOwner = 0
		Exit Function	
	End If
	
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAdminRemoveVisaWithOwner = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	
	If (ObjID(0) = "") Then
		Msgbox {Пустое значение удаляемых объектов Орг. директории}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "AdminRemoveVisaWithOwner"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.RemoveObjID		= ObjID
	docMail.RemoveVisaID	= VisaID
	docMail.UserName 		= session.UserName
	docMail.RemoveByObjID 	= ODObj.ObjAccess
	
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAAdminRemoveVisaWithOwner = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAAdminRemoveVisaWithOwner = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	
	DWFAAdminRemoveVisaWithOwner = 1
	
	Exit Function
errh:
	DWFAAdminRemoveVisaWithOwner = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAAdminRemoveVisaWithOwner) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAInitSubProcess:1:8
Function DWFAInitSubProcess(docProcess As NotesDocument, docMain As NotesDocument, docMainSub As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim v As Variant
	Dim InitObjID As String
	Dim docMail As NotesDocument
	
	
	Set db = session.CurrentDatabase
	v = docProcess.PCenter(0)
	If (v = "") Then
		Msgbox {В документе "Процесса" не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAInitSubProcess = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAInitSubProcess = 0
		Exit Function	
	End If
	
	v = docProcess.OrgDir(0)
	If (v = "") Then
		Msgbox {В документе "Процесса" не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAInitSubProcess = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAInitSubProcess = 0
		Exit Function	
	End If
	
	'получение должности пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAInitSubProcess = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAInitSubProcess = 0
		Exit Function	
	End If
	
	Set Position = Person.GetUserPosition(ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAInitSubProcess = 0
		Exit Function	
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	
	
	'получение инфы от имени кого инициирует
	If (DWFAGetObjIDByProcessItem(docProcess, "ProcessInitiator", ODStoreUI, "Инициировать процесс", InitObjID) <> 1) Then
		DWFAInitSubProcess = 0
		Exit Function	
	End If
	If (Not Isarray(InitObjID)) Then
		If (InitObjID = "<anybody>") Then
			InitObjID = Position.ObjAccess
		End If
	End If
	
	'проверка не заблокирован ли инициатор <add 2016.11.29 by Tambiev>
	Dim checkResult As Integer
	checkResult = DWFAInitProcessIsInitObjBlocked( docProcess, ODStoreUI, InitObjID )
	If ( checkResult  = 1 ) Or ( checkResult  = -1 ) Then
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 		= "Task"
	docMail.Action 	= "InitSubProcess"
	docMail.InitServer 	= db.Server
	docMail.AppPath 	= db.FilePath
	docMail.ProcessID 	= docProcess.UniversalID
	docMail.docMainID		= docMain.UniversalID
	docMail.UserName 	= session.UserName
	docMail.InitPosID 	= Position.ObjAccess 
	docMail.InitObjID 	= InitObjID
	If Not(docMainSub Is Nothing)Then Call docMail.replaceItemValue("initOnDocId", docMainSub.Universalid)
	
	
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAInitSubProcess = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAInitSubProcess = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	On Error 4091 Resume Next 'bad unid
	Set docMainSub = db.GetDocumentByUNID(docMail.docMainUNID(0))
	If (docMainSub Is Nothing) Then
		DWFAInitSubProcess = 0
		Msgbox {Ошибка при инициации процесса: docMainSub Is Nothing}, 48, ERR_MSG_TITLE
		Exit Function	
	End If
	
	'Call docMail.Remove(True)
	
	DWFAInitSubProcess = 1
	
	
	Exit Function
errh:
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAInitSubProcess) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAAddStageOwner:1:8
Function DWFAAddStageOwner(docMain As NotesDocument, ObjID As Variant) As Integer
	On Error Goto errh
	
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim ErrorStr As String
	Dim AddObjID As Variant
	Dim docOD As NotesDocument
	Dim v As Variant	
	Dim docMail As NotesDocument
	
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAAddStageOwner = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAAddStageOwner = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAAddStageOwner = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddStageOwner = 0
		Exit Function	
	End If
	
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddStageOwner = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	
	If (ObjID(0) = "") Then
		Msgbox {Пустое значение добавляемых объектов Орг. директории}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "AddStageOwner"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.AddObjID		= ObjID
	docMail.UserName 		= session.UserName
	docMail.AddByObjID 		= ODObj.ObjAccess
	
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAAddStageOwner = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAAddStageOwner = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	
	
	
	DWFAAddStageOwner = 1
	
	
	Exit Function
errh:
	DWFAAddStageOwner = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAAddStageOwner) "DWFAppLib"}
	Resume endh
endh:
End Function


'++LotusScript Development Environment:2:1:DWFAAddDocRemove:1:8
Function DWFAAddDocRemove(docMain As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim AccessID As String
	Dim v As Variant
	Dim docMail As NotesDocument
	
	
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAAddDocRemove = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAAddDocRemove = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAAddDocRemove = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocRemove = 0
		Exit Function	
	End If
	
	'получение должности пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocRemove = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocRemove = 0
		Exit Function	
	End If
	
	Set Position = Person.GetUserPosition(ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocRemove = 0
		Exit Function	
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageExecutor", {Отменить доп. документ}, AccessID) <> 1) Then
		DWFAAddDocRemove = 0
		Exit Function
	End If
	Set TaskInitObj = ODStoreUI.GetObjByValue(AccessID, ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocRemove = 0
		Exit Function	
	End If
	If (TaskInitObj Is Nothing) Then
		Exit Function
	End If
	
	
	
	Dim docStage As NotesDocument
	Dim addDocStoreUI As AdditionalDocumentStoreUI
	Dim AddDocID As String
	
	On Error 4091 Resume Next 'bad unid
	Set docStage = db.GetDocumentByUNID(docMain.StageID(0))
	On Error Goto errh
	If (docStage Is Nothing) Then
		Msgbox {Не найден документ стадии (docStage Is Nothing)}, 48, ERR_MSG_TITLE
		DWFAAddDocRemove = 0
		Exit Function	
	End If
	
	Set addDocStoreUI = New AdditionalDocumentStoreUI(docMain, "AddDoc", docStage)
	If (addDocStoreUI.GetAddDocID(Position.ObjAccess, 0, AddDocID, ErrorStr) <>1 ) Then
		If (ErrorStr <> "") Then
			Msgbox ErrorStr, 48, ERR_MSG_TITLE
		End If
		DWFAAddDocRemove = 0
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "AddDocRemove"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.UserName 		= session.UserName
	docMail.UserPosID 		= Position.ObjAccess 
	docMail.RemoveAsObjID 	= TaskInitObj.ObjAccess 
	docMail.AddDocID		= AddDocID
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAAddDocRemove = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAAddDocRemove = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	
	
	
	
	
	
	DWFAAddDocRemove = 1
	
	
	Exit Function
errh:
	DWFAAddDocRemove = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAAddDocRemove) "DWFAppLib"}
	Resume endh
endh:	
End Function

'++LotusScript Development Environment:2:1:DWFARespDocRemove:1:8
Function DWFARespDocRemove(docMain As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim AccessID As String
	Dim v As Variant
	Dim docMail As NotesDocument
	
	
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFARespDocRemove = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFARespDocRemove = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFARespDocRemove = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocRemove = 0
		Exit Function	
	End If
	
	'получение должности пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocRemove = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocRemove = 0
		Exit Function	
	End If
	
	Set Position = Person.GetUserPosition(ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocRemove = 0
		Exit Function	
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageExecutor", {Отменить доп. документ}, AccessID) <> 1) Then
		DWFARespDocRemove = 0
		Exit Function
	End If
	Set TaskInitObj = ODStoreUI.GetObjByValue(AccessID, ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocRemove = 0
		Exit Function	
	End If
	If (TaskInitObj Is Nothing) Then
		Exit Function
	End If
	
	
	
	Dim docStage As NotesDocument
	Dim addDocStoreUI As AdditionalDocumentStoreUI
	Dim AddDocID As String
	
	On Error 4091 Resume Next 'bad unid
	Set docStage = db.GetDocumentByUNID(docMain.StageID(0))
	On Error Goto errh
	If (docStage Is Nothing) Then
		Msgbox {Не найден документ стадии (docStage Is Nothing)}, 48, ERR_MSG_TITLE
		DWFARespDocRemove = 0
		Exit Function	
	End If
	
	Set addDocStoreUI = New AdditionalDocumentStoreUI(docMain, "RespDoc", docStage)
	If (addDocStoreUI.GetAddDocID(Position.ObjAccess, 0, AddDocID, ErrorStr) <>1 ) Then
		If (ErrorStr <> "") Then
			Msgbox ErrorStr, 48, ERR_MSG_TITLE
		End If
		DWFARespDocRemove = 0
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "AddDocRemove"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.UserName 		= session.UserName
	docMail.UserPosID 		= Position.ObjAccess 
	docMail.RemoveAsObjID 	= TaskInitObj.ObjAccess 
	docMail.AddDocID		= AddDocID
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFARespDocRemove = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFARespDocRemove = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	
	
	
	
	
	
	DWFARespDocRemove = 1
	
	
	Exit Function
errh:
	DWFARespDocRemove = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFARespDocRemove) "DWFAppLib"}
	Resume endh
endh:	
End Function











'++LotusScript Development Environment:2:1:DWFAGetProcessDocByNotesDatabase:1:8
Function DWFAGetProcessDocByNotesDatabase(in_db As NotesDatabase, out_docProcess As NotesDocument) As Integer
	On Error GoTo errh
	
	Dim ws As New NotesUIWorkspace
	Dim session As New NotesSession
	
	Dim View As NotesView
	Dim docTemp As NotesDocument
	
	Dim MemberList As Variant
	Set View = in_db.GetView("DWFProcess")
	If (View Is Nothing) Then
		MsgBox {Не найдено представление "DWFProcess"}, 16, ERR_MSG_TITLE
		DWFAGetProcessDocByNotesDatabase = 0
		Exit Function
	End If
	Call View.Refresh
	View.AutoUpdate = False
	
	
	ReDim MemberList(0) As String
	Set out_docProcess = View.GetFirstDocument
	While (Not (out_docProcess Is Nothing))
		If (LCase(out_docProcess.Type(0)) = LCase("basic")) Then
			If (MemberList(0)<>"") Then
				ReDim Preserve MemberList(UBound(MemberList)+1) As String
			End If
			MemberList(UBound(MemberList)) = out_docProcess.Name(0) & {|} & out_docProcess.UniversalID
		End If
		Set out_docProcess = View.GetNextDocument(out_docProcess)
	Wend
	If (MemberList(0) = "") Then
		MsgBox {Не найден(ы) активный(ые) процесс(ы)}, 48, ERR_MSG_TITLE
		DWFAGetProcessDocByNotesDatabase = 0
		Exit Function
	End If
	
	If (UBound(MemberList) <> 0) Then
		Set docTemp = in_db.CreateDocument
		docTemp.Members = MemberList
		docTemp.Promt = "Выберите процесс"
		
		If Not (ws.DialogBox("DWF101", True, True, False, False, False, False, in_db.Title, docTemp, True, False, True)) Then
			DWFAGetProcessDocByNotesDatabase = 0
			Exit Function
		End If
		If (docTemp.List(0) = "") Then
			DWFAGetProcessDocByNotesDatabase = 0
			Exit Function
		End If
		
		On Error 4091 Resume Next 'bad unid
		Set out_docProcess = in_db.GetDocumentByUNID(docTemp.List(0))		
	Else
		On Error 4091 Resume Next 'bad unid
		Set out_docProcess = in_db.GetDocumentByUNID(StrRight(MemberList(0), {|}))
	End If
	
	If (out_docProcess Is Nothing) Then
		MsgBox {Не найден документ Процесса}, 16, ERR_MSG_TITLE
		DWFAGetProcessDocByNotesDatabase = 0
		Exit Function
	End If
	
	DWFAGetProcessDocByNotesDatabase = 1
	
	Exit Function
errh:
	MsgBox Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (DWFAGetProcessDoc) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFARespDocReturn:1:8
Function DWFARespDocReturn(docMain As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim AccessID As String
	Dim v As Variant
	Dim docMail As NotesDocument
	
	
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFARespDocReturn = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFARespDocReturn = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFARespDocReturn = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocReturn = 0
		Exit Function	
	End If
	
	'получение должности пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocReturn = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocReturn = 0
		Exit Function	
	End If
	
	Set Position = Person.GetUserPosition(ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocReturn = 0
		Exit Function	
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageExecutor", {Вернуть доп. документ}, AccessID) <> 1) Then
		DWFARespDocReturn = 0
		Exit Function
	End If
	Set TaskInitObj = ODStoreUI.GetObjByValue(AccessID, ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocReturn = 0
		Exit Function	
	End If
	If (TaskInitObj Is Nothing) Then
		Exit Function
	End If
	
	
	
	Dim docStage As NotesDocument
	Dim addDocStoreUI As AdditionalDocumentStoreUI
	Dim AddDocID As String
	
	On Error 4091 Resume Next 'bad unid
	Set docStage = db.GetDocumentByUNID(docMain.StageID(0))
	On Error Goto errh
	If (docStage Is Nothing) Then
		Msgbox {Не найден документ стадии (docStage Is Nothing)}, 48, ERR_MSG_TITLE
		DWFARespDocReturn = 0
		Exit Function	
	End If
	
	Set addDocStoreUI = New AdditionalDocumentStoreUI(docMain, "RespDoc", docStage)
	If (addDocStoreUI.GetAddDocID(Position.ObjAccess, 1, AddDocID, ErrorStr) <>1 ) Then
		If (ErrorStr <> "") Then
			Msgbox ErrorStr, 48, ERR_MSG_TITLE
		End If
		DWFARespDocReturn = 0
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "AddDocReturn"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.UserName 		= session.UserName
	docMail.UserPosID 		= Position.ObjAccess 
	docMail.RemoveAsObjID 	= TaskInitObj.ObjAccess 
	docMail.AddDocID		= AddDocID
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFARespDocReturn = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFARespDocReturn = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	
	
	
	
	
	
	DWFARespDocReturn = 1
	
	
	Exit Function
errh:
	DWFARespDocReturn = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFARespDocReturn) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAInitProcessIsInitObjBlocked:1:8
Function DWFAInitProcessIsInitObjBlocked( docProcess As NotesDocument, ODStoreUI As ODStoreUI, AccessID As String ) As Integer
	On Error GoTo errh
		
	Dim ItemMember As NotesItem, ItemPrefix As String
	Dim MemberID As Variant
	Dim i As Integer, id As String, title As String
	Dim hasMatch As Integer
	Dim ODObj As ODObj, ErrorStr As String
	
	ItemPrefix = "ProcessInitBlocked"
	Set ItemMember = docProcess.GetFirstItem( ItemPrefix & "ObjID")	
	If Not (ItemMember Is Nothing) Then
		MemberID = ItemMember.Values
		If ( MemberID(0) <> "" ) Then
			
			For i=LBound(MemberID) To UBound(MemberID)
				id = MemberID(i)
				
				Set ODObj = ODStoreUI.GetObjByValue(CStr(ID), ErrorStr)
				If (ErrorStr <> "") Then
					MsgBox ErrorStr, 48, ERR_MSG_TITLE
					DWFAInitProcessIsInitObjBlocked = -1
					Exit Function	
				End If
				If (ODObj Is Nothing) Then
					DWFAInitProcessIsInitObjBlocked = -1
					Exit Function
				End If
				
				If ( LCase(ODObj.ObjAccess) = LCase(AccessID) ) Then
					title = ODObj.ObjName
					hasMatch = 1
					Exit For
				End If
			Next
			
			If ( hasMatch = 1 ) Then
				DWFAInitProcessIsInitObjBlocked = 1
				MsgBox {Для объекта доступа '} & title & {' данное действие заблокировано}, 48, ERR_MSG_TITLE
			Else
				DWFAInitProcessIsInitObjBlocked = 0
			End If
			
		Else
			DWFAInitProcessIsInitObjBlocked = 0
		End If
	Else
		DWFAInitProcessIsInitObjBlocked = 0
	End If
	
	Exit Function
errh:
	MsgBox Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (DWFAInitProcessIsInitObjBlocked) "DWFAppLib"},, {Error}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAAdminGetStagePostLink:1:8
Function DWFAAdminGetStagePostLink(docMain As NotesDocument, docLink As NotesDocument) As Integer
	On Error Goto errh
	
	Dim ws As New NotesUIWorkspace
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim ViewLinkByEndID As NotesView
	Dim colLink As NotesDocumentCollection
	Dim StageID As String
	Dim v As Variant
	Dim docTemp As NotesDocument
	
	
	Set db = session.CurrentDatabase
	StageID = docMain.StageID(0)
	If (Cstr(StageID) = "") Then
		Msgbox {Нет информации о текущей стадии}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	Set ViewLinkByEndID = db.GetView("DWFLinkByStageIDEnd")
	If (ViewLinkByEndID Is Nothing) Then
		Msgbox {Сбой: Не найдено представление "DWFLinkByStageIDEnd"}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	Call ViewLinkByEndID.Refresh
	ViewLinkByEndID.AutoUpdate = False
	
	Set colLink = ViewLinkByEndID.GetAllDocumentsByKey(StageID)
	If (colLink.Count = 0) Then
		Msgbox {Ошибка в процессе (Для документа с описанием "} & docMain.StageName(0) & {" не найдено <post> связей)}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	If (colLink.Count = 1) Then
		Set docLink = colLink.GetFirstDocument
		
		If (Messagebox(_
		{Количество <post> связей: 1} & Chr(13) &_
		{Наименование связи: } & Cstr(docLink.Name(0)) & Chr(13) &_
		{Наименование след. стадии: } & Cstr(docLink.ENDSTAGENAME(0)) & Chr(13) &_
		{Продолжить?}, 32+4+256, {Внимание!} ) = 7) Then 'No
			Exit Function
		End If
		
		DWFAAdminGetStagePostLink = 1
		Exit Function
	End If
	
	Redim v(0) As String
	Set docLink = colLink.GetFirstDocument
	While (Not (docLink Is Nothing))
		If (v(0) <> "") Then
			Redim Preserve v(Ubound(v)+1) As String
		End If
		
		v(Ubound(v)) = Cstr(Ubound(v)+1) & {. } & docLink.ENDSTAGENAME(0)
		If (Lcase(docLink.Type(0)) = Lcase("absolute")) Then
			v(Ubound(v)) = v(Ubound(v)) & { (связь "Безусловная")}
		Else
			v(Ubound(v)) = v(Ubound(v)) & { (связь "Условная")}
		End If
		v(Ubound(v)) = v(Ubound(v)) & {|} & docLink.UniversalID
		Set docLink = colLink.GetNextDocument(docLink)
	Wend
	If (v(0) = "") Then
		Msgbox {Ошибка: Пустой список связей}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	Set docTemp = db.CreateDocument
	docTemp.Members = v
	docTemp.Promt = "Выбеите следующую стадию"
	
	If Not (ws.DialogBox("DWF104", True, True, False, False, False, False, db.Title, docTemp, True, False, True)) Then
		DWFAAdminGetStagePostLink = 0
		Exit Function
	End If
	If (docTemp.List(0) = "") Then
		DWFAAdminGetStagePostLink = 0
		Exit Function
	End If
	
	On Error 4091 Resume Next 'bad unid
	Set docLink = db.GetDocumentByUNID(docTemp.List(0))
	If (docLink Is Nothing) Then
		Msgbox {Не найден документ Связи}, 16, ERR_MSG_TITLE
		Exit Function
	End If
	
	
	DWFAAdminGetStagePostLink = 1
	
	Exit Function
errh:
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAAdminGetStagePostLink) "DWFAppLib"}
	Resume endh
endh:
End Function




'++LotusScript Development Environment:2:1:DWFARemoveStageOwner:1:8
Function DWFARemoveStageOwner(docMain As NotesDocument, ObjID As Variant) As Integer
	On Error Goto errh
	
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim ErrorStr As String
	Dim AddObjID As Variant
	Dim docOD As NotesDocument
	Dim v As Variant	
	Dim docMail As NotesDocument
	
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFARemoveStageOwner = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFARemoveStageOwner = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFARemoveStageOwner = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARemoveStageOwner = 0
		Exit Function	
	End If
	
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARemoveStageOwner = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	
	If (ObjID(0) = "") Then
		Msgbox {Пустое значение удаляемых объектов Орг. директории}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "RemoveStageOwner"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.RemoveObjID		= ObjID
	docMail.UserName 		= session.UserName
	docMail.RemoveByObjID 	= ODObj.ObjAccess
	
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFARemoveStageOwner = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFARemoveStageOwner = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	
	
	
	DWFARemoveStageOwner = 1
	
	
	Exit Function
errh:
	DWFARemoveStageOwner = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFARemoveStageOwner) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAGetProcessDoc:1:8
Function DWFAGetProcessDoc(docProcess As NotesDocument) As Integer
	On Error GoTo errh
	
	Dim session As New NotesSession, db As NotesDatabase
	Set db = session.CurrentDatabase
	DWFAGetProcessDoc = DWFAGetProcessDocByNotesDatabase( db, docProcess )
	Exit Function
	
errh:
	MsgBox Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (DWFAGetProcessDoc) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFACompleteVisa:1:8
Function DWFACompleteVisa(docMain As NotesDocument, docVisa As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim AccessID As String
	Dim v As Variant
	Dim docMail As NotesDocument
	Dim ViewVisa As NotesView
	Dim colVisa As NotesDocumentCollection
	Dim key As String
	
	
	Set db = docMain.ParentDatabase
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function	
	End If
	
	'получение пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function	
	End If
		
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageExecutor", {Завершение визирования}, AccessID) <> 1) Then
		DWFACompleteVisa = 0
		Exit Function
	End If
	Set TaskInitObj = ODStoreUI.GetObjByValue(AccessID, ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function	
	End If
	If (TaskInitObj Is Nothing) Then
		Exit Function
	End If
	
	'получение должности пользователя
	'<patch Получение должности делается по условию. Раньше всегда делался запрос. 2015.02.06. Tambiev>
	If ( TaskInitObj.myType = "User" ) Then
		Set Position = Person
	ElseIf ( TaskInitObj.myType = "Pos" ) Then
		
		Dim TaskInitPos As New PositionObj, TaskInitPosUser As Person
		If ( TaskInitPos.Init(TaskInitObj.doc, ErrorStr) <> 1 ) Then
			MsgBox ErrorStr, 48, ERR_MSG_TITLE
			DWFACompleteVisa = 0
			Exit Function
		End If
		Set TaskInitPosUser = TaskInitPos.person
		If ( Not ( TaskInitPosUser Is Nothing ) ) Then
			If ( TaskInitPosUser.ObjID = Person.ObjID ) Then
				Set Position = TaskInitObj
			Else
				GoTo getUserPos
			End If
		Else
			GoTo getUserPos			
		End If
	Else
getUserPos:
		Set Position = Person.GetUserPosition(ErrorStr)
		If (ErrorStr <> "") Then
			MsgBox ErrorStr, 48, ERR_MSG_TITLE
			DWFACompleteVisa = 0
			Exit Function	
		End If
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	'</patch>
	
	Set ViewVisa = db.GetView("(VisaByFullID)")
	If (ViewVisa Is Nothing) Then
		Msgbox {Не найдено представление "(VisaByFullID)"}, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function
	End If
	Call ViewVisa.Refresh()
	ViewVisa.AutoUpdate = False
	
	key = docMain.CustomID(0) & {-} & docMain.StageExclusionID(0) & {-} & Ucase(TaskInitObj.ObjAccess)
	Set colVisa = ViewVisa.GetAllDocumentsByKey(key)
	If (colVisa.Count = 0) Then
		Msgbox {Не найдена виза, выданная от имени "} & TaskInitObj.ObjName & {"}, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function
	End If
	If (colVisa.Count > 1) Then
		Msgbox {Количество виз, выданных от имени "} & TaskInitObj.ObjName & {": } & Cstr(colVisa.Count), 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function
	End If
	
	Set docVisa = colVisa.GetFirstDocument
	If (docVisa.Complete(0) = "1") Then
		Msgbox {Визирование от имени "} & TaskInitObj.ObjName & {" уже завершено}, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function
	End If
	
%REM
проверка, что виза заполнена
%END REM
	Dim IsContinue As Integer
	Dim docTemp As NotesDocument
	Dim ws As New NotesUIWorkspace
	Dim VisaItem As NotesItem
	Dim VisaValue As Variant
	Dim PlusValueList As Variant
	Dim MinusValueList As Variant
	Dim VisaSetCommentValueList As Variant
	Dim hasMatchPlus As Integer, hasMatchMinus As Integer
	Dim hasMatchSetComment As Integer
	Dim hasComment As Integer
	Dim i As Integer, j As Integer
	
	IsContinue =1
	If (docVisa.HasItem("VisaValue")) Then
		VisaValue = docVisa.GetFirstItem("VisaValue").Values
		If (VisaValue(0) = "") Then
			IsContinue =0
		End If
	Else
		IsContinue =0
	End If
	
	If (IsContinue <> 0) Then
	'смотрим положительные решение
		PlusValueList = docVisa.GetFirstItem("VisaPlusValueList").Values
		If (PlusValueList(0) <> "") Then
			For i=Lbound(VisaValue) To Ubound(VisaValue)
				For j=Lbound(PlusValueList) To Ubound(PlusValueList)
					If ( Lcase(VisaValue(i))	= Lcase(PlusValueList(j)) ) Then
						hasMatchPlus = 1
						Exit For
					End If
				Next
				If (hasMatchPlus = 1) Then Exit For
			Next
		End If
		
		'смотрим отрицательное решение
		MinusValueList = docVisa.GetFirstItem("VisaMinusValueList").Values
		If (MinusValueList(0) <> "") Then
			For i=Lbound(VisaValue) To Ubound(VisaValue)
				For j=Lbound(MinusValueList) To Ubound(MinusValueList)
					If ( Lcase(VisaValue(i))	= Lcase(MinusValueList(j)) ) Then
						hasMatchMinus = 1
						Exit For
					End If
				Next
				If (hasMatchMinus = 1) Then Exit For
			Next
		End If
		
		If ( (hasMatchPlus = 1) And (hasMatchMinus = 1) ) Then
			Msgbox {Не однозначное решение.} & Chr(13) & {Обратитесь к администратору}, 48, ERR_MSG_TITLE
			DWFACompleteVisa = 0
			Exit Function
		Elseif ( (hasMatchPlus = 0) And (hasMatchMinus = 0) ) Then
			Msgbox {Не однозначное решение.} & Chr(13) & {Обратитесь к администратору}, 48, ERR_MSG_TITLE
			DWFACompleteVisa = 0
			Exit Function
		End If
		
		
		VisaSetCommentValueList = docVisa.GetFirstItem("VisaSetCommentValueList").Values
		If (VisaSetCommentValueList(0) <> "") Then
			For i=Lbound(VisaValue) To Ubound(VisaValue)
				For j=Lbound(VisaSetCommentValueList) To Ubound(VisaSetCommentValueList)
					If ( Lcase(VisaValue(i))	= Lcase(VisaSetCommentValueList(j)) ) Then
						hasMatchSetComment = 1
						Exit For
					End If
				Next
				If (hasMatchSetComment = 1) Then Exit For
			Next
		End If		
		
		
	End If
	
%REM	
	Set docTemp = db.CreateDocument
	If (IsContinue <> 1) Then
		docTemp.VisaValue = "0"
	Else
		If (hasMatchPlus = 1) Then
			docTemp.VisaValue = "1"
		End If
		If (hasMatchMinus = 1) Then
			docTemp.VisaValue = "-1"
		End If
	End If
	
	If ( Not (ws.DialogBox("DWFVisaSolution", True, True, False, False, False, False, "Визовое решение", docTemp,_
	True,, False) )) Then
		DWFACompleteVisa = 0
		Exit Function
	End If
%END REM
	
	If (IsContinue <> 1) Then
		Msgbox {Виза не выдана}, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function
	End If
	
	If ((docVisa.VisaComment(0) <> "") Or (docVisa.HasEmbedded)) Then
		hasComment =1
	End If
	If ((hasMatchSetComment = 1) And  (hasComment <>1)) Then
		Msgbox {Необходимо ввести замечание(я) или приложить документ(ы)}, 48, ERR_MSG_TITLE
		DWFACompleteVisa = 0
		Exit Function
	End If	
	
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "CompleteVisa"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.docVisaID		= docVisa.UniversalID
	docMail.UserName 		= session.UserName
	docMail.UserPosID 		= Position.ObjAccess 
	docMail.CompleteAsObjID 	= TaskInitObj.ObjAccess 
	docMail.CompleteByObjID 	= TaskInitObj.ObjAccess 
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFACompleteVisa = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFACompleteVisa = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	On Error 4091 Resume Next 'bad unid
	Set docVisa = db.GetDocumentByUNID(docMail.docVisaUNID(0))
	If (docVisa Is Nothing) Then
		DWFACompleteVisa = 0
		Msgbox {Ошибка при попытке завершить стадию: docVisa Is Nothing}, 48, ERR_MSG_TITLE
		Exit Function	
	End If
	
	
	
	DWFACompleteVisa = 1
	
	
	Exit Function
errh:
	DWFACompleteVisa = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFACompleteVisa) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFACheckUITask:1:8
Function DWFACheckUITask(doc As NotesDocument, docMain As NotesDocument, UITaskValue List As UITaskValue) As Integer
	On Error Goto errh
	
	Dim UITaskStore As New UITaskStore
	Dim ErrorStr As String
	
	If (UITaskStore.Init(doc, ErrorStr) <> 1) Then
		If (ErrorStr <> "") Then
			Msgbox ErrorStr, 48, ERR_MSG_TITLE
		End If
		DWFACheckUITask = 0
		Exit Function	
	End If
	
	If (UITaskStore.SetUITask(docMain, UITaskValue, ErrorStr) <> 1) Then
		If (ErrorStr <> "") Then
			Msgbox ErrorStr, 48, ERR_MSG_TITLE
		End If
		DWFACheckUITask = 0
		Exit Function	
	End If
	
	DWFACheckUITask = 1
	
	Exit Function
errh:
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFACheckUITask) "DWFAppLib"},, {Error}
	Resume endh
endh:
End Function



'++LotusScript Development Environment:2:1:DWFAGetObjIDByProcessItem:2:8
Function DWFAGetObjIDByProcessItem(_
doc As NotesDocument, ItemPrefix As String, ODStoreUI As ODStoreUI, TaskTitle As String, AccessID As String) As Integer
	On Error Goto errh
	
	Dim ItemMember As NotesItem
	Dim v As Variant
	Dim ODObj As ODObj
	Dim ErrorStr As String
	Dim db As NotesDatabase
	Dim docTemp  As NotesDocument
	
	
	Set ItemMember = doc.GetFirstItem(ItemPrefix & "ObjID")
	If (ItemMember Is Nothing) Then
		AccessID = "<anybody>"
		DWFAGetObjIDByProcessItem = 1
		Exit Function
	End If
	
	v = ItemMember.Values
	If (Ubound(v) = 0) Then
		If (v(0) = "") Then
			AccessID = "<anybody>"
			DWFAGetObjIDByProcessItem = 1
			Exit Function	
		End If
	End If
	
	Set db  = doc.ParentDatabase
	Set docTemp = db.CreateDocument
	Forall ID In v
		Set ODObj = ODStoreUI.GetObjByValue(Cstr(ID), ErrorStr)
		If (ErrorStr <> "") Then
			Msgbox ErrorStr, 48, ERR_MSG_TITLE
			DWFAGetObjIDByProcessItem = 0
			Exit Function	
		End If
		If (ODObj Is Nothing) Then
			DWFAGetObjIDByProcessItem = 0
			Exit Function
		End If
		If (ODObj.WriteInAppend(docTemp, "ProcessInitiator", ErrorStr) <> 1) Then
			Msgbox ErrorStr, 48, ERR_MSG_TITLE
			DWFAGetObjIDByProcessItem = 0
			Exit Function
		End If
	End Forall
	
	If (DWFAGetTaskInitObj(docTemp, "ProcessInitiator", TaskTitle, AccessID) <> 1) Then
		DWFAGetObjIDByProcessItem = 0
		Exit Function
	End If
	
	
	
	DWFAGetObjIDByProcessItem = 1
	
	
	Exit Function
errh:
	DWFAGetObjIDByProcessItem = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAGetObjIDByProcessItem) "DWFAppLib"}
	Resume endh
endh:
End Function


'++LotusScript Development Environment:2:1:DWFAMakeVisa:1:8
Function DWFAMakeVisa(docMain As NotesDocument, docVisa As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim ViewVisa As NotesView
	Dim colVisa As NotesDocumentCollection
	Dim key As String
	
	Dim AccessID As String
	Dim v As Variant
	Dim docMail As NotesDocument
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAMakeVisa = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAMakeVisa = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAMakeVisa = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAMakeVisa = 0
		Exit Function	
	End If
	
	'получение пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAMakeVisa = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAMakeVisa = 0
		Exit Function	
	End If
		
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageOwner", {Визирование}, AccessID) <> 1) Then
		DWFAMakeVisa = 0
		Exit Function
	End If
	Set TaskInitObj = ODStoreUI.GetObjByValue(AccessID, ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAMakeVisa = 0
		Exit Function	
	End If
	If (TaskInitObj Is Nothing) Then
		Exit Function
	End If
	
	'получение должности пользователя
	'<patch Получение должности делается по условию. Раньше всегда делался запрос. 2015.02.06. Tambiev>
	If ( TaskInitObj.myType = "User" ) Then
		Set Position = Person
	ElseIf ( TaskInitObj.myType = "Pos" ) Then
		
		Dim TaskInitPos As New PositionObj, TaskInitPosUser As Person
		If ( TaskInitPos.Init(TaskInitObj.doc, ErrorStr) <> 1 ) Then
			MsgBox ErrorStr, 48, ERR_MSG_TITLE
			DWFAMakeVisa = 0
			Exit Function
		End If
		Set TaskInitPosUser = TaskInitPos.person
		If ( Not ( TaskInitPosUser Is Nothing ) ) Then
			If ( TaskInitPosUser.ObjID = Person.ObjID ) Then
				Set Position = TaskInitObj
			Else
				GoTo getUserPos
			End If
		Else
			GoTo getUserPos			
		End If
	Else
getUserPos:
		Set Position = Person.GetUserPosition(ErrorStr)
		If (ErrorStr <> "") Then
			MsgBox ErrorStr, 48, ERR_MSG_TITLE
			DWFAMakeVisa = 0
			Exit Function	
		End If
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	'</patch>
	
	Dim hasMatch As Variant
	If (docMain.HasItem("StageExecutorObjAccess")) Then
		v = docMain.GetFirstItem("StageExecutorObjAccess").Values
		If (v(0) <> "") Then
			Forall ID In v
				If (Lcase(ID) = Lcase(AccessID) ) Then
					hasMatch = 1
					Exit Forall
				End If
			End Forall
			If (hasMatch = 1) Then
				Msgbox {От имени "} & TaskInitObj.ObjName & {" виза уже создана}, 48, ERR_MSG_TITLE
				DWFAMakeVisa = 0
				Exit Function
			End If
		End If
	End If
	
	Set ViewVisa = db.GetView("(VisaByFullID)")
	If (ViewVisa Is Nothing) Then
		Msgbox {Не найдено представление "(VisaByFullID)"}, 48, ERR_MSG_TITLE
		DWFAMakeVisa = 0
		Exit Function
	End If
	Call ViewVisa.Refresh()
	ViewVisa.AutoUpdate = False
	
	key = docMain.CustomID(0) & {-} & docMain.StageExclusionID(0) & {-} & Ucase(TaskInitObj.ObjAccess)
	Set colVisa = ViewVisa.GetAllDocumentsByKey(key)
	If(colVisa.count = 1)Then 'в случаях, когда виза только одна и не закончена - считаем, что это глюк сохранения полей и разрешаем её редактировать
		Dim dVisa As NotesDocument
		Set dVisa = colVisa.Getfirstdocument()
		If(dVisa.getItemValue("Complete")(0) <> "1")Then
			Set docVisa = dVisa
			Call TaskInitObj.WriteInAppend(docMain, "StageExecutor", "")
			Call DWFAEditVisa(docMain)
			DWFAMakeVisa = 0
			Exit Function
		End If
	End If
	If (colVisa.Count <> 0) Then
		Msgbox _
		{От имени "} & TaskInitObj.ObjName & {" виза уже создана.} & Chr(13) &_
		{Количество виз: } & Cstr(colVisa.Count), 48, ERR_MSG_TITLE
		DWFAMakeVisa = 0
		Exit Function
	End If
	
	
	
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "MakeVisa"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.UserName 		= session.UserName
	docMail.UserPosID 		= Position.ObjAccess 'PosID
	docMail.MakeAsObjID 	= TaskInitObj.ObjAccess 'AccessID
	
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAMakeVisa = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAMakeVisa = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	On Error 4091 Resume Next 'bad unid
	Set docVisa = db.GetDocumentByUNID(docMail.docVisaUNID(0))
	If (docVisa Is Nothing) Then
		DWFAMakeVisa = 0
		Msgbox {Ошибка при попытке завершить стадию: docVisa Is Nothing}, 48, ERR_MSG_TITLE
		Exit Function	
	End If
	
	'Call docMail.Remove(True)
	
	
	
	
	
	
	DWFAMakeVisa = 1
	
	
	Exit Function
errh:
	DWFAMakeVisa = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAMakeVisa) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAGetTaskInitObj:2:8
Function DWFAGetTaskInitObj(_
	docMain As NotesDocument, ItemPrefix As String, TaskTitle As String, AccessID As String) As Integer
	On Error Goto errh
	
	Dim ws As New NotesUIWorkspace
	Dim db As NotesDatabase
	Dim docTemp As NotesDocument
	
	Dim StageMemberAccess As Variant
	Dim StageMemberID As Variant
	Dim StageMemberName As Variant
	Dim StageMemberPath As Variant
	Dim ItemMember As NotesItem
	Dim hasMatch As Integer
	Dim i As Integer, j As Integer
	Dim v As Variant
	
	Set db = docMain.ParentDatabase
	Set ItemMember = docMain.GetFirstItem(ItemPrefix & "ObjAccess")	
	If (ItemMember Is Nothing) Then
		DWFAGetTaskInitObj = 0
		Msgbox {Ошибка. ItemMember Is Nothing (} & ItemPrefix & {)}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	StageMemberAccess = ItemMember.Values
	If (StageMemberAccess(0) = "") Then
		DWFAGetTaskInitObj = 0
		Msgbox {Нет информации об участниках стадии}, 48, ERR_MSG_TITLE
		Exit Function	
	End If
	StageMemberID 		= docMain.GetItemValue(ItemPrefix & "ObjID")
	StageMemberName 	= docMain.GetItemValue(ItemPrefix & "ObjName")
	StageMemberPath 	= docMain.GetItemValue(ItemPrefix & "ObjPath")
	
	v = Evaluate({@UserNamesList})
	Redim matchList(0) As String
	For i=Lbound(StageMemberAccess) To Ubound(StageMemberAccess)
		For j=Lbound(v) To Ubound(v)
			If (Lcase(StageMemberAccess(i)) = Lcase(v(j))) Then
				hasMatch = 1
				If (matchList(0) <>"" ) Then
					Redim Preserve matchList(Ubound(matchList)+1) As String
				End If
				matchList(Ubound(matchList)) = StageMemberName(i) & {|} & StageMemberAccess(i)
			End If
		Next
	Next
	
	'<patch request="http://jira.tpsgroup.ru/browse/TLD-2609" author="Ramazan Salpagarov">
	If (hasMatch <>1) Then
		If ( docMain.Getitemvalue( "authors" )(0) <> "" ) Then
			Dim authors As Variant
			authors = ArrayUnique( docMain.Getitemvalue( "authors" ))
			For i=LBound(docMain.authors) To UBound(authors)
				For j=LBound(v) To UBound(v)
					If (LCase(authors(i)) = LCase(v(j))) Then
						hasMatch = 1
						If (matchList(0) <>"" ) Then
							ReDim Preserve matchList(UBound(matchList)+1) As String
						End If
						
						Dim posId As String, docOD As NotesDocument
						If ( InStr( authors(i), "dwf03_" )) Then
							posId = StrRight( authors(i), "dwf03_" )
							Set docOD = getPositionNotesDocumentById( posId )
							matchList(UBound(matchList)) = docOD.Title(0) & {|} & authors(i)
						ElseIf ( InStr( authors(i), "dwf05_" )) Then
							posId = StrRight( authors(i), "dwf05_" )
							Set docOD = getFGroupNotesDocumentById( posId )
							matchList(UBound(matchList)) = docOD.name(0) & {|} & authors(i)
						End If
					End If
				Next
			Next
		End If
	End If
	'</patch>
	
	If (hasMatch <>1) Then
		DWFAGetTaskInitObj = 0
		Msgbox {Вы не можете выполнять это действие}, 48, ERR_MSG_TITLE
		Exit Function	
	End If
	If (Ubound(matchList) > 0) Then
		Set docTemp = db.CreateDocument
		docTemp.Members = matchList
		docTemp.Promt = Ucase(TaskTitle) & ". КЛИКНИТЕ МЫШКОЙ ПО НУЖНОМУ ОБЪЕКТУ ДОСТУПА"
		
		If Not (ws.DialogBox("DWF104", True, True, False, False, False, False, db.Title, docTemp, True, False, True)) Then
			DWFAGetTaskInitObj = 0
			Exit Function
		End If
		If (docTemp.List(0) = "") Then
			DWFAGetTaskInitObj = 0
			Exit Function
		End If
		AccessID = docTemp.List(0)
	Else
		AccessID = Strright(matchList(0), {|})
	End If
	
	
	
	DWFAGetTaskInitObj = 1
	
	
	Exit Function
errh:
	DWFAGetTaskInitObj = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAGetTaskInitObj) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAAskForAction:1:8
Function DWFAAskForAction(docMail As NotesDocument) As Integer
	On Error Goto errh
	
	Dim db As NotesDatabase
	Dim Agent As NotesAgent
	Dim ViewID As NotesView
	Dim ID As String
	
	Set db = docMail.ParentDatabase
	
	Set Agent = db.GetAgent("(AskForAction)")
	If (Agent Is Nothing) Then
		DWFAAskForAction = 0
		Msgbox {В Центре обработки не найден агент "AskForAction"}, 16, ERR_MSG_TITLE
		Exit Function
	End If
	
	Set ViewID = db.GetView("(UNID)")
	If (ViewID Is Nothing) Then
		DWFAAskForAction = 0
		Msgbox {В Центре обработки не найдено представление "(UNID)"}, 16, ERR_MSG_TITLE
		Exit Function
	End If
	
	ID = docMail.UniversalID
	Call Agent.RunOnServer(docMail.NoteID)
	
	Call ViewID.Refresh
	ViewID.AutoUpdate = False
	
	Set docMail = ViewID.GetDocumentByKey(ID)
	If (docMail Is Nothing) Then
		DWFAAskForAction = 0
		Msgbox {Ошибка: docMail Is Nothing}, 16, ERR_MSG_TITLE
		Exit Function
	End If
	
	
	
	DWFAAskForAction = 1
	
	Exit Function
errh:
	DWFAAskForAction = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAskForAction) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAAdminCancelVisa:1:8
Function DWFAAdminCancelVisa(docMain As NotesDocument, VisaID As Variant) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim ErrorStr As String
	Dim AddObjID As Variant
	Dim docOD As NotesDocument
	Dim v As Variant	
	Dim docMail As NotesDocument
	
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAAdminCancelVisa = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAAdminCancelVisa = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAAdminCancelVisa = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAdminCancelVisa = 0
		Exit Function	
	End If
	
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAdminCancelVisa = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	
	If (VisaID(0) = "") Then
		Msgbox {Пустое значение ID для отмены визового решения}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "AdminCancelVisa"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.CancelVisaID	= VisaID
	docMail.UserName 		= session.UserName
	docMail.CancelByObjID 	= ODObj.ObjAccess
	
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAAdminCancelVisa = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAAdminCancelVisa = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	
	DWFAAdminCancelVisa = 1
	
	Exit Function
errh:
	DWFAAdminCancelVisa = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAAdminCancelVisa) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAAddDocAdd:1:8
Function DWFAAddDocAdd(docMain As NotesDocument, docAddDoc As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim AccessID As String
	Dim v As Variant
	Dim docMail As NotesDocument
	
	
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAAddDocAdd = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAAddDocAdd = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAAddDocAdd = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocAdd = 0
		Exit Function	
	End If
	
	'получение должности пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocAdd = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocAdd = 0
		Exit Function	
	End If
	
	Set Position = Person.GetUserPosition(ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocAdd = 0
		Exit Function	
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageExecutor", {Добавить доп. документ}, AccessID) <> 1) Then
		DWFAAddDocAdd = 0
		Exit Function
	End If
	Set TaskInitObj = ODStoreUI.GetObjByValue(AccessID, ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocAdd = 0
		Exit Function	
	End If
	If (TaskInitObj Is Nothing) Then
		Exit Function
	End If
	
	
	
	Dim docStage As NotesDocument
	Dim addDocStoreUI As AdditionalDocumentStoreUI
	Dim AddDocID As String
	
	On Error 4091 Resume Next 'bad unid
	Set docStage = db.GetDocumentByUNID(docMain.StageID(0))
	On Error Goto errh
	If (docStage Is Nothing) Then
		Msgbox {Не найден документ стадии (docStage Is Nothing)}, 48, ERR_MSG_TITLE
		DWFAAddDocAdd = 0
		Exit Function	
	End If
	
	Set addDocStoreUI = New AdditionalDocumentStoreUI(docMain, "AddDoc", docStage)
	If (addDocStoreUI.GetAdditionalDocID(AddDocID, ErrorStr) <>1 ) Then
		If (ErrorStr <> "") Then
			Msgbox ErrorStr, 48, ERR_MSG_TITLE
		End If
		DWFAAddDocAdd = 0
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "AddDocAdd"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.UserName 		= session.UserName
	docMail.UserPosID 		= Position.ObjAccess 
	docMail.AddAsObjID 		= TaskInitObj.ObjAccess 
	docMail.AddDocID		= AddDocID
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAAddDocAdd = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAAddDocAdd = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	On Error 4091 Resume Next 'bad unid
	Set docAddDoc = db.GetDocumentByUNID(docMail.docAddDocUNID(0))
	If (docAddDoc Is Nothing) Then
		DWFAAddDocAdd = 0
		Msgbox {Ошибка при попытке создать дополнительный документ: docAddDoc Is Nothing}, 48, ERR_MSG_TITLE
		Exit Function	
	End If
	
	
	
	
	
	
	
	
	
	DWFAAddDocAdd = 1
	
	
	Exit Function
errh:
	DWFAAddDocAdd = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAAddDocAdd) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAAdminCompleteStage:1:8
Function DWFAAdminCompleteStage(docMain As NotesDocument, docLink As NotesDocument) As Integer
	Const TITLE = "Административное завершение стадии"
	DWFAAdminCompleteStage = 0		

	Dim Reason As String, ws As New notesuiworkspace
	Reason = ws.Prompt(6, TITLE, "Введите причину административного завершения", "Заявка №", "Заявка №")
	If Reason = "" Then Exit Function 
	
	Call DWFAAdminCompleteStage_(docMain, docLink, Reason, TITLE)
	Call ws.CurrentDocument.Close(True)
End Function




'++LotusScript Development Environment:2:1:DWFAInitProcess:1:8
Function DWFAInitProcess(docProcess As NotesDocument, docMain As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim v As Variant
	Dim InitObjID As String
	Dim docMail As NotesDocument
	
	Dim UITaskValueList List As UITaskValue
	
	
	Set db = docProcess.parentDatabase
	v = docProcess.PCenter(0)
	If (v = "") Then
		Msgbox {В документе "Процесса" не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAInitProcess = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAInitProcess = 0
		Exit Function	
	End If
	
	v = docProcess.OrgDir(0)
	If (v = "") Then
		Msgbox {В документе "Процесса" не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAInitProcess = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAInitProcess = 0
		Exit Function	
	End If
	
'%REM
	If (DWFACheckUITask(docProcess, docMain, UITaskValueList) <>1) Then
		Exit Function
	End If
'%END REM	
	
	
	
	
	'получение должности пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAInitProcess = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAInitProcess = 0
		Exit Function	
	End If
	
	Set Position = Person.GetUserPosition(ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAInitProcess = 0
		Exit Function	
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	
	
	'получение инфы от имени кого инициирует
	If (DWFAGetObjIDByProcessItem(docProcess, "ProcessInitiator", ODStoreUI, "Инициировать процесс", InitObjID) <> 1) Then
		DWFAInitProcess = 0
		Exit Function	
	End If
	If (Not Isarray(InitObjID)) Then
		If (InitObjID = "<anybody>") Then
			InitObjID = Position.ObjAccess
		End If
	End If
	
	'проверка не заблокирован ли инициатор <add 2016.11.29 by Tambiev>
	Dim checkResult As Integer
	checkResult = DWFAInitProcessIsInitObjBlocked( docProcess, ODStoreUI, InitObjID )
	If ( checkResult  = 1 ) Or ( checkResult  = -1 ) Then
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 		= "Task"
	docMail.Action 	= "InitProcess"
	docMail.InitServer 	= db.Server
	docMail.AppPath 	= db.FilePath
	docMail.ProcessID 	= docProcess.UniversalID
	docMail.UserName 	= session.UserName
	docMail.InitPosID 	= Position.ObjAccess 
	docMail.InitObjID 	= InitObjID
	If Not(docMain Is Nothing)Then Call docMail.replaceItemValue("initOnDocId", docMain.Universalid)
	
	Forall x In UITaskValueList
		Call docMail.ReplaceItemValue(Listtag(x) & {$IsRun}, x.isrun)
		Call docMail.ReplaceItemValue(Listtag(x) & {$Type}, x.valuetype)
		Call docMail.ReplaceItemValue(Listtag(x) & {$Value}, x.value)
	End Forall
	
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAInitProcess = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAInitProcess = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	On Error 4091 Resume Next 'bad unid
	Set docMain = db.GetDocumentByUNID(docMail.docMainUNID(0))
	If (docMain Is Nothing) Then
		DWFAInitProcess = 0
		Msgbox {Ошибка при инициации процесса: docMain Is Nothing}, 48, ERR_MSG_TITLE
		Exit Function	
	End If
	
	'Call docMail.Remove(True)
	
	DWFAInitProcess = 1
	
	
	Exit Function
errh:
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAInitProcess) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFACompleteStage:1:8
Function DWFACompleteStage(docMain As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	Dim Continue As Integer
	
	Dim docStage As NotesDocument
	Dim UITaskValueList List As UITaskValue
	
	Dim v As Variant	
	Dim AccessID As String
	Dim docMail As NotesDocument

	Set db = docMain.ParentDatabase
	On Error 4091 Resume Next 'bad unid
	Set docStage = db.GetDocumentByUNID(docMain.StageID(0))
	On Error Goto errh
	If (docStage Is Nothing) Then
		Msgbox {Не найден документ Стадии}, 16, ERR_MSG_TITLE
		DWFACompleteStage = 0
		Exit Function
	End If
	
	If (Lcase(docMain.GetItemValue("StatusState")(0)) <> Lcase("Claim")) Then
		DWFACompleteStage = 0
		Msgbox {Прежде чем завершить стадию, необходимо "занять" документ}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
'%REM
	If (DWFACheckUITask(docStage, docMain, UITaskValueList) <>1) Then
		Exit Function
	End If
'%END REM
	
	' http://jira.tpsgroup.ru/browse/TLD-3541
	' запоминаем результаты уи-запросов доков в документе
	Dim tasks List As Variant, z As Variant, temp As Variant
	ForAll x In UITaskValueList
		If(IsElement(tasks(x.valueType)))Then
			z = tasks(x.valuetype)
			ReDim Preserve z(UBound(z) + 1)
		Else
			ReDim z(0)As String
		End If
		temp = x.value
		If(IsArray(temp))Then temp = Join(temp, "|")
		z(UBound(z)) = CStr(x.isRun) & "#" & temp
		tasks(x.valueType) = z
	End ForAll
	
	z = Split("ODObj#Other#AddDoc", "#")
	ForAll c In z
		If(IsElement(tasks(c)))Then
			Call docMain.Replaceitemvalue("StageUITask" & c, tasks(c))
		Else
			Call docMain.Replaceitemvalue("StageUITask" & c, "")
		End If
	End ForAll
	Call docMain.Save(True, False)
	
	If (DWFACheckCompleteStage(docMain, Continue) <> 1) Then
		DWFACompleteStage = 0
		Exit Function
	End If
	If (Continue <> 1) Then
		DWFACompleteStage = 0
		Exit Function
	End If
	
	'--------------------------------------------------------------
	Erase UITaskValueList, tasks, z
	If (DWFACheckUITaskAddDoc(docStage, docMain, UITaskValueList) <> 1) Then
		Exit Function
	End If
	
	ForAll x In UITaskValueList
		If(IsElement(tasks(x.valueType)))Then
			z = tasks(x.valuetype)
			ReDim Preserve z(UBound(z) + 1)
		Else
			ReDim z(0) As String
		End If
		temp = x.value
		If (IsArray(temp)) Then 
			temp = Join(temp, "|")
		End if
		z(UBound(z)) = CStr(x.isRun) & "#" & temp
		tasks(x.valueType) = z
	End ForAll
	
	If(IsElement(tasks("AddDoc")))Then
		Call docMain.Replaceitemvalue("StageUITaskAddDoc", tasks("AddDoc"))
	Else
		Call docMain.Replaceitemvalue("StageUITaskAddDoc", "")
	End If
	
	Call docMain.Save(True, False)
	'--------------------------------------------------------------
	If (DWFACheckCompleteStageAddDoc(docMain, Continue) <> 1) Then
		DWFACompleteStage = 0
		Exit Function
	End If
	If (Continue <> 1) Then
		DWFACompleteStage = 0
		Exit Function
	End If
	'--------------------------------------------------------------
	
	If (Messagebox({Вы уверены, что хотите завершить стадию?}, 4+32, {Внимание!} ) <> 6) Then
		DWFACompleteStage = 0		
		Exit Function
	End If	
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFACompleteStage = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFACompleteStage = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFACompleteStage = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFACompleteStage = 0
		Exit Function	
	End If
	
	'получение должности пользователя
	If (Not (docMain.HasItem("StageExecutorObjAccess"))) Then
		Msgbox {Нет информации о текущем владельце стадии}, 48, ERR_MSG_TITLE
		DWFACompleteStage = 0
		Exit Function
	End If
	v = docMain.GetFirstItem("StageExecutorObjAccess").Values
	If (Ubound(v) > 0) Then
		Msgbox {Ошибка: Неоднозначный владелец стадии}, 48, ERR_MSG_TITLE
		DWFACompleteStage = 0
		Exit Function
	Else
		Set ODObj = ODStoreUI.GetObjByValue(Cstr(v(0)), ErrorStr)
		If (ErrorStr <> "") Then
			Msgbox ErrorStr, 48, ERR_MSG_TITLE
			DWFACompleteStage = 0
			Exit Function	
		End If
		If (ODObj Is Nothing) Then
			Exit Function
		End If
	End If
	
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageExecutor", {Завершение стадии}, AccessID) <> 1) Then
		DWFACompleteStage = 0
		Exit Function
	End If
	If (Lcase(ODObj.ObjAccess) <> Lcase(AccessID)) Then
		Msgbox {Несоответствие объекта доступа и владельца стадии}, 48, ERR_MSG_TITLE
		DWFACompleteStage = 0
		Exit Function
	End If
	
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "CompleteStage"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.UserName 		= session.UserName
	docMail.UserPosID 		= ODObj.ObjAccess
	docMail.CompleteByObjID 	= AccessID
	
	Forall x In UITaskValueList
		Call docMail.ReplaceItemValue(Listtag(x) & {$IsRun}, x.isrun)
		Call docMail.ReplaceItemValue(Listtag(x) & {$Type}, x.valuetype)
		Call docMail.ReplaceItemValue(Listtag(x) & {$Value}, x.value)
	End Forall
	
	
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFACompleteStage = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFACompleteStage = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	On Error 4091 Resume Next 'bad unid
	Set docMain = db.GetDocumentByUNID(docMail.docMainUNID(0))
	If (docMain Is Nothing) Then
		DWFACompleteStage = 0
		Msgbox {Ошибка при попытке завершить стадию: docMain Is Nothing}, 48, ERR_MSG_TITLE
		Exit Function	
	End If
	
	'Call docMail.Remove(True)
	
	
	
	
	
	
	
	DWFACompleteStage = 1
	
	
	Exit Function
errh:
	DWFACompleteStage = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFACompleteStage) "DWFAppLib"}
	Resume endh
endh:
End Function



'++LotusScript Development Environment:2:1:DWFAAdminCompleteStage_:1:8
Function DWFAAdminCompleteStage_(docMain As NotesDocument, docLink As NotesDocument, Reason As String, ActionName As string) As Integer
	
	On Error GoTo errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	Dim v As Variant	
	
	DWFAAdminCompleteStage_ = 0		

	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then Error 1000, {В документе не задан Центр Обработки}

	If (DWFSGetDatebase(CStr(v), dbPC) <> 1)Then Error 1000, {Не найдена база Центра Обработки}
	v = docMain.dbODPath(0)
	If (v = "") Then Error 1000, {В документе не задана Орг. директория}
	
	Set ODStoreUI = New ODStoreUI(CStr(v), ErrorStr)
	If (ErrorStr <> "") Then Error 1000, ErrorStr
	
	Set ODObj = ODStoreUI.GetObjByValue(CStr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then Error 1000, ErrorStr
	If (ODObj Is Nothing) Then Exit Function
	
	Dim docMail As NotesDocument
	Set docMail = dbPC.CreateDocument
	With docMail
		.Form 				= "Task"
		.Action 			= "AdminCompleteStage"
		.InitServer 		= db.Server
		.AppPath 			= db.FilePath
		.ProcessID 			= docMain.GetItemValue("PROCESSID")(0)
		.docMainID 			= docMain.UniversalID
		.UserName 			= session.UserName
		.CompleteByObjID 	= ODObj.ObjAccess
		.Reason				= Reason
		.ActionName			= ActionName
		.docLinkID 			= docLink.UniversalID
		Call .Save(True, True)		
	End With
	
	If (DWFAAskForAction(docMail) <> 1) Then Exit Function	
	If (docMail.Error(0) <> "") Then Error 1000, docMail.Error(0)
	
	On Error 4091 Resume Next 'bad unid
	Set docMain = db.GetDocumentByUNID(docMail.docMainUNID(0))
	If (docMain Is Nothing) Then Error 1000, "Ошибка при попытке завершить стадию: docMain Is Nothing"
	
	DWFAAdminCompleteStage_ = 1
	
	Exit Function
errh:
	If Err = 1000 Then
		MsgBox Error$, 48, ERR_MSG_TITLE
	Else
		DWFAAdminCompleteStage_ = -1
		MsgBox Error$ & {. Error # } & CStr(Err) & { on line # } & CStr(Erl) & { in (DWFAAdminCompleteStage) "DWFAppLib"}
	End If
	Resume endh
endh:
End Function


'++LotusScript Development Environment:2:1:DWFAEditVisa:1:8
Function DWFAEditVisa(docMain As NotesDocument) As Integer
	On Error Goto errh
	
	Dim ws As New NotesUIWorkspace
	Dim db As NotesDatabase
	Dim v As Variant
	Dim AccessID As String
	Dim ODStoreUI As ODStoreUI
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	Dim ViewVisa As NotesView
	Dim key As String
	Dim colVisa As NotesDocumentCollection
	Dim docVisa As NotesDocument
	
	
	Set db = docMain.ParentDatabase
	
	
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAEditVisa = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAEditVisa = 0
		Exit Function	
	End If
	
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageExecutor", {Редактирование визы}, AccessID) <> 1) Then
		DWFAEditVisa = 0
		Exit Function
	End If
	Set TaskInitObj = ODStoreUI.GetObjByValue(AccessID, ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAEditVisa = 0
		Exit Function	
	End If
	If (TaskInitObj Is Nothing) Then
		Exit Function
	End If
	
	Set ViewVisa = db.GetView("(VisaByFullID)")
	If (ViewVisa Is Nothing) Then
		Msgbox {Не найдено представление "(VisaByFullID)"}, 48, ERR_MSG_TITLE
		DWFAEditVisa = 0
		Exit Function
	End If
	Call ViewVisa.Refresh()
	ViewVisa.AutoUpdate = False
	
	key = docMain.CustomID(0) & {-} & docMain.StageExclusionID(0) & {-} & Ucase(TaskInitObj.ObjAccess)
	Set colVisa = ViewVisa.GetAllDocumentsByKey(key)
	If (colVisa.Count = 0) Then
		Msgbox {Не найдена виза, выданная от имени "} & TaskInitObj.ObjName & {"}, 48, ERR_MSG_TITLE
		DWFAEditVisa = 0
		Exit Function
	End If
	If (colVisa.Count > 1) Then
		Msgbox {Количество виз, выданных от имени "} & TaskInitObj.ObjName & {": } & Cstr(colVisa.Count), 48, ERR_MSG_TITLE
		DWFAEditVisa = 0
		Exit Function
	End If
	
	Set docVisa = colVisa.GetFirstDocument
	If (docVisa.Complete(0) = "1") Then
		Call ws.EditDocument(False, docVisa,,,, False)
	Else
		Call ws.EditDocument(True, docVisa,,,, False)
	End If
	
	DWFAEditVisa = 1
	
	
	Exit Function
errh:
	DWFAEditVisa = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAEditVisa) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAAddDocReturn:1:8
Function DWFAAddDocReturn(docMain As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim AccessID As String
	Dim v As Variant
	Dim docMail As NotesDocument
	
	
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAAddDocReturn = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAAddDocReturn = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAAddDocReturn = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocReturn = 0
		Exit Function	
	End If
	
	'получение должности пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocReturn = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocReturn = 0
		Exit Function	
	End If
	
	Set Position = Person.GetUserPosition(ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocReturn = 0
		Exit Function	
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageExecutor", {Вернуть доп. документ}, AccessID) <> 1) Then
		DWFAAddDocReturn = 0
		Exit Function
	End If
	Set TaskInitObj = ODStoreUI.GetObjByValue(AccessID, ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAAddDocReturn = 0
		Exit Function	
	End If
	If (TaskInitObj Is Nothing) Then
		Exit Function
	End If
	
	
	
	Dim docStage As NotesDocument
	Dim addDocStoreUI As AdditionalDocumentStoreUI
	Dim AddDocID As String
	
	On Error 4091 Resume Next 'bad unid
	Set docStage = db.GetDocumentByUNID(docMain.StageID(0))
	On Error Goto errh
	If (docStage Is Nothing) Then
		Msgbox {Не найден документ стадии (docStage Is Nothing)}, 48, ERR_MSG_TITLE
		DWFAAddDocReturn = 0
		Exit Function	
	End If
	
	Set addDocStoreUI = New AdditionalDocumentStoreUI(docMain, "AddDoc", docStage)
	If (addDocStoreUI.GetAddDocID(Position.ObjAccess, 1, AddDocID, ErrorStr) <>1 ) Then
		If (ErrorStr <> "") Then
			Msgbox ErrorStr, 48, ERR_MSG_TITLE
		End If
		DWFAAddDocReturn = 0
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "AddDocReturn"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.UserName 		= session.UserName
	docMail.UserPosID 		= Position.ObjAccess 
	docMail.RemoveAsObjID 	= TaskInitObj.ObjAccess 
	docMail.AddDocID		= AddDocID
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAAddDocReturn = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAAddDocReturn = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	
	
	
	
	
	
	DWFAAddDocReturn = 1
	
	
	Exit Function
errh:
	DWFAAddDocReturn = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAAddDocReturn) "DWFAppLib"}
	Resume endh
endh:	
End Function

'++LotusScript Development Environment:2:1:DWFAClaimCancel:1:8
Function DWFAClaimCancel(docMain As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim ErrorStr As String
	Dim v As Variant	
	Dim docMail As NotesDocument
	
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAClaimCancel = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAClaimCancel = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAClaimCancel = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAClaimCancel = 0
		Exit Function	
	End If
	
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAClaimCancel = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 				= "Task"
	docMail.Action 			= "ClaimCancel"
	docMail.InitServer 			= db.Server
	docMail.AppPath 			= db.FilePath
	docMail.ProcessID 			= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 			= docMain.UniversalID
	docMail.UserName 			= session.UserName
	docMail.ClaimCancelByObjID	= ODObj.ObjAccess
	
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAClaimCancel = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAClaimCancel = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	
	
	
	DWFAClaimCancel = 1
	
	
	Exit Function
errh:
	DWFAClaimCancel = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAClaimCancel) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAMakeVisaBySetVisaParent:1:8
Function DWFAMakeVisaBySetVisaParent(docMain As NotesDocument, docVisa As NotesDocument) As Integer
	On Error Goto errh
	
	Dim ws As New NotesUIWorkspace
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim ViewVisa As NotesView
	Dim colVisa As NotesDocumentCollection
	Dim key As String
	
	Dim docVisaParent As NotesDocument
	Dim docTemp As NotesDocument
	Dim ItemRef As NotesItem
	
	Dim AccessID As String
	Dim v As Variant
	Dim docMail As NotesDocument
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function	
	End If
	
	
	'получение должности пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function	
	End If
	
	Set Position = Person.GetUserPosition(ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function	
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageOwner", {Визирование}, AccessID) <> 1) Then
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function
	End If
	Set TaskInitObj = ODStoreUI.GetObjByValue(AccessID, ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function	
	End If
	If (TaskInitObj Is Nothing) Then
		Exit Function
	End If
	
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	Set ViewVisa = db.GetView("(VisaByFullID)")
	If (ViewVisa Is Nothing) Then
		Msgbox {Не найдено представление "(VisaByFullID)"}, 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function
	End If
	Call ViewVisa.Refresh()
	ViewVisa.AutoUpdate = False
	
	If (Not docMain.HasItem("MarkVisaStageExclusionID")) Then
		Msgbox {В документе нет признака "MarkVisaStageExclusionID". Обратитесь к администратору}, 16, ERR_MSG_TITLE
		Exit Function
	End If
	
	key = docMain.CustomID(0) & {-} & docMain.MarkVisaStageExclusionID(0) & {-} & Ucase(TaskInitObj.ObjAccess)
	Set colVisa = ViewVisa.GetAllDocumentsByKey(key)
	
	If(colVisa.count = 0)Then
		Dim res As Integer
		res = DWFAMakeVisa(docMain, docVisa)
		DWFAMakeVisaBySetVisaParent = res
		If(res = 1)Then
			Call docVisa.replaceItemValue("isFakeResponse", "1")
			Call docVisa.save(True, True)
		End If
		Exit Function 
	End If
	
	If (colVisa.Count <> 1) Then
		Msgbox _
		{От имени "} & TaskInitObj.ObjName & {" должна быть одна виза.} & Chr(13) &_
		{Количество виз: } & Cstr(colVisa.Count), 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function
	End If
	Set docVisaParent = colVisa.GetFirstDocument	
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~	
	
	
	Dim hasMatch As Variant
	If (docMain.HasItem("StageExecutorObjAccess")) Then
		v = docMain.GetFirstItem("StageExecutorObjAccess").Values
		If (v(0) <> "") Then
			Forall ID In v
				If (Lcase(ID) = Lcase(AccessID) ) Then
					hasMatch = 1
					Exit Forall
				End If
			End Forall
			If (hasMatch = 1) Then
				Msgbox {От имени "} & TaskInitObj.ObjName & {" виза уже создана}, 48, ERR_MSG_TITLE
				DWFAMakeVisaBySetVisaParent = 0
				Exit Function
			End If
		End If
	End If
	
	Set ViewVisa = db.GetView("(VisaByFullID)")
	If (ViewVisa Is Nothing) Then
		Msgbox {Не найдено представление "(VisaByFullID)"}, 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function
	End If
	Call ViewVisa.Refresh()
	ViewVisa.AutoUpdate = False
	
	key = docMain.CustomID(0) & {-} & docMain.StageExclusionID(0) & {-} & Ucase(TaskInitObj.ObjAccess)
	Set colVisa = ViewVisa.GetAllDocumentsByKey(key)
	If (colVisa.Count <> 0) Then
		Msgbox _
		{От имени "} & TaskInitObj.ObjName & {" виза уже создана.} & Chr(13) &_
		{Количество виз: } & Cstr(colVisa.Count), 48, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function
	End If
	
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "MakeVisa"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.UserName 		= session.UserName
	docMail.UserPosID 		= Position.ObjAccess 'PosID
	docMail.MakeAsObjID 	= TaskInitObj.ObjAccess 'AccessID
	
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAMakeVisaBySetVisaParent = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	On Error 4091 Resume Next 'bad unid
	Set docVisa = db.GetDocumentByUNID(docMail.docVisaUNID(0))
	If (docVisa Is Nothing) Then
		DWFAMakeVisaBySetVisaParent = 0
		Msgbox {Ошибка при попытке завершить стадию: docVisa Is Nothing}, 48, ERR_MSG_TITLE
		Exit Function	
	End If
	
	Set docTemp = db.CreateDocument
	Call docTemp.MakeResponse(docVisaParent)
	Set ItemRef = docTemp.GetFirstItem("$Ref")
	If (ItemRef Is Nothing) Then
		Msgbox {Не удалось сформировать поле "$Ref"}, 16, ERR_MSG_TITLE
		DWFAMakeVisaBySetVisaParent = 0
		Exit Function
	End If
	Call ItemRef.CopyItemToDocument(docVisa, "ParentRef")
	Call docVisa.Save(True, True)
	
	
	
	DWFAMakeVisaBySetVisaParent = 1
	
	
	Exit Function
errh:
	DWFAMakeVisaBySetVisaParent = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAMakeVisaBySetVisaParent) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAAdminGetProcessStagePostLink:1:8
Function DWFAAdminGetProcessStagePostLink(docMain As NotesDocument, docLink As NotesDocument) As Integer
	On Error Goto errh
	
	Dim ws As New NotesUIWorkspace
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim ViewLinkByEndID As NotesView
	Dim colLink As NotesDocumentCollection
	Dim ProcessID As String
	Dim StageID As String
	Dim v As Variant
	Dim docTemp As NotesDocument
	
	Dim View As NotesView
	Dim col As NotesDocumentCollection
	Dim docP As NotesDocument
	
	Set db = session.CurrentDatabase
	
	Set View = db.GetView("($DWFProcess&Stages)")
	If (View Is Nothing) Then
		Msgbox {Не найдено представление "($DWFProcess&Stage)"}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	ProcessID = docMain.ProcessID(0)
	If (Cstr(ProcessID) = "") Then
		Msgbox {Нет информации о Процессе}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	
	Set col = ws.PickListCollection(_
	PICKLIST_CUSTOM,_
	False,_
	db.Server,_
	db.FilePath,_
	{($DWFProcess&Stages)},_
	db.Title & {. Процесс и стадии},_
	Ucase({Выберите стадию, где задана Связь для перехода к конечной стадии}),_
	ProcessID)
	If (Isempty(col)) Then
		Exit Function
	End If
	If (col.Count = 0) Then
		Exit Function
	End If
	Set docP = col.GetFirstDocument
	
	StageID = docP.UniversalID
	
	
	Set ViewLinkByEndID = db.GetView("DWFLinkByStageIDEnd")
	If (ViewLinkByEndID Is Nothing) Then
		Msgbox {Сбой: Не найдено представление "DWFLinkByStageIDEnd"}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	Call ViewLinkByEndID.Refresh
	ViewLinkByEndID.AutoUpdate = False
	
	Set colLink = ViewLinkByEndID.GetAllDocumentsByKey(StageID)
	If (colLink.Count = 0) Then
		Msgbox {Ошибка в процессе (Для документа с описанием "} & docMain.StageName(0) & {" не найдено <post> связей)}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	If (colLink.Count = 1) Then
		Set docLink = colLink.GetFirstDocument
		
		If (Messagebox(_
		{Количество <post> связей: 1} & Chr(13) &_
		{Наименование связи: } & Cstr(docLink.Name(0)) & Chr(13) &_
		{Наименование след. стадии: } & Cstr(docLink.ENDSTAGENAME(0)) & Chr(13) &_
		{Продолжить?}, 32+4+256, {Внимание!} ) = 7) Then 'No
			Exit Function
		End If
		
		DWFAAdminGetProcessStagePostLink = 1
		Exit Function
	End If
	
	Redim v(0) As String
	Set docLink = colLink.GetFirstDocument
	While (Not (docLink Is Nothing))
		If (v(0) <> "") Then
			Redim Preserve v(Ubound(v)+1) As String
		End If
		
		v(Ubound(v)) = Cstr(Ubound(v)+1) & {. } & docLink.ENDSTAGENAME(0)
		If (Lcase(docLink.Type(0)) = Lcase("absolute")) Then
			v(Ubound(v)) = v(Ubound(v)) & { (связь "Безусловная")}
		Else
			v(Ubound(v)) = v(Ubound(v)) & { (связь "Условная")}
		End If
		v(Ubound(v)) = v(Ubound(v)) & {|} & docLink.UniversalID
		Set docLink = colLink.GetNextDocument(docLink)
	Wend
	If (v(0) = "") Then
		Msgbox {Ошибка: Пустой список связей}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	Set docTemp = db.CreateDocument
	docTemp.Members = v
	docTemp.Promt = "Выбеите следующую стадию"
	
	If Not (ws.DialogBox("DWF104", True, True, False, False, False, False, db.Title, docTemp, True, False, True)) Then
		DWFAAdminGetProcessStagePostLink = 0
		Exit Function
	End If
	If (docTemp.List(0) = "") Then
		DWFAAdminGetProcessStagePostLink = 0
		Exit Function
	End If
	
	On Error 4091 Resume Next 'bad unid
	Set docLink = db.GetDocumentByUNID(docTemp.List(0))
	If (docLink Is Nothing) Then
		Msgbox {Не найден документ Связи}, 16, ERR_MSG_TITLE
		Exit Function
	End If
	
	
	DWFAAdminGetProcessStagePostLink = 1
	
	Exit Function
errh:
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAAdminGetProcessStagePostLink) "DWFAppLib"}
	Resume endh
endh:
End Function










'++LotusScript Development Environment:2:1:DWFARespDocAdd:1:8
Function DWFARespDocAdd(docMain As NotesDocument, docAddDoc As NotesDocument) As Integer
	On Error Goto errh
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim AccessID As String
	Dim v As Variant
	Dim docMail As NotesDocument
	
	
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFARespDocAdd = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFARespDocAdd = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFARespDocAdd = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocAdd = 0
		Exit Function	
	End If
	
	'получение должности пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocAdd = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocAdd = 0
		Exit Function	
	End If
	
	Set Position = Person.GetUserPosition(ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocAdd = 0
		Exit Function	
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageExecutor", {Добавить отзыв}, AccessID) <> 1) Then
		DWFARespDocAdd = 0
		Exit Function
	End If
	Set TaskInitObj = ODStoreUI.GetObjByValue(AccessID, ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFARespDocAdd = 0
		Exit Function	
	End If
	If (TaskInitObj Is Nothing) Then
		Exit Function
	End If
	
	
	
	Dim docStage As NotesDocument
	Dim addDocStoreUI As AdditionalDocumentStoreUI
	Dim AddDocID As String
	Dim ParentID As String
	
	On Error 4091 Resume Next 'bad unid
	Set docStage = db.GetDocumentByUNID(docMain.StageID(0))
	On Error Goto errh
	If (docStage Is Nothing) Then
		Msgbox {Не найден документ стадии (docStage Is Nothing)}, 48, ERR_MSG_TITLE
		DWFARespDocAdd = 0
		Exit Function	
	End If
	
	Set addDocStoreUI = New AdditionalDocumentStoreUI(docMain, "RespDoc", docStage)
	If (addDocStoreUI.GetResponseDocumentID(Position.ObjAccess, ParentID, AddDocID, ErrorStr) <>1 ) Then
		If (ErrorStr <> "") Then
			Msgbox ErrorStr, 48, ERR_MSG_TITLE
		End If
		DWFARespDocAdd = 0
		Exit Function
	End If
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 			= "Task"
	docMail.Action 		= "AddDocAdd"
	docMail.InitServer 		= db.Server
	docMail.AppPath 		= db.FilePath
	docMail.ProcessID 		= docMain.GetItemValue("PROCESSID")(0)
	docMail.docMainID 		= docMain.UniversalID
	docMail.UserName 		= session.UserName
	docMail.UserPosID 		= Position.ObjAccess 
	docMail.AddAsObjID 		= TaskInitObj.ObjAccess 
	docMail.AddDocID		= AddDocID
	docMail.ParentID		= ParentID
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFARespDocAdd = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFARespDocAdd = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	On Error 4091 Resume Next 'bad unid
	Set docAddDoc = db.GetDocumentByUNID(docMail.docAddDocUNID(0))
	If (docAddDoc Is Nothing) Then
		DWFARespDocAdd = 0
		Msgbox {Ошибка при попытке создать дополнительный документ: docAddDoc Is Nothing}, 48, ERR_MSG_TITLE
		Exit Function	
	End If
	
	
	
	
	
	
	
	
	
	DWFARespDocAdd = 1
	
	
	Exit Function
errh:
	DWFARespDocAdd = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFARespDocAdd) "DWFAppLib"}
	Resume endh
endh:
End Function

'++LotusScript Development Environment:2:1:DWFAAddActionsPre:7:8
'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
%REM
	Function DWFAAddActionsPre
	Description: выполняет на клиенте доп.действия "перед стадией"
	Returns: Variant
%END REM
Public Function DWFAAddActionsPre(docMain As NotesDocument, errString As String)As Integer
	On Error GoTo error_point
	
	If(UCase$(docMain.Getitemvalue("StatusState")(0)) = "COMPLETE")Then 
		DWFAAddActionsPre = 1
		Exit Function
	End If
	
	Dim stageId As String
	Dim stageDoc As NotesDocument
	
	Dim actionStore As AdditionActionStore
	
	stageId = docMain.Getitemvalue("StageId")(0)
	Set stageDoc = docMain.Parentdatabase.Getdocumentbyunid(stageId)
	
	Set actionStore = New AdditionActionStore()
	If(actionStore.Init(stageDoc, errString) <> 1)Then
		Exit Function
	End If
	If(errString <> "")Then
		Exit Function
	End If
	
	DWFAAddActionsPre = actionStore.SetAddAction(docMain, "pre", errString)
	

	Exit Function
	
error_point:
	Error Err, GetThreadInfo(1) & " ( nm: " & Err & ", ln: " & Erl & " ) >> " & Error$		

End Function



'++LotusScript Development Environment:2:1:DWFAClaim:1:8
Function DWFAClaim(docMain As NotesDocument) As Integer
	On Error Goto errh
	
	Dim ws As New NotesUIWorkspace
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim dbPC As NotesDatabase
	Dim ODStoreUI As ODStoreUI
	Dim ODObj As ODObj
	Dim Person As New Person
	Dim Position As ODObj
	Dim TaskInitObj As ODObj
	Dim ErrorStr As String
	
	Dim v As Variant
	Dim AccessID As String
	Dim docMail As NotesDocument
	
	If (Lcase(docMain.GetItemValue("StatusState")(0)) = Lcase("Claim")) Then
		DWFAClaim = 0
		Msgbox {Документ занят др. пользователем.}, 48, ERR_MSG_TITLE
		Exit Function
	End If
	
	Set db = docMain.ParentDatabase
	
	v = docMain.dbPCPath(0)
	If (v = "") Then
		Msgbox {В документе не задан Центр Обработки}, 48, ERR_MSG_TITLE
		DWFAClaim = 0
		Exit Function	
	End If
	If (DWFSGetDatebase(Cstr(v), dbPC) <> 1)Then
		Msgbox {Не найдена база Центра Обработки}, 48, ERR_MSG_TITLE
		DWFAClaim = 0
		Exit Function	
	End If
	v = docMain.dbODPath(0)
	If (v = "") Then
		Msgbox {В документе не задана Орг. директория}, 48, ERR_MSG_TITLE
		DWFAClaim = 0
		Exit Function
	End If
	
	Set ODStoreUI = New ODStoreUI(Cstr(v), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAClaim = 0
		Exit Function	
	End If
	
	'получение пользователя
	Set ODObj = ODStoreUI.GetObjByValue(Cstr(session.UserName), ErrorStr)
	If (ErrorStr <> "") Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAClaim = 0
		Exit Function	
	End If
	If (ODObj Is Nothing) Then
		Exit Function
	End If
	If (Person.Init(ODObj.doc, ErrorStr) <> 1) Then
		Msgbox ErrorStr, 48, ERR_MSG_TITLE
		DWFAClaim = 0
		Exit Function	
	End If
		
	'получение объекта инициации запроса
	If (DWFAGetTaskInitObj(docMain, "StageOwner", {"Захват документа"}, AccessID) <> 1) Then
		DWFAClaim = 0
		Exit Function
	End If
	Set TaskInitObj = ODStoreUI.GetObjByValue(AccessID, ErrorStr)
	If (ErrorStr <> "") Then
		MsgBox ErrorStr, 48, ERR_MSG_TITLE
		DWFAClaim = 0
		Exit Function	
	End If
	If (TaskInitObj Is Nothing) Then
		Exit Function
	End If
	
	'получение должности пользователя
	'<patch Получение должности делается по условию. Раньше всегда делался запрос. 2015.02.06. Tambiev>
	If ( TaskInitObj.myType = "User" ) Then
		Set Position = Person
	ElseIf ( TaskInitObj.myType = "Pos" ) Then
		
		Dim TaskInitPos As New PositionObj, TaskInitPosUser As Person
		If ( TaskInitPos.Init(TaskInitObj.doc, ErrorStr) <> 1 ) Then
			MsgBox ErrorStr, 48, ERR_MSG_TITLE
			DWFAClaim = 0
			Exit Function
		End If
		Set TaskInitPosUser = TaskInitPos.person
		If ( Not ( TaskInitPosUser Is Nothing ) ) Then
			If ( TaskInitPosUser.ObjID = Person.ObjID ) Then
				Set Position = TaskInitObj
			Else
				GoTo getUserPos
			End If
		Else
			GoTo getUserPos			
		End If
	Else
getUserPos:
		Set Position = Person.GetUserPosition(ErrorStr)
		If (ErrorStr <> "") Then
			MsgBox ErrorStr, 48, ERR_MSG_TITLE
			DWFAClaim = 0
			Exit Function	
		End If
	End If
	If (Position Is Nothing) Then
		Exit Function
	End If
	'</patch>
	
	
	Set docMail = dbPC.CreateDocument
	docMail.Form 		= "Task"
	docMail.Action 	= "Claim"
	docMail.InitServer 	= db.Server
	docMail.AppPath 	= db.FilePath
	docMail.ProcessID 	= docMain.GetItemValue("PROCESSID")
	docMail.docMainID 	= docMain.UniversalID
	docMail.UserName 	= session.UserName
	docMail.UserPosID 	= Position.ObjAccess
	docMail.ClaimAsObjID = AccessID
	
	
	Call docMail.Save(True, True)
	If (DWFAAskForAction(docMail) <> 1) Then
		DWFAClaim = 0
		Exit Function	
	End If
	
	If (docMail.Error(0) <> "") Then
		DWFAClaim = 0
		Msgbox docMail.Error(0), 48, ERR_MSG_TITLE
'		Call docMail.Remove(True)
		Exit Function	
	End If
	
	On Error 4091 Resume Next 'bad unid
	Set docMain = db.GetDocumentByUNID(docMail.docMainUNID(0))
	If (docMain Is Nothing) Then
		DWFAClaim = 0
		Msgbox {Ошибка при захвате стадии: docMain Is Nothing}, 48, ERR_MSG_TITLE
		Exit Function	
	End If
	
	'Call docMail.Remove(True)
	
	
	
	
	
	DWFAClaim = 1
	
	
	Exit Function
errh:
	DWFAClaim = -1
	Msgbox Error$ & {. Error # } & Cstr(Err) & { on line # } & Cstr(Erl) & { in (DWFAClaim) "DWFAppLib"}
	Resume endh
endh:
End Function













